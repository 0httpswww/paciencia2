<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JoGos Online</title>
    <meta name="description" content="JoGos Online - Arcade, Racing & Learning.">
    <meta name="theme-color" content="#0a0a0a">
    
    <!-- SEGURAN√áA: Content Security Policy (CSP) - Permissive for Ads -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline'; font-src * data: blob: 'unsafe-inline';">

    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://r2.erweima.ai/img/compressed/47748805f42289196b6134a65b3c58e4.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Inter:wght@400;800&display=swap');

        body { 
            overscroll-behavior: none; 
            touch-action: none; 
            -webkit-tap-highlight-color: transparent; 
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: #e2e8f0; 
            user-select: none; 
            -webkit-user-select: none; 
            overflow: hidden;
        }

        /* --- PREMIUM DARK GRID BACKGROUND --- */
        .premium-bg {
            background-color: #050505;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            position: relative;
        }
        
        .premium-bg::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 50%;
            background: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
            pointer-events: none;
        }

        /* --- VIGNETTE & SCANLINES --- */
        .scanlines {
            position: fixed;
            top: 0; left: 0; w-full; h-full;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 5;
            opacity: 0.3;
        }

        /* --- PREMIUM BUTTONS --- */
        .premium-btn {
            position: relative;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .premium-btn:hover {
            transform: translateY(-2px) scale(1.02);
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 
                0 0 20px rgba(255, 255, 255, 0.1),
                inset 0 0 20px rgba(255, 255, 255, 0.05);
            background: rgba(30, 30, 30, 0.9);
        }

        .premium-btn:active {
            transform: translateY(1px) scale(0.98);
        }

        /* White Shine Effect */
        .premium-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .premium-btn:hover::after {
            left: 100%;
        }

        /* --- TYPOGRAPHY & TITLES --- */
        .hero-title {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            background: linear-gradient(180deg, #ffffff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.3));
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* --- UTILS --- */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }

        /* --- GAME SPECIFIC PRESERVED STYLES --- */
        .space-3d { background: radial-gradient(circle at center, #0f172a 0%, #000000 100%); perspective: 1000px; overflow: hidden; }
        .grid-floor { position: absolute; bottom: -50%; left: -50%; width: 200%; height: 100%; background-image: linear-gradient(rgba(56, 189, 248, 0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(56, 189, 248, 0.2) 1px, transparent 1px); background-size: 80px 80px; transform: rotateX(60deg); animation: gridMove 4s linear infinite; z-index: 0; mask-image: linear-gradient(to top, black 0%, transparent 60%); }
        @keyframes gridMove { 0% { transform: rotateX(60deg) translateY(0); } 100% { transform: rotateX(60deg) translateY(80px); } }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        @keyframes swing { 0% { transform: rotate(2deg); } 50% { transform: rotate(-2deg); } 100% { transform: rotate(2deg); } }
        .hangman-swing { transform-origin: 140px 20px; animation: swing 3s infinite ease-in-out; }
        .farm-scene { background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%); }
        .farm-perspective { perspective: 1000px; }
        .farm-grid-3d { transform-style: preserve-3d; transition: transform 0.1s ease-out; }
        .farm-plot { background: #0f172a; box-shadow: inset 0 0 20px #000, 5px 5px 15px rgba(0,0,0,0.5); border: 1px solid rgba(255, 255, 255, 0.1); transform-style: preserve-3d; transition: border-color 0.3s, box-shadow 0.3s; }
        .farm-plot:hover { border-color: rgba(56, 189, 248, 0.5); }
        .farm-plot.ready { border-color: #facc15; box-shadow: 0 0 20px rgba(250, 204, 21, 0.4); }
        @keyframes walker { 0% { transform: translateZ(40px) rotateX(-45deg) rotateY(45deg) translateY(0); } 50% { transform: translateZ(50px) rotateX(-45deg) rotateY(45deg) translateY(-5px); } 100% { transform: translateZ(40px) rotateX(-45deg) rotateY(45deg) translateY(0); } }
        .farmer-anim { animation: walker 1.5s infinite ease-in-out; transform-style: preserve-3d; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5)); }
        .level-up-anim { animation: levelUp 2s ease-out forwards; }
        @keyframes levelUp { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }
        
        /* New Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
        "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
        "@supabase/supabase-js": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"
      }
    }
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful');
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</head>
<body>
    <!-- Monetag Popunder (Zone: 10264533) - ACTIVATED -->
    <script>(function(s){s.dataset.zone='10264533',s.src='https://al5sm.com/tag.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    
    <!-- Monetag Vignette (Zone: 10273879) -->
    <script>(function(s){s.dataset.zone='10273879',s.src='https://gizokraijaw.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>

    <div id="root" class="h-[100dvh] w-full overflow-hidden flex flex-col"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
      import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import { Rocket, ChevronLeft, Sprout, CheckCircle, Maximize, ShoppingCart, Coins, Lock, Check, Brain, RefreshCw, Zap, Download, PlayCircle, ClipboardList, X, PlusCircle, Save, Cloud, LogIn, LogOut, Loader2, Pause, Heart, Skull, Move, HelpCircle, Lightbulb } from 'lucide-react';
      import { createClient } from '@supabase/supabase-js';

      // ==========================================
      // MONETAG ADS CONFIGURATION
      // ==========================================
      const MONETAG_DIRECT_LINK = 'https://al5sm.com/4/10264533'; 

      const triggerAd = (onReward) => {
          // Resume audio context if suspended (requires user gesture)
          const ctx = getAudioContext();
          if (ctx && ctx.state === 'suspended') ctx.resume().catch(() => {});

          playSound('ui_click');
          
          // Open Direct Link
          window.open(MONETAG_DIRECT_LINK, '_blank');
          
          // Simulate ad watch time and grant reward
          setTimeout(() => {
              if (onReward) onReward();
          }, 2000);
      };

      // ==========================================
      // SUPABASE CONFIG
      // ==========================================
      const initSupabase = () => {
          const supabaseUrl = 'https://yscuszxakpepfrxcpnkc.supabase.co';
          const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzY3Vzenhha3BlcGZyeGNwbmtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTIxMDcsImV4cCI6MjA4MDM4ODEwN30.7yB1Y0hyJHJAd9IC-tWbpKLIGv0s1qbn30MTNEygGto';
          
          try {
              if (supabaseUrl && supabaseKey) {
                  return createClient(supabaseUrl, supabaseKey, {
                      auth: { persistSession: true, storageKey: 'galaxy_auth_token' }
                  });
              }
          } catch(e) { console.error("Erro Supabase:", e); }
          return null;
      };

      const supabase = initSupabase();

      const safeStorage = {
          getItem: (key) => { try { return localStorage.getItem(key); } catch(e) { return null; } },
          setItem: (key, value) => { try { localStorage.setItem(key, value); } catch(e) {} }
      };

      let audioContext = null;
      const getAudioContext = () => {
          try {
            if (!audioContext) {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (AudioCtx) audioContext = new AudioCtx();
            }
            return audioContext;
          } catch (e) { return null; }
      };

      // --- SOUND ENGINE ---
      const playSound = (type) => {
          const ctx = getAudioContext();
          if (!ctx) return;
          try {
            if (ctx.state === 'suspended') ctx.resume().catch(() => {});
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            osc.connect(gainNode);
            gainNode.connect(ctx.destination);
            const now = ctx.currentTime;

            switch(type) {
                case 'ui_hover': osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); gainNode.gain.setValueAtTime(0.02, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05); osc.start(now); osc.stop(now + 0.05); break;
                case 'ui_click': osc.type = 'square'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1); gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1); osc.start(now); osc.stop(now + 0.1); break;
                case 'shoot': osc.frequency.setValueAtTime(880, now); osc.frequency.exponentialRampToValueAtTime(110, now + 0.1); gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); break;
                case 'explosion': osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.4); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4); osc.start(now); osc.stop(now + 0.4); break;
                case 'powerup': osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now + 0.1); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(now); osc.stop(now + 0.2); break;
                case 'win': osc.type = 'sine'; osc.frequency.setValueAtTime(500, now); osc.frequency.linearRampToValueAtTime(1000, now + 0.2); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(now); osc.stop(now + 0.2); break;
                case 'lose': osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(now); osc.stop(now + 0.2); break;
                case 'levelup': osc.type = 'square'; osc.frequency.setValueAtTime(440, now); osc.frequency.linearRampToValueAtTime(880, now + 0.2); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(now); osc.stop(now + 0.5); break;
                case 'boss_hit': osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); break;
                case 'buy': osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(1200, now + 0.1); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1); break;
                // --- NEW SOUND EFFECTS ---
                case 'plant': // Digging sound
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(40, now + 0.15);
                    gainNode.gain.setValueAtTime(0.15, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.15);
                    osc.start(now); osc.stop(now + 0.15);
                    break;
                case 'harvest': // High pitched success
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(1400, now + 0.1);
                    gainNode.gain.setValueAtTime(0.05, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                    break;
            }
          } catch(e) {}
      };

      const toggleFullScreen = (e) => {
        if (e) e.stopPropagation();
        playSound('ui_click');
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(err => console.log(err));
        } else if (document.exitFullscreen) document.exitFullscreen();
      };

      // --- Install Button ---
      const InstallButton = () => {
          const [deferredPrompt, setDeferredPrompt] = useState(null);
          const [showIOS, setShowIOS] = useState(false);
          const [isIOS, setIsIOS] = useState(false);
          const [isStandalone, setIsStandalone] = useState(false);

          useEffect(() => {
              setIsStandalone(window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone);
              setIsIOS(/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream);
              const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); };
              window.addEventListener('beforeinstallprompt', handler);
              return () => window.removeEventListener('beforeinstallprompt', handler);
          }, []);

          const handleInstall = async () => {
              playSound('ui_click');
              if (deferredPrompt) {
                  deferredPrompt.prompt();
                  const { outcome } = await deferredPrompt.userChoice;
                  if (outcome === 'accepted') setDeferredPrompt(null);
              } else if (isIOS) setShowIOS(true);
          };

          if (isStandalone || (!deferredPrompt && !isIOS)) return null; 

          return (
              <>
                  <button onClick={handleInstall} className="absolute top-4 left-4 p-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-full shadow-lg animate-pulse flex items-center gap-2 text-xs font-bold z-50 border border-white/20">
                      <Download size={16} /> APP
                  </button>
                  {showIOS && (
                      <div className="fixed inset-0 bg-black/90 z-[60] flex flex-col items-center justify-center p-6 text-center" onClick={() => setShowIOS(false)}>
                          <div className="bg-slate-900 p-6 rounded-xl border border-white/20 max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}>
                              <div className="flex justify-center mb-4 text-purple-400"><Download size={48} /></div>
                              <h3 className="text-xl font-bold text-white mb-4">Instalar no iOS</h3>
                              <p className="text-gray-300 mb-6 text-sm">Toque em Compartilhar e depois em Adicionar √† Tela de In√≠cio.</p>
                              <button onClick={() => setShowIOS(false)} className="mt-6 w-full py-3 bg-purple-600 rounded-lg font-bold text-white">ENTENDI</button>
                          </div>
                      </div>
                  )}
              </>
          );
      };

      // --- Reusable Components ---
      const Modal = ({ title, onClose, children }) => (
          <div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm" onClick={(e) => { if(e.target === e.currentTarget) onClose(); }}>
              <div className="bg-[#0f0f0f] w-full max-w-sm rounded-2xl border border-white/10 shadow-[0_0_30px_rgba(255,255,255,0.05)] overflow-hidden flex flex-col max-h-[80%] relative">
                  <div className="p-4 border-b border-white/10 flex justify-between items-center bg-[#151515]">
                      <h2 className="text-xl font-bold text-white hero-title">{title}</h2>
                      <button onClick={() => { playSound('ui_click'); onClose(); }}><X className="text-gray-400 hover:text-white" /></button>
                  </div>
                  <div className="p-4 overflow-y-auto flex-1 z-10 scrollbar-hide">{children}</div>
              </div>
          </div>
      );

      // --- AUTH MODAL ---
      const AuthModal = ({ onClose, onLogin }) => {
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [isSignUp, setIsSignUp] = useState(false);
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState(null);

          const handleSubmit = async (e) => {
              e.preventDefault();
              playSound('ui_click');
              setLoading(true);
              setError(null);
              
              if (!supabase) { setError("Erro de conex√£o."); setLoading(false); return; }

              try {
                  let result;
                  if (isSignUp) result = await supabase.auth.signUp({ email, password });
                  else result = await supabase.auth.signInWithPassword({ email, password });
                  
                  if (result.error) throw result.error;
                  if (result.data.user) { onLogin(result.data.user); onClose(); }
              } catch (err) { setError(err.message || "Erro de autentica√ß√£o"); } finally { setLoading(false); }
          };

          return (
              <Modal title={isSignUp ? "CRIAR CONTA" : "LOGIN"} onClose={onClose}>
                  <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                      {error && <div className="bg-red-500/20 text-red-400 p-2 rounded text-xs border border-red-500/30">{error}</div>}
                      <div>
                          <label className="text-xs text-gray-500 font-bold ml-1 uppercase">Email</label>
                          <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-[#050505] border border-white/10 rounded p-3 text-white focus:border-white/50 outline-none transition" placeholder="seu@email.com" required />
                      </div>
                      <div>
                          <label className="text-xs text-gray-500 font-bold ml-1 uppercase">Senha</label>
                          <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-[#050505] border border-white/10 rounded p-3 text-white focus:border-white/50 outline-none transition" placeholder="******" required />
                      </div>
                      <button type="submit" disabled={loading} className="premium-btn w-full py-3 rounded mt-2 flex justify-center font-bold tracking-wider">
                          {loading ? <Loader2 className="animate-spin" /> : (isSignUp ? "REGISTRAR" : "ENTRAR")}
                      </button>
                      <div className="text-center text-xs text-gray-500 mt-4">
                          <button type="button" onClick={() => { playSound('ui_click'); setIsSignUp(!isSignUp); }} className="text-white hover:text-gray-300 font-bold underline">
                              {isSignUp ? "J√° tenho conta" : "Criar nova conta"}
                          </button>
                      </div>
                  </form>
              </Modal>
          );
      };

      // --- GAME 1: GALAXY INVADER 3D ---
      const SHIPS = [
          { id: 'starter', name: 'Prototype', adCost: 0, palette: { main: '#64748b', dark: '#334155', light: '#94a3b8', cockpit: '#0ea5e9', engine: '#f59e0b' } },
          { id: 'blue', name: 'Interceptor', adCost: 5, palette: { main: '#3b82f6', dark: '#1e3a8a', light: '#60a5fa', cockpit: '#06b6d4', engine: '#3b82f6' } },
          { id: 'purple', name: 'Void Walker', adCost: 10, palette: { main: '#7c3aed', dark: '#4c1d95', light: '#8b5cf6', cockpit: '#22d3ee', engine: '#d946ef' } },
          { id: 'green', name: 'Venom Striker', adCost: 15, palette: { main: '#22c55e', dark: '#14532d', light: '#4ade80', cockpit: '#facc15', engine: '#84cc16' } },
          { id: 'yellow', name: 'Solar Flare', adCost: 20, palette: { main: '#f97316', dark: '#9a3412', light: '#fbbf24', cockpit: '#38bdf8', engine: '#ef4444' } },
          { id: 'red', name: 'Crimson Fury', adCost: 25, palette: { main: '#ef4444', dark: '#7f1d1d', light: '#f87171', cockpit: '#10b981', engine: '#f59e0b' } },
          { id: 'legendary', name: 'Abyssal King', adCost: 30, palette: { main: '#172554', dark: '#020617', light: '#2563eb', cockpit: '#00ffff', engine: '#00ffff' } },
      ];
      
      const generatePlayerSprite = (palette) => {
          const canvas = document.createElement('canvas');
          const size = 32; canvas.width = size; canvas.height = size;
          const ctx = canvas.getContext('2d');
          const P = palette.main; const D = palette.dark; const L = palette.light;
          const C = palette.cockpit; const W = '#ffffff'; const B = palette.engine;
          const pixelSize = 2;
          const grid = ["      11      ", "     1221     ", "     1441     ", "    124521    ", "    124421    ", "   12233221   ", "   12233221   ", "  1222222221  ", "  1222222221  ", " 122114411221 ", " 121124421121 ", " 121222222121 ", "12212222221221", "12211666611221", "111 116611 111", "     1111     "];
          const colorMap = { '1': D, '2': P, '3': L, '4': C, '5': W, '6': B };
          for(let y=0; y<grid.length; y++) { for(let x=0; x<grid[y].length; x++) { const char = grid[y][x]; if(colorMap[char]) { ctx.fillStyle = colorMap[char]; ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize); } } }
          const img = new Image(); img.src = canvas.toDataURL(); return img;
      };

      const GalaxyInvader = ({ onBack, equippedShipId, addCoins, currentCoins }) => {
          const canvasRef = useRef(null);
          const [gameState, setGameState] = useState('playing'); 
          const [stats, setStats] = useState({ score: 0, wave: 1, xp: 0, level: 1, hp: 100 });
          const [shake, setShake] = useState(false);
          const gameStateRef = useRef(gameState); gameStateRef.current = gameState;

          const triggerShake = () => { setShake(true); setTimeout(() => setShake(false), 500); };
          
          const handleRespawn = () => { 
              triggerAd(() => {
                setStats(prev => ({ ...prev, hp: 100 })); 
                setGameState('playing'); 
                playSound('powerup');
              });
          };
          
          useEffect(() => {
              const canvas = canvasRef.current; const ctx = canvas.getContext('2d');
              let animationFrameId; let lastTime = 0;
              const shipDef = SHIPS.find(s => s.id === equippedShipId) || SHIPS[0];
              const playerImg = generatePlayerSprite(shipDef.palette);
              const PLAYER_SPEED = 6;
              let player = { x: canvas.width/2, y: canvas.height - 100, vx: 0, width: 40, height: 40, hp: 100, weaponLevel: 1, lastShot: 0, score: 0, level: 1, xp: 0 };
              let bullets = [], enemies = [], particles = [], powerups = [], boss = null;
              let input = { x: null, y: null, active: false };
              const getScale = (y) => 0.6 + (y / canvas.height) * 0.4;
              
              const spawnEnemy = (isBoss = false) => {
                  if (boss && !isBoss) return;
                  const typeRoll = Math.random(); const startX = Math.random() * (canvas.width - 60) + 30;
                  let enemy = { x: startX, y: -50, z: 0, width: 40, height: 40, hp: 2 + player.level, type: 'drone', vy: 3 + Math.random(), vx: Math.sin(Date.now()/500), color: '#ef4444' };
                  if (stats.wave > 2 && typeRoll > 0.7) enemy = { ...enemy, type: 'interceptor', hp: 5, vy: 5, color: '#f59e0b', width: 30 };
                  if (stats.wave > 4 && typeRoll > 0.9) enemy = { ...enemy, type: 'tank', hp: 20, vy: 1, width: 60, height: 60, color: '#3b82f6' };
                  enemies.push(enemy);
              };
              const spawnBoss = () => { boss = { x: canvas.width/2, y: -100, width: 120, height: 100, hp: 100 * stats.wave, maxHp: 100 * stats.wave, phase: 'enter', vx: 2, vy: 1 }; playSound('levelup'); };

              const update = (time) => {
                  if (gameStateRef.current !== 'playing') { animationFrameId = requestAnimationFrame(() => update(Date.now())); return; }
                  const dt = time - lastTime; lastTime = time;
                  if (input.active) {
                      const dx = input.x - player.x; const dy = input.y - player.y; const dist = Math.sqrt(dx*dx + dy*dy);
                      if (dist > 5) { player.vx = (dx / dist) * PLAYER_SPEED; player.x += player.vx; player.y += (dy / dist) * PLAYER_SPEED; } else { player.vx *= 0.8; }
                  } else { player.vx *= 0.8; }
                  player.x = Math.max(20, Math.min(canvas.width - 20, player.x)); player.y = Math.max(50, Math.min(canvas.height - 20, player.y));

                  if (time - player.lastShot > 250 - (player.weaponLevel * 20)) {
                      const scale = getScale(player.y); const bSpeed = -10 * scale;
                      bullets.push({ x: player.x, y: player.y - 20, vy: bSpeed, vx: 0, type: 'player', width: 4*scale, height: 10*scale, color: '#38bdf8' });
                      if (player.weaponLevel >= 2) { bullets.push({ x: player.x - 10, y: player.y, vy: bSpeed * 0.9, vx: -1, type: 'player', width: 3*scale, height: 8*scale, color: '#38bdf8' }); bullets.push({ x: player.x + 10, y: player.y, vy: bSpeed * 0.9, vx: 1, type: 'player', width: 3*scale, height: 8*scale, color: '#38bdf8' }); }
                      playSound('shoot'); player.lastShot = time;
                  }

                  if (Math.random() < 0.02 + (stats.wave * 0.005) && !boss) spawnEnemy();
                  if (player.score > stats.wave * 2500 && !boss) spawnBoss();

                  for (let i = bullets.length - 1; i >= 0; i--) { let b = bullets[i]; b.y += b.vy; b.x += b.vx; if (b.y < -50 || b.y > canvas.height + 50) bullets.splice(i, 1); }

                  for (let i = enemies.length - 1; i >= 0; i--) {
                      let e = enemies[i]; const scale = getScale(e.y);
                      e.y += e.vy * scale; e.x += e.vx * scale; e.renderW = e.width * scale; e.renderH = e.height * scale;
                      if (Math.random() < 0.01 * stats.wave) bullets.push({ x: e.x, y: e.y + e.renderH/2, vy: 5*scale, vx: 0, type: 'enemy', width: 6*scale, height: 6*scale, color: 'red' });
                      for (let j = bullets.length - 1; j >= 0; j--) {
                          let b = bullets[j];
                          if (b.type === 'player' && Math.abs(b.x - e.x) < e.renderW/2 + 10 && Math.abs(b.y - e.y) < e.renderH/2 + 10) {
                              e.hp -= 1; bullets.splice(j, 1); for(let k=0; k<3; k++) particles.push({ x: b.x, y: b.y, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5, life: 10, color: 'yellow' });
                              if (e.hp <= 0) { enemies.splice(i, 1); player.score += (e.type === 'tank' ? 50 : 10); player.xp += (e.type === 'tank' ? 20 : 5); addCoins(1); playSound('explosion'); triggerShake(); for(let k=0; k<10; k++) particles.push({ x: e.x, y: e.y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, life: 20, color: e.color }); if (Math.random() < 0.1) powerups.push({ x: e.x, y: e.y, type: 'weapon_up' }); break; }
                          }
                      }
                      if (Math.abs(e.x - player.x) < (e.renderW + player.width)/2 && Math.abs(e.y - player.y) < (e.renderH + player.height)/2) { enemies.splice(i, 1); player.hp -= 20; triggerShake(); playSound('explosion'); }
                      if (e.y > canvas.height + 50) enemies.splice(i, 1);
                  }

                  if (boss) {
                      const scale = getScale(boss.y); boss.renderW = boss.width * scale; boss.renderH = boss.height * scale;
                      if (boss.phase === 'enter') { boss.y += 1; if (boss.y > 100) boss.phase = 'attack'; } 
                      else { boss.x += boss.vx; if (boss.x > canvas.width - 50 || boss.x < 50) boss.vx *= -1; if (Math.random() < 0.05) { const angle = Math.atan2(player.y - boss.y, player.x - boss.x); bullets.push({ x: boss.x, y: boss.y + 40, vy: Math.sin(angle)*6, vx: Math.cos(angle)*6, type: 'enemy', width: 8, height: 8, color: '#f0f' }); } }
                      for (let j = bullets.length - 1; j >= 0; j--) { let b = bullets[j]; if (b.type === 'player' && Math.abs(b.x - boss.x) < boss.renderW/2 && Math.abs(b.y - boss.y) < boss.renderH/2) { boss.hp--; bullets.splice(j, 1); playSound('boss_hit'); if (boss.hp <= 0) { boss = null; player.score += 1000; player.xp += 200; addCoins(50); setStats(s => ({ ...s, wave: s.wave + 1 })); playSound('win'); triggerShake(); for(let k=0; k<50; k++) particles.push({ x: b.x, y: b.y, vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15, life: 40, color: 'purple' }); } } }
                  }

                  for (let i = powerups.length - 1; i >= 0; i--) { let p = powerups[i]; p.y += 2; if (Math.abs(p.x - player.x) < 30 && Math.abs(p.y - player.y) < 30) { player.weaponLevel = Math.min(3, player.weaponLevel + 1); player.hp = Math.min(100, player.hp + 20); powerups.splice(i, 1); playSound('powerup'); } }
                  for (let i = bullets.length - 1; i >= 0; i--) { let b = bullets[i]; if (b.type === 'enemy' && Math.abs(b.x - player.x) < player.width/2 && Math.abs(b.y - player.y) < player.height/2) { player.hp -= 10; bullets.splice(i, 1); triggerShake(); playSound('explosion'); } }

                  if (player.xp >= player.level * 100) { player.xp -= player.level * 100; player.level++; playSound('levelup'); }
                  if (time % 60 === 0) { setStats({ score: player.score, hp: player.hp, wave: stats.wave, level: player.level, xp: player.xp }); }
                  if (player.hp <= 0) { setGameState('gameover'); }

                  ctx.clearRect(0, 0, canvas.width, canvas.height);
                  for (let i = particles.length - 1; i >= 0; i--) { let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life--; ctx.fillStyle = p.color; ctx.globalAlpha = p.life / 20; ctx.fillRect(p.x, p.y, 4, 4); if (p.life <= 0) particles.splice(i, 1); } ctx.globalAlpha = 1;

                  const pScale = getScale(player.y);
                  ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.ellipse(player.x, player.y + 30*pScale, 15*pScale, 5*pScale, 0, 0, Math.PI*2); ctx.fill();
                  ctx.save(); ctx.translate(player.x, player.y); ctx.scale(pScale, pScale); ctx.rotate(player.vx * 0.05); if (playerImg.complete) ctx.drawImage(playerImg, -20, -20, 40, 40); ctx.restore();

                  enemies.forEach(e => { ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.ellipse(e.x, e.y + e.renderH, e.renderW/3, e.renderH/5, 0, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = e.color; ctx.shadowBlur = 10; ctx.shadowColor = e.color; ctx.fillRect(e.x - e.renderW/2, e.y - e.renderH/2, e.renderW, e.renderH); ctx.shadowBlur = 0; ctx.fillStyle = 'red'; ctx.fillRect(e.x - e.renderW/2, e.y - e.renderH/2 - 5, e.renderW, 3); ctx.fillStyle = 'lime'; ctx.fillRect(e.x - e.renderW/2, e.y - e.renderH/2 - 5, e.renderW * (e.hp / (2+player.level)), 3); });
                  if (boss) { ctx.fillStyle = 'rgba(128,0,128,0.8)'; ctx.beginPath(); ctx.moveTo(boss.x, boss.y - boss.renderH/2); ctx.lineTo(boss.x + boss.renderW/2, boss.y + boss.renderH/2); ctx.lineTo(boss.x - boss.renderW/2, boss.y + boss.renderH/2); ctx.fill(); ctx.fillStyle = 'gray'; ctx.fillRect(boss.x - 50, boss.y - 70, 100, 8); ctx.fillStyle = '#d946ef'; ctx.fillRect(boss.x - 50, boss.y - 70, 100 * (boss.hp / boss.maxHp), 8); ctx.strokeStyle = 'white'; ctx.strokeRect(boss.x - 50, boss.y - 70, 100, 8); }
                  bullets.forEach(b => { ctx.fillStyle = b.color; ctx.shadowBlur = 5; ctx.shadowColor = b.color; ctx.fillRect(b.x - b.width/2, b.y - b.height/2, b.width, b.height); ctx.shadowBlur = 0; });
                  powerups.forEach(p => { ctx.fillStyle = '#0ff'; ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke(); });

                  if (gameStateRef.current === 'playing') animationFrameId = requestAnimationFrame(() => update(Date.now()));
              };

              const handleResize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }; window.addEventListener('resize', handleResize); handleResize(); update(Date.now());
              const onTouchMove = (e) => { e.preventDefault(); input = { x: e.touches[0].clientX, y: e.touches[0].clientY, active: true }; };
              const onMouseMove = (e) => { input = { x: e.clientX, y: e.clientY, active: true }; };
              const onEnd = () => { input.active = false; };
              canvas.addEventListener('touchmove', onTouchMove, { passive: false }); canvas.addEventListener('touchend', onEnd); canvas.addEventListener('mousemove', onMouseMove); canvas.addEventListener('mouseup', onEnd);
              return () => { window.removeEventListener('resize', handleResize); cancelAnimationFrame(animationFrameId); canvas.removeEventListener('touchmove', onTouchMove); };
          }, [equippedShipId, gameState]);

          return (
              <div className={`relative w-full h-full space-3d ${shake ? 'shake' : ''}`}>
                  <div className="grid-floor"></div>
                  <canvas ref={canvasRef} className="block w-full h-full relative z-10" />
                  <div className="absolute top-0 w-full p-4 flex justify-between items-start z-20 pointer-events-none">
                      <div className="flex flex-col gap-1">
                          <div className="text-sm font-bold text-cyan-400 drop-shadow">SCORE: {stats.score}</div>
                          <div className="flex items-center gap-1"><Heart size={16} className="text-green-400" /><div className="w-32 h-3 bg-gray-800 rounded border border-gray-600"><div className={`h-full transition-all ${stats.hp > 30 ? 'bg-green-500' : 'bg-red-500'}`} style={{ width: `${Math.max(0, stats.hp)}%` }}></div></div></div>
                      </div>
                      <div className="flex flex-col items-end gap-1">
                          <button onClick={() => { playSound('ui_click'); setGameState(g => g === 'paused' ? 'playing' : 'paused'); }} className="pointer-events-auto p-2 bg-white/10 rounded-full mb-2"><Pause size={20} /></button>
                          <div className="text-xs font-bold text-purple-400">WAVE {stats.wave}</div>
                          <div className="text-xs font-bold text-yellow-400">LVL {stats.level}</div>
                          <div className="w-24 h-1 bg-gray-800 rounded"><div className="h-full bg-yellow-400" style={{ width: `${Math.min(100, (stats.xp / (stats.level*100))*100)}%` }}></div></div>
                      </div>
                  </div>
                  {gameState === 'paused' && (
                      <div className="absolute inset-0 bg-black/60 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
                          <h2 className="text-4xl font-bold text-white mb-6 tracking-widest">PAUSED</h2>
                          <button onClick={() => { playSound('ui_click'); setGameState('playing'); }} className="px-8 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-bold mb-4 w-48">RESUME</button>
                          <button onClick={() => { playSound('ui_click'); onBack(); }} className="px-8 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-bold w-48">EXIT</button>
                      </div>
                  )}
                  {gameState === 'gameover' && (
                      <div className="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center animate-fade-in">
                          <Skull size={64} className="text-red-500 mb-4 animate-pulse" />
                          <h2 className="text-5xl font-bold text-red-500 mb-2 neon-title">MISSION FAILED</h2>
                          <div className="text-2xl text-white mb-8">Final Score: <span className="text-yellow-400">{stats.score}</span></div>
                          <div className="flex flex-col gap-4 w-64">
                              <button onClick={() => { playSound('ui_click'); handleRespawn(); }} className="w-full py-4 bg-green-600 hover:bg-green-500 rounded-xl font-bold text-white flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(34,197,94,0.4)] transition-transform hover:scale-105"><PlayCircle size={24} /> REVIVE (AD)</button>
                              <button onClick={() => { playSound('ui_click'); setStats({ score: 0, wave: 1, xp: 0, level: 1, hp: 100 }); setGameState('playing'); }} className="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-white flex items-center justify-center gap-2"><RefreshCw size={20} /> RESTART MISSION</button>
                              <button onClick={() => { playSound('ui_click'); onBack(); }} className="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-gray-300">RETURN TO BASE</button>
                          </div>
                      </div>
                  )}
              </div>
          );
      };

      const GalaxyMenu = ({ onStart, onShop, onBack, coins }) => (
          <div className="w-full h-full flex flex-col items-center justify-center relative premium-bg">
               <div className="scanlines"></div>
               <div className="z-10 flex flex-col items-center gap-8 w-full max-w-md px-4 animate-fade-in">
                   <div className="relative">
                      <Rocket size={100} className="text-blue-500 drop-shadow-[0_0_30px_rgba(59,130,246,0.8)]" />
                      <div className="absolute -inset-8 bg-blue-500/20 blur-2xl rounded-full"></div>
                   </div>
                   <h1 className="text-5xl md:text-6xl font-bold text-center hero-title leading-tight">GALAXY<br/><span className="text-blue-400">INVADER</span></h1>
                   <div className="flex items-center gap-3 bg-black/60 px-6 py-3 rounded-full border border-yellow-500/30 shadow-[0_0_20px_rgba(234,179,8,0.1)]">
                        <Coins size={24} className="text-yellow-400 drop-shadow-[0_0_10px_gold]" />
                        <span className="font-bold text-2xl text-yellow-400 tracking-wider">{coins}</span>
                   </div>
                   <div className="w-full grid gap-6 mt-8">
                       <button onClick={() => { playSound('ui_click'); onStart(); }} onMouseEnter={() => playSound('ui_hover')} className="premium-btn w-full h-24 rounded-2xl flex items-center justify-center gap-4 text-2xl font-bold tracking-widest group">
                            <span className="group-hover:text-blue-400 transition-colors">START MISSION</span>
                            <ChevronLeft className="rotate-180 group-hover:translate-x-2 transition-transform" size={28} />
                       </button>
                       <button onClick={() => { playSound('ui_click'); onShop(); }} onMouseEnter={() => playSound('ui_hover')} className="premium-btn w-full h-20 rounded-2xl flex items-center justify-center gap-4 text-xl font-bold tracking-wider text-yellow-400 group">
                            <ShoppingCart size={24} />
                            <span>HANGAR SHOP</span>
                       </button>
                   </div>
                   <button onClick={() => { playSound('ui_click'); onBack(); }} className="mt-8 flex items-center gap-2 text-gray-400 hover:text-white transition uppercase text-sm font-bold tracking-widest px-6 py-3 hover:bg-white/5 rounded-full border border-transparent hover:border-white/10"><ChevronLeft size={16} /> Back to Hub</button>
               </div>
               <button onClick={toggleFullScreen} className="absolute top-6 right-6 p-3 bg-white/10 hover:bg-white/20 rounded-full transition text-gray-400 hover:text-white"><Maximize size={24}/></button>
          </div>
      );

      // --- COMPONENT: Shop Screen ---
      const ShopScreen = ({ adProgress, handleShipAdWatch, equipShip, unlockedShips, equippedShip, onBack }) => {
          const ShipCard = ({ ship }) => {
              const isUnlocked = unlockedShips.includes(ship.id);
              const isEquipped = equippedShip === ship.id;
              const spriteUrl = useMemo(() => generatePlayerSprite(ship.palette).src, [ship]);
              const currentAds = adProgress[ship.id] || 0;
              const reqAds = ship.adCost;

              const handleAction = () => {
                  if (isUnlocked) {
                      equipShip(ship.id);
                      playSound('powerup');
                  } else {
                      // Trigger Direct Link via click and give reward
                      triggerAd(() => {
                          handleShipAdWatch(ship.id, reqAds);
                          playSound('buy');
                      });
                  }
              };

              return (
                  <div className={`premium-btn relative rounded-xl p-4 flex flex-col items-center gap-3 transition-transform ${isEquipped ? 'border-green-500 border-2 shadow-[0_0_15px_rgba(34,197,94,0.5)]' : ''}`}>
                      <div className="text-sm font-bold text-gray-300">{ship.name}</div>
                      <div className="w-16 h-16 bg-black/50 rounded-lg flex items-center justify-center relative overflow-hidden">
                           <img src={spriteUrl} className="w-12 h-12 rendering-pixelated" alt={ship.name} />
                           {!isUnlocked && (
                               <div className="absolute inset-0 bg-black/60 flex items-center justify-center">
                                   <Lock size={20} className="text-gray-400" />
                               </div>
                           )}
                      </div>
                      
                      {isUnlocked ? (
                          <button 
                              onClick={handleAction}
                              disabled={isEquipped}
                              className={`w-full py-2 rounded font-bold text-xs flex items-center justify-center gap-1
                                  ${isEquipped ? 'bg-green-600/50 text-white cursor-default' : 'bg-blue-600 hover:bg-blue-500 text-white'}`}
                          >
                              {isEquipped ? <><Check size={12} /> EQUIPPED</> : 'SELECT'}
                          </button>
                      ) : (
                          <div className="w-full flex flex-col gap-1">
                              <button 
                                  onClick={handleAction}
                                  className={`w-full py-2 rounded font-bold text-xs flex items-center justify-center gap-1 bg-yellow-600 hover:bg-yellow-500 text-white`}
                              >
                                  <PlayCircle size={12} /> WATCH AD ({currentAds}/{reqAds})
                              </button>
                              <div className="w-full h-1 bg-gray-700 rounded-full overflow-hidden">
                                  <div className="h-full bg-yellow-400" style={{ width: `${Math.min(100, (currentAds / reqAds) * 100)}%` }}></div>
                              </div>
                          </div>
                      )}
                  </div>
              );
          };

          return (
              <div className="w-full h-full bg-[#050505] flex flex-col premium-bg">
                   <div className="scanlines"></div>
                   <div className="p-4 flex items-center justify-between bg-black/50 backdrop-blur border-b border-gray-800">
                      <button onClick={onBack} className="p-2 rounded-full hover:bg-white/10"><ChevronLeft /></button>
                      <h1 className="text-xl font-bold hero-title">HANGAR SHOP</h1>
                      <div className="w-10"></div>
                   </div>
                   
                   <div className="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-3 gap-4 pb-20">
                       {SHIPS.map(ship => (
                           <ShipCard key={ship.id} ship={ship} />
                       ))}
                   </div>
              </div>
          );
      };

      // --- GAME 2: FARM GAME ---
      const FarmGame = ({ onBack, addCoins, coins }) => {
          const CROPS = { 'wheat': { id: 'wheat', name: 'Trigo', cost: 0, reward: 5, xp: 5, time: 5000, icon: 'üåæ', adCost: 0, reqLevel: 1 }, 'corn': { id: 'corn', name: 'Milho', cost: 10, reward: 25, xp: 10, time: 10000, icon: 'üåΩ', adCost: 0, reqLevel: 2 }, 'carrot': { id: 'carrot', name: 'Cenoura', cost: 30, reward: 70, xp: 20, time: 20000, icon: 'ü•ï', adCost: 1, reqLevel: 3 }, 'tomato': { id: 'tomato', name: 'Tomate', cost: 80, reward: 180, xp: 40, time: 45000, icon: 'üçÖ', adCost: 2, reqLevel: 5 }, 'strawberry': { id: 'strawberry', name: 'Morango', cost: 150, reward: 350, xp: 80, time: 90000, icon: 'üçì', adCost: 3, reqLevel: 8 }, 'grape': { id: 'grape', name: 'Uva', cost: 300, reward: 800, xp: 150, time: 180000, icon: 'üçá', adCost: 5, reqLevel: 10 } };
          const ANIMALS = { 'chicken': { id: 'chicken', name: 'Galinha', cost: 50, reward: 100, xp: 50, time: 30000, icon: 'üêî', product: 'Ovo', adCost: 0, reqLevel: 2 }, 'pig': { id: 'pig', name: 'Porco', cost: 150, reward: 250, xp: 100, time: 60000, icon: 'üê∑', product: 'Bacon', adCost: 0, reqLevel: 4 }, 'cow': { id: 'cow', name: 'Vaca', cost: 500, reward: 800, xp: 250, time: 120000, icon: 'üêÆ', product: 'Leite', adCost: 1, reqLevel: 7 }, 'sheep': { id: 'sheep', name: 'Ovelha', cost: 1000, reward: 1500, xp: 500, time: 300000, icon: 'üêë', product: 'L√£', adCost: 2, reqLevel: 12 } };
          
          const [grid, setGrid] = useState(() => { try { return JSON.parse(localStorage.getItem('farm_grid_v2') || '[]'); } catch { return []; } });
          const [selectedItem, setSelectedItem] = useState('wheat'); 
          const [category, setCategory] = useState('plants'); 
          const [now, setNow] = useState(Date.now()); 
          const [showMissions, setShowMissions] = useState(false); 
          const [showExpand, setShowExpand] = useState(false);
          
          // Persistence
          const [landLevel, setLandLevel] = useState(() => { try { return parseInt(localStorage.getItem('farm_land') || '6'); } catch { return 6; } });
          const [level, setLevel] = useState(() => { try { return parseInt(localStorage.getItem('farm_level') || '1'); } catch { return 1; } });
          const [xp, setXp] = useState(() => { try { return parseInt(localStorage.getItem('farm_xp') || '0'); } catch { return 0; } });
          const [cropAdProgress, setCropAdProgress] = useState(() => { try { return JSON.parse(localStorage.getItem('farm_crop_ads') || '{}'); } catch { return {}; } });
          
          const [levelUpNotif, setLevelUpNotif] = useState(false); const maxXp = level * 100;
          
          const addXp = (amount) => { setXp(prev => { const newXp = prev + amount; if (newXp >= maxXp) { setLevel(l => l + 1); setLevelUpNotif(true); playSound('levelup'); setTimeout(() => setLevelUpNotif(false), 3000); return newXp - maxXp; } return newXp; }); };
          const [missions, setMissions] = useState(() => { try { const saved = safeStorage.getItem('farm_missions'); return saved ? JSON.parse(saved) : [{ id: 1, text: "Colher 5 Trigos", target: 'wheat', count: 5, progress: 0, reward: 50, claimed: false }, { id: 2, text: "Colher 3 Milhos", target: 'corn', count: 3, progress: 0, reward: 100, claimed: false }, { id: 3, text: "Lucrar 200 Moedas", type: 'earn', count: 200, progress: 0, reward: 50, claimed: false }]; } catch { return []; } });

          useEffect(() => { if (grid.length < landLevel) { const newGrid = [...grid]; while(newGrid.length < landLevel) newGrid.push({ id: Date.now() + Math.random(), crop: null, plantedAt: null }); setGrid(newGrid); } const interval = setInterval(() => setNow(Date.now()), 1000); return () => clearInterval(interval); }, [landLevel]);
          useEffect(() => safeStorage.setItem('farm_grid_v2', JSON.stringify(grid)), [grid]); useEffect(() => safeStorage.setItem('farm_land', landLevel.toString()), [landLevel]); useEffect(() => safeStorage.setItem('farm_missions', JSON.stringify(missions)), [missions]); useEffect(() => safeStorage.setItem('farm_level', level.toString()), [level]); useEffect(() => safeStorage.setItem('farm_xp', xp.toString()), [xp]);
          useEffect(() => safeStorage.setItem('farm_crop_ads', JSON.stringify(cropAdProgress)), [cropAdProgress]);

          const updateMission = (type, id, amount = 1) => { setMissions(prev => prev.map(m => { if (m.claimed) return m; let match = false; if (m.type === 'earn' && type === 'earn') match = true; else if (m.target === id) match = true; if (match) return { ...m, progress: Math.min(m.count, m.progress + amount) }; return m; })); };
          const claimMission = (m) => { if (m.progress >= m.count && !m.claimed) { if (supabase && navigator.onLine) { supabase.rpc('add_coins', { amount: m.reward }).then(({ error }) => { if (!error) addCoins(m.reward); else addCoins(m.reward); }); } else { addCoins(m.reward); } addXp(20); playSound('win'); setMissions(prev => prev.map(pm => pm.id === m.id ? { ...pm, claimed: true } : pm)); } };
          
          const handlePlotClick = (index, e) => { 
            const plot = grid[index]; if (plot.crop) { const isAnimal = ANIMALS[plot.crop]; const def = isAnimal ? ANIMALS[plot.crop] : (plot.crop ? CROPS[plot.crop] : null); if (!def) { const newGrid = [...grid]; newGrid[index] = { ...plot, crop: null, plantedAt: null }; setGrid(newGrid); return; } if (now - plot.plantedAt >= def.time) { if (supabase && navigator.onLine) { supabase.rpc('add_coins', { amount: def.reward }).then(({ error }) => { if (!error) addCoins(def.reward); else addCoins(def.reward); }); } else { addCoins(def.reward); } addXp(def.xp); updateMission('harvest', plot.crop); updateMission('earn', null, def.reward); playSound('harvest'); const newGrid = [...grid]; newGrid[index] = { ...plot, crop: null, plantedAt: null }; setGrid(newGrid); } } else { const dict = category === 'animals' ? ANIMALS : CROPS; const item = dict[selectedItem]; if (item && coins >= item.cost) { if (level < item.reqLevel) { playSound('lose'); return; } if (supabase && navigator.onLine) { supabase.rpc('add_coins', { amount: -item.cost }).then(({ error }) => { if (!error) addCoins(-item.cost); else addCoins(-item.cost); }); } else { addCoins(-item.cost); } addXp(category === 'animals' ? 10 : 2); playSound('plant'); const newGrid = [...grid]; newGrid[index] = { ...plot, crop: selectedItem, plantedAt: now }; setGrid(newGrid); } else { playSound('lose'); } } 
          };
          
          const handleExpand = () => { 
              triggerAd(() => {
                setLandLevel(prev => prev + 2); 
                setShowExpand(false); 
                playSound('buy');
              });
          };
          const handleTurbo = () => { 
              triggerAd(() => {
                const SKIP_MS = 600000; 
                setGrid(prev => prev.map(p => { if (p.crop && p.plantedAt) return { ...p, plantedAt: p.plantedAt - SKIP_MS }; return p; })); 
                playSound('powerup');
              });
          };
          
          const handleItemAdWatch = (id, cost) => {
              triggerAd(() => {
                const current = cropAdProgress[id] || 0;
                if (current < cost) {
                    setCropAdProgress(prev => ({ ...prev, [id]: current + 1 }));
                    playSound('buy');
                }
              });
          };

          const availableItems = category === 'animals' ? Object.values(ANIMALS) : Object.values(CROPS);

          return (
              <div className="w-full h-full farm-scene flex flex-col overflow-hidden relative text-white font-sans">
                   <div className="absolute top-0 w-full p-4 flex flex-col gap-2 z-40 bg-gradient-to-b from-black/80 to-transparent pointer-events-none">
                       <div className="flex justify-between items-start">
                           <button onClick={() => { playSound('ui_click'); onBack(); }} className="pointer-events-auto p-2 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur"><ChevronLeft /></button>
                           <div className="flex flex-col items-center"><div className="flex items-center gap-2 mb-1"><div className="bg-purple-600 w-8 h-8 rounded-full flex items-center justify-center font-bold border-2 border-purple-400 shadow-lg z-10">{level}</div><div className="w-32 h-4 bg-slate-800 rounded-full border border-slate-600 overflow-hidden relative"><div className="h-full bg-gradient-to-r from-purple-500 to-cyan-500 transition-all duration-500" style={{ width: `${Math.min(100, (xp/maxXp)*100)}%` }}></div><div className="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white drop-shadow">{xp} / {maxXp} XP</div></div></div></div>
                           <div className="flex items-center gap-2"><button onClick={() => setShowMissions(true)} className="pointer-events-auto bg-blue-600/80 p-2 rounded-full border border-blue-400 shadow-lg animate-pulse relative"><ClipboardList size={20} />{missions.some(m => m.progress >= m.count && !m.claimed) && <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></span>}</button><div className="bg-yellow-500/80 px-4 py-1.5 rounded-full font-bold text-white shadow-[0_0_15px_rgba(234,179,8,0.5)] border border-yellow-300 flex items-center gap-2"><Coins size={16} className="text-white fill-white" /> {coins}</div></div>
                       </div>
                   </div>
                   {levelUpNotif && <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 level-up-anim pointer-events-none flex flex-col items-center"><div className="text-6xl mb-2">‚≠ê</div><h2 className="text-4xl font-bold text-yellow-300 drop-shadow-[0_0_10px_rgba(253,224,71,0.8)]">LEVEL UP!</h2><p className="text-xl font-bold text-white">N√≠vel {level}</p></div>}
                   
                   {/* Main Game Area - Fixed Camera */}
                   <div className="flex-1 flex items-center justify-center farm-perspective relative overflow-hidden">
                       <div 
                            className="farm-grid-3d grid grid-cols-2 gap-6 p-10 relative origin-center" 
                            style={{ 
                                transform: 'rotateX(45deg) rotateZ(-45deg) scale(0.8)'
                            }}
                       >
                           <div className="absolute inset-0 bg-blue-500/5 blur-3xl rounded-full pointer-events-none"></div>
                           <div className="absolute -top-20 left-1/2 -translate-x-1/2 text-7xl farmer-anim z-30 drop-shadow-[0_20px_20px_rgba(0,0,0,0.8)] pointer-events-none">ü§ñ</div>
                           
                           {grid.map((plot, i) => { 
                               const isAnimal = plot.crop && ANIMALS[plot.crop]; 
                               const def = isAnimal ? ANIMALS[plot.crop] : (plot.crop ? CROPS[plot.crop] : null); 
                               const progress = def ? Math.min(100, ((now - plot.plantedAt)/def.time)*100) : 0; 
                               const isReady = progress >= 100; 
                               return (
                                   <div 
                                      key={i} 
                                      onClick={(e) => {
                                          e.stopPropagation(); 
                                          handlePlotClick(i, e);
                                      }} 
                                      className={`w-28 h-28 rounded-xl farm-plot relative group cursor-pointer ${isReady ? 'ready' : ''}`}
                                   >
                                       {def && (<div className={`absolute -top-8 left-0 right-0 text-center transition-all ${isReady ? 'float-ui scale-110 drop-shadow-[0_0_10px_gold]' : 'opacity-80'}`}><span className="text-5xl filter drop-shadow-md">{def.icon}</span></div>)}
                                       {def && !isReady && (<div className="absolute inset-x-2 bottom-2 h-1 bg-gray-800 rounded-full overflow-hidden"><div className="h-full bg-cyan-400 shadow-[0_0_10px_cyan]" style={{ width: `${progress}%` }}></div></div>)}
                                       {!def && <div className="absolute inset-0 flex items-center justify-center opacity-20 group-hover:opacity-40"><div className="w-12 h-12 border-2 border-dashed border-white rounded-full"></div></div>}
                                   </div>
                               ); 
                           })}
                       </div>
                   </div>
                   
                   <button onClick={handleTurbo} className="absolute right-4 bottom-52 z-40 bg-yellow-500 hover:bg-yellow-400 text-black p-3 rounded-full shadow-[0_0_20px_gold] animate-bounce border-2 border-white flex flex-col items-center"><Zap size={24} fill="black" /><span className="text-[10px] font-bold mt-1">TURBO</span><span className="text-[8px] bg-black text-yellow-500 px-1 rounded">AD</span></button>
                   <div className="neon-bar h-48 w-full z-40 flex flex-col"><div className="flex w-full border-b border-white/10"><button onClick={() => { setCategory('plants'); setSelectedItem('wheat'); playSound('ui_click'); }} className={`flex-1 py-2 font-bold text-sm uppercase tracking-wider ${category === 'plants' ? 'text-cyan-400 bg-white/5 border-b-2 border-cyan-400' : 'text-gray-500'}`}>Plantas</button><button onClick={() => { setCategory('animals'); setSelectedItem('chicken'); playSound('ui_click'); }} className={`flex-1 py-2 font-bold text-sm uppercase tracking-wider ${category === 'animals' ? 'text-purple-400 bg-white/5 border-b-2 border-purple-400' : 'text-gray-500'}`}>Animais</button></div><div className="flex-1 overflow-x-auto flex gap-4 p-4 items-center">
                           {availableItems.map(item => { 
                               const locked = level < item.reqLevel; 
                               const currentAds = cropAdProgress[item.id] || 0;
                               const isAdLocked = item.adCost > currentAds;
                               
                               return (
                               <button key={item.id} onClick={() => { 
                                   if(locked) { playSound('ui_hover'); return; }
                                   if(isAdLocked) { handleItemAdWatch(item.id, item.adCost); return; }
                                   setSelectedItem(item.id); playSound('ui_click'); 
                               }} className={`flex-shrink-0 w-24 h-28 rounded-xl flex flex-col items-center justify-center border transition-all active:scale-95 relative overflow-hidden ${selectedItem === item.id ? 'border-cyan-400 bg-cyan-900/20 shadow-[0_0_10px_rgba(34,211,238,0.2)]' : 'border-slate-700 bg-black/40 hover:border-slate-500'}`}>
                                   {locked && (<div className="absolute inset-0 bg-black/80 z-20 flex flex-col items-center justify-center text-gray-400"><Lock size={16} className="mb-1" /><span className="text-[10px] font-bold">NVL {item.reqLevel}</span></div>)}
                                   {!locked && isAdLocked && (<div className="absolute inset-0 bg-black/80 z-20 flex flex-col items-center justify-center text-yellow-400 hover:text-yellow-300"><PlayCircle size={20} className="mb-1" /><span className="text-[10px] font-bold">AD {currentAds}/{item.adCost}</span></div>)}
                                   <div className="text-4xl mb-2 filter drop-shadow-lg">{item.icon}</div><div className="text-[10px] font-bold text-gray-300 uppercase tracking-wide">{item.name}</div><div className="text-[10px] text-yellow-400 font-bold mt-1 bg-black/50 px-2 py-0.5 rounded border border-yellow-500/30">{item.cost} üí∞</div>{category === 'animals' && <div className="text-[8px] text-purple-300 mt-0.5">{item.product}</div>}
                               </button>); 
                           })}
                           <button onClick={() => setShowExpand(true)} className="flex-shrink-0 w-24 h-28 rounded-xl flex flex-col items-center justify-center border border-dashed border-green-500/50 bg-green-900/10 hover:bg-green-900/20 text-green-400"><PlusCircle size={24} className="mb-2" /><span className="text-[10px] font-bold uppercase">Expandir</span></button></div></div>
                   {showMissions && (<Modal title="MISS√ïES DI√ÅRIAS" onClose={() => setShowMissions(false)}><div className="flex flex-col gap-3">{missions.map(m => (<div key={m.id} className="bg-slate-800/80 p-3 rounded-lg border border-slate-700 flex justify-between items-center"><div className="flex-1"><div className="text-sm font-bold text-cyan-100">{m.text}</div><div className="w-full bg-slate-950 h-1.5 mt-2 rounded-full overflow-hidden"><div className="h-full bg-cyan-500" style={{ width: `${Math.min(100, (m.progress/m.count)*100)}%` }}></div></div><div className="text-[10px] text-gray-400 mt-1">{m.progress} / {m.count}</div></div>{m.claimed ? (<CheckCircle className="text-green-500 ml-2" />) : (<button disabled={m.progress < m.count} onClick={() => claimMission(m)} className={`ml-3 px-3 py-1 rounded text-xs font-bold ${m.progress >= m.count ? 'bg-yellow-500 text-black animate-pulse shadow-[0_0_10px_gold]' : 'bg-slate-700 text-gray-500'}`}>+{m.reward}</button>)}</div>))}</div></Modal>)}
                   {showExpand && (<Modal title="EXPANDIR TERRENO" onClose={() => setShowExpand(false)}><div className="text-center p-4"><div className="text-6xl mb-4">üöú</div><h3 className="text-white text-lg font-bold mb-2">Precisa de mais espa√ßo?</h3><p className="text-gray-400 text-sm mb-6">Assista a um an√∫ncio para adicionar 2 novos lotes de plantio.</p><button onClick={handleExpand} className="w-full py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl shadow-[0_0_15px_rgba(34,197,94,0.4)] flex items-center justify-center gap-2"><PlayCircle size={18} /> EXPANDIR AGORA</button></div></Modal>)}
              </div>
          );
      };

      // --- GAME 3: HANGMAN (Enhanced 3D UI) ---
      const HangmanGame = ({ onBack, addCoins }) => {
        const WORDS = [
          { word: "JAVASCRIPT", hint: "Linguagem da Web" },
          { word: "REACT", hint: "Biblioteca UI" },
          { word: "GALAXY", hint: "Via L√°ctea" },
          { word: "FAZENDA", hint: "Lugar de plantar" },
          { word: "ROBO", hint: "Intelig√™ncia Artificial" },
          { word: "INTERNET", hint: "Rede Mundial" },
          { word: "CODIGO", hint: "Instru√ß√µes do PC" },
          { word: "FUTURO", hint: "O que vir√°" }
        ];

        const [game, setGame] = useState(() => {
           const rand = WORDS[Math.floor(Math.random() * WORDS.length)];
           return { ...rand, guessed: [], errors: 0, status: 'playing' };
        });

        const handleGuess = (letter) => {
            if (game.status !== 'playing' || game.guessed.includes(letter)) return;
            const newGuessed = [...game.guessed, letter];
            const isError = !game.word.includes(letter);
            const newErrors = isError ? game.errors + 1 : game.errors;
            const isWin = game.word.split('').every(l => newGuessed.includes(l));
            const isLose = newErrors >= 6;
            
            playSound(isError ? 'ui_click' : 'powerup');
            if(isWin) playSound('win');
            if(isLose) playSound('lose');

            setGame(prev => ({ ...prev, guessed: newGuessed, errors: newErrors, status: isWin ? 'won' : (isLose ? 'lost' : 'playing') }));
            
            if (isWin) addCoins(20);
        };

        const handleRestart = () => {
            const rand = WORDS[Math.floor(Math.random() * WORDS.length)];
            setGame({ ...rand, guessed: [], errors: 0, status: 'playing' });
            playSound('ui_click');
        };

        const handleHint = () => {
             triggerAd(() => {
                 const hidden = game.word.split('').filter(l => !game.guessed.includes(l));
                 if (hidden.length > 0) {
                     const reveal = hidden[Math.floor(Math.random() * hidden.length)];
                     handleGuess(reveal);
                 }
                 playSound('powerup');
             });
        };

        return (
            <div className="w-full h-full bg-[#050505] flex flex-col items-center justify-center relative overflow-hidden" style={{ background: 'radial-gradient(circle at center, #2e1065 0%, #020617 100%)' }}>
                {/* 3D Grid Floor Effect */}
                <div className="absolute inset-0 opacity-30" style={{ 
                    backgroundImage: 'linear-gradient(rgba(168, 85, 247, 0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(168, 85, 247, 0.2) 1px, transparent 1px)', 
                    backgroundSize: '40px 40px',
                    transform: 'perspective(500px) rotateX(60deg) translateY(100px) scale(2)',
                    transformOrigin: 'bottom center',
                    maskImage: 'linear-gradient(to top, black 0%, transparent 80%)'
                }}></div>
                
                {/* Floating Particles/Stars */}
                 <div className="absolute inset-0 pointer-events-none">
                     <div className="absolute top-1/4 left-1/4 w-2 h-2 bg-purple-500 rounded-full blur-[2px] animate-pulse"></div>
                     <div className="absolute top-3/4 right-1/4 w-1 h-1 bg-cyan-400 rounded-full blur-[1px] animate-pulse" style={{ animationDelay: '1s' }}></div>
                 </div>

                {/* Header UI */}
                <div className="absolute top-0 w-full p-4 flex justify-between items-start z-50">
                     <button onClick={onBack} className="p-3 bg-black/40 backdrop-blur border border-purple-500/30 rounded-full text-white hover:bg-purple-500/20 transition"><ChevronLeft /></button>
                     <div className="text-right">
                         <h1 className="text-3xl font-bold font-['Rajdhani'] tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400 drop-shadow-[0_0_10px_rgba(168,85,247,0.5)]">NEON HANGMAN</h1>
                     </div>
                </div>

                {/* Main 3D Card Container */}
                <div className="relative z-10 w-full max-w-2xl px-4 perspective-[1000px]">
                    <div className="transform transition-all duration-500 preserve-3d" style={{ transform: 'rotateX(5deg)' }}>
                        
                        {/* Gallows / Hologram Display */}
                        <div className="mb-8 flex justify-center relative">
                            <div className="w-64 h-64 border-4 border-purple-900/50 rounded-full flex items-center justify-center bg-black/40 backdrop-blur-sm shadow-[0_0_50px_rgba(88,28,135,0.3)] relative overflow-hidden">
                                {/* Grid inside circle */}
                                <div className="absolute inset-0 opacity-20" style={{ backgroundImage: 'radial-gradient(circle, #a855f7 1px, transparent 1px)', backgroundSize: '10px 10px' }}></div>
                                
                                <svg width="200" height="200" className="drop-shadow-[0_0_8px_rgba(255,255,255,0.8)]">
                                    {/* Base Structure - Neon Blue */}
                                    <path d="M40 180 L160 180 M80 180 L80 30 L160 30 L160 50" stroke="#3b82f6" strokeWidth="4" fill="none" strokeLinecap="round" className="filter drop-shadow-[0_0_5px_#3b82f6]" />
                                    
                                    {/* The Man - Neon Pink/Purple */}
                                    <g stroke="#d946ef" strokeWidth="4" fill="none" strokeLinecap="round" className="filter drop-shadow-[0_0_5px_#d946ef]">
                                        {game.errors > 0 && <circle cx="160" cy="70" r="15" className="animate-[fadeIn_0.5s]" />}
                                        {game.errors > 1 && <path d="M160 85 L160 135" className="animate-[fadeIn_0.5s]" />}
                                        {game.errors > 2 && <path d="M160 95 L135 120" className="animate-[fadeIn_0.5s]" />}
                                        {game.errors > 3 && <path d="M160 95 L185 120" className="animate-[fadeIn_0.5s]" />}
                                        {game.errors > 4 && <path d="M160 135 L140 170" className="animate-[fadeIn_0.5s]" />}
                                        {game.errors > 5 && <path d="M160 135 L180 170" className="animate-[fadeIn_0.5s]" />}
                                    </g>
                                </svg>
                            </div>
                        </div>

                        {/* Word Display */}
                        <div className="flex justify-center gap-3 mb-6 flex-wrap min-h-[60px]">
                            {game.word.split('').map((l, i) => (
                                <div key={i} className={`
                                    w-12 h-14 flex items-center justify-center text-3xl font-bold rounded-lg border-b-4 transition-all duration-300 transform
                                    ${game.guessed.includes(l) 
                                        ? 'bg-gradient-to-b from-purple-900/80 to-purple-600/20 border-purple-500 text-white shadow-[0_0_20px_rgba(168,85,247,0.4)] translate-y-0 opacity-100' 
                                        : 'bg-white/5 border-white/10 text-transparent translate-y-2'}
                                `}>
                                    {game.guessed.includes(l) ? l : ''}
                                </div>
                            ))}
                        </div>
                        
                        {/* Hint Pill */}
                        <div className="flex justify-center mb-8">
                            <div className="px-6 py-2 bg-black/60 rounded-full border border-purple-500/30 text-purple-300 font-bold text-sm tracking-widest uppercase shadow-[0_0_15px_rgba(0,0,0,0.5)] flex items-center gap-2">
                                <HelpCircle size={16} />
                                <span>DICA: {game.hint}</span>
                            </div>
                        </div>

                        {/* Keyboard */}
                        <div className="grid grid-cols-7 gap-2 max-w-lg mx-auto p-4 bg-black/40 rounded-2xl border border-white/5 backdrop-blur-md shadow-2xl">
                            {"ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('').map(l => {
                                const isGuessed = game.guessed.includes(l);
                                const isCorrect = isGuessed && game.word.includes(l);
                                const isWrong = isGuessed && !game.word.includes(l);
                                
                                return (
                                    <button 
                                        key={l} 
                                        disabled={game.status !== 'playing' || isGuessed} 
                                        onClick={() => handleGuess(l)} 
                                        className={`
                                            aspect-square rounded-lg font-bold text-lg relative overflow-hidden transition-all duration-200
                                            ${!isGuessed 
                                                ? 'bg-slate-800 text-gray-300 hover:bg-slate-700 hover:text-white hover:-translate-y-1 hover:shadow-[0_4px_0_rgba(255,255,255,0.1)] active:translate-y-0 active:shadow-none border-b-4 border-slate-950' 
                                                : isCorrect
                                                    ? 'bg-green-600 text-white border-b-4 border-green-800 opacity-50 cursor-not-allowed shadow-[0_0_10px_rgba(34,197,94,0.5)]'
                                                    : 'bg-red-900/50 text-red-400 border-b-4 border-red-950 opacity-40 cursor-not-allowed'}
                                        `}
                                    >
                                        {l}
                                        {/* Shine effect */}
                                        {!isGuessed && <div className="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/10 to-transparent pointer-events-none"></div>}
                                    </button>
                                )
                            })}
                        </div>
                        
                        {/* Action Buttons */}
                        <div className="mt-8 flex justify-center gap-6">
                            {game.status === 'playing' ? (
                                <button onClick={handleHint} className="group relative px-8 py-4 bg-yellow-600 hover:bg-yellow-500 rounded-xl font-bold text-white shadow-[0_0_20px_rgba(234,179,8,0.4)] transition-all hover:scale-105 active:scale-95 flex items-center gap-3 overflow-hidden">
                                    <div className="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 skew-y-12"></div>
                                    <Lightbulb size={24} className="fill-yellow-200 animate-pulse" />
                                    <span className="relative z-10">REVELAR LETRA (AD)</span>
                                </button>
                            ) : (
                                <button onClick={handleRestart} className="group relative px-10 py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-xl font-bold text-white shadow-[0_0_30px_rgba(59,130,246,0.5)] transition-all hover:scale-105 active:scale-95 flex items-center gap-3">
                                    <RefreshCw size={24} className="group-hover:rotate-180 transition-transform duration-500" />
                                    <span>NOVO JOGO</span>
                                </button>
                            )}
                        </div>

                        {/* Status Message Overlay */}
                        {game.status !== 'playing' && (
                            <div className="absolute inset-0 z-20 flex items-center justify-center pointer-events-none">
                                <div className="bg-black/90 backdrop-blur-xl border border-white/20 p-8 rounded-2xl flex flex-col items-center gap-4 animate-[zoomIn_0.3s_ease-out] shadow-[0_0_50px_rgba(0,0,0,0.8)] pointer-events-auto">
                                    {game.status === 'won' ? (
                                        <>
                                            <div className="text-6xl animate-bounce">üèÜ</div>
                                            <h2 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 uppercase tracking-widest drop-shadow-sm">Vit√≥ria!</h2>
                                            <p className="text-gray-300">Voc√™ descobriu: <span className="text-purple-400 font-bold">{game.word}</span></p>
                                        </>
                                    ) : (
                                        <>
                                            <div className="text-6xl animate-pulse">üíÄ</div>
                                            <h2 className="text-4xl font-black text-red-500 uppercase tracking-widest drop-shadow-[0_0_15px_rgba(239,68,68,0.5)]">Game Over</h2>
                                            <p className="text-gray-300">A palavra era: <span className="text-blue-400 font-bold">{game.word}</span></p>
                                        </>
                                    )}
                                    <button onClick={handleRestart} className="mt-4 px-8 py-3 bg-white text-black font-bold rounded-full hover:bg-gray-200 transition">JOGAR NOVAMENTE</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
      };

      // --- MAIN APP ORCHESTRATOR ---
      const App = () => {
          const [screen, setScreen] = useState('menu');
          const [user, setUser] = useState(null);
          const [showAuth, setShowAuth] = useState(false);
          const [coins, setCoins] = useState(() => parseInt(safeStorage.getItem('galaxy_coins') || '100'));
          
          // Galaxy State
          const [unlockedShips, setUnlockedShips] = useState(() => JSON.parse(safeStorage.getItem('galaxy_unlocked') || '["starter"]'));
          const [equippedShip, setEquippedShip] = useState(() => safeStorage.getItem('galaxy_equipped') || 'starter');
          const [shipAdProgress, setShipAdProgress] = useState(() => JSON.parse(safeStorage.getItem('galaxy_ship_ads') || '{}'));

          // Sync coins
          useEffect(() => { safeStorage.setItem('galaxy_coins', coins.toString()); }, [coins]);
          useEffect(() => { safeStorage.setItem('galaxy_unlocked', JSON.stringify(unlockedShips)); }, [unlockedShips]);
          useEffect(() => { safeStorage.setItem('galaxy_equipped', equippedShip); }, [equippedShip]);
          useEffect(() => { safeStorage.setItem('galaxy_ship_ads', JSON.stringify(shipAdProgress)); }, [shipAdProgress]);

          const addCoins = (amount) => { 
              setCoins(c => {
                  const newVal = Math.max(0, c + amount);
                  if (amount > 0) playSound('buy');
                  return newVal;
              }); 
          };

          const handleShipAdWatch = (shipId, requiredAds) => {
              const current = shipAdProgress[shipId] || 0;
              if (current < requiredAds) {
                  const next = current + 1;
                  setShipAdProgress(p => ({ ...p, [shipId]: next }));
                  if (next >= requiredAds) {
                      setUnlockedShips(prev => [...prev, shipId]);
                      playSound('win');
                  }
              }
          };

          // --- MENU SCREEN ---
          if (screen === 'menu') {
              return (
                  <div className="w-full h-full premium-bg flex flex-col items-center justify-center p-4">
                      <div className="scanlines"></div>
                      <div className="z-10 w-full max-w-md flex flex-col gap-6 animate-fade-in">
                          <div className="text-center mb-4">
                              <h1 className="hero-title text-6xl">JOGOS<br/><span className="text-blue-500">ONLINE</span></h1>
                              <p className="text-gray-400 tracking-[0.5em] text-xs mt-2 uppercase">Arcade ‚Ä¢ Farm ‚Ä¢ Logic</p>
                          </div>
                          
                          <div className="flex justify-between items-center bg-white/5 p-4 rounded-xl border border-white/10">
                              <div className="flex items-center gap-2">
                                  {user ? (
                                      <div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-bold text-xs">{user.email[0].toUpperCase()}</div><div className="text-xs text-gray-300">Conectado</div></div>
                                  ) : (
                                      <button onClick={() => { playSound('ui_click'); setShowAuth(true); }} className="text-xs font-bold text-blue-400 flex items-center gap-1 hover:text-white"><LogIn size={14} /> LOGIN / SALVAR</button>
                                  )}
                              </div>
                              <div className="flex items-center gap-2 font-bold text-yellow-400 bg-black/40 px-3 py-1 rounded-full border border-yellow-500/20"><Coins size={16} /> {coins}</div>
                          </div>

                          <div className="grid gap-4">
                              <button onClick={() => { playSound('ui_click'); setScreen('galaxy_menu'); }} className="premium-btn h-24 rounded-2xl flex items-center px-6 gap-4 group">
                                  <div className="p-3 bg-blue-500/20 rounded-lg text-blue-400 group-hover:bg-blue-500 group-hover:text-white transition-colors"><Rocket size={32} /></div>
                                  <div className="flex-1 text-left"><div className="font-bold text-xl">GALAXY INVADER</div><div className="text-xs text-gray-400">Combate Espacial 3D</div></div>
                                  <ChevronLeft className="rotate-180 text-gray-500 group-hover:text-white group-hover:translate-x-1 transition" />
                              </button>
                              
                              <button onClick={() => { playSound('ui_click'); setScreen('farm'); }} className="premium-btn h-24 rounded-2xl flex items-center px-6 gap-4 group">
                                  <div className="p-3 bg-green-500/20 rounded-lg text-green-400 group-hover:bg-green-500 group-hover:text-white transition-colors"><Sprout size={32} /></div>
                                  <div className="flex-1 text-left"><div className="font-bold text-xl">FAZENDA 3D</div><div className="text-xs text-gray-400">Plante, Cultive e Lucre</div></div>
                                  <ChevronLeft className="rotate-180 text-gray-500 group-hover:text-white group-hover:translate-x-1 transition" />
                              </button>

                              <button onClick={() => { playSound('ui_click'); setScreen('hangman'); }} className="premium-btn h-24 rounded-2xl flex items-center px-6 gap-4 group">
                                  <div className="p-3 bg-purple-500/20 rounded-lg text-purple-400 group-hover:bg-purple-500 group-hover:text-white transition-colors"><Brain size={32} /></div>
                                  <div className="flex-1 text-left"><div className="font-bold text-xl">HANGMAN</div><div className="text-xs text-gray-400">Desafie seu vocabul√°rio</div></div>
                                  <ChevronLeft className="rotate-180 text-gray-500 group-hover:text-white group-hover:translate-x-1 transition" />
                              </button>
                          </div>
                      </div>
                      
                      <InstallButton />
                      {showAuth && <AuthModal onClose={() => setShowAuth(false)} onLogin={setUser} />}
                  </div>
              );
          }

          // --- ROUTING ---
          if (screen === 'galaxy_menu') return <GalaxyMenu onStart={() => setScreen('galaxy_game')} onShop={() => setScreen('galaxy_shop')} onBack={() => setScreen('menu')} coins={coins} />;
          if (screen === 'galaxy_shop') return <ShopScreen adProgress={shipAdProgress} handleShipAdWatch={handleShipAdWatch} unlockedShips={unlockedShips} equipShip={setEquippedShip} equippedShip={equippedShip} onBack={() => setScreen('galaxy_menu')} />;
          if (screen === 'galaxy_game') return <GalaxyInvader onBack={() => setScreen('galaxy_menu')} equippedShipId={equippedShip} addCoins={addCoins} currentCoins={coins} />;
          if (screen === 'farm') return <FarmGame onBack={() => setScreen('menu')} addCoins={addCoins} coins={coins} />;
          if (screen === 'hangman') return <HangmanGame onBack={() => setScreen('menu')} addCoins={addCoins} />;

          return null;
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>