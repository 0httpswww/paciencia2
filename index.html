<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JoGos Online</title>
    <meta name="description" content="JoGos Online - Arcade, Racing & Learning.">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://r2.erweima.ai/img/compressed/47748805f42289196b6134a65b3c58e4.png">
    <meta name='admaven-placement' content='BqjwGrds9'>
    
    <!-- Monetag Popunder Script -->
    <script>(function(s){s.dataset.zone='10264533',s.src='https://al5sm.com/tag.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            overscroll-behavior: none; 
            touch-action: none; 
            -webkit-tap-highlight-color: transparent; 
            font-family: 'Courier New', Courier, monospace;
            background-color: #000000;
            /* Grid Background - Visible on Black */
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.08) 1px, transparent 1px);
            background-size: 40px 40px;
            color: white; 
            user-select: none; 
            -webkit-user-select: none; 
            overflow: hidden;
        }

        /* Dark Futuristic Professional Title */
        .neon-title {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            font-weight: 900;
            background: linear-gradient(180deg, #e2e8f0 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 
                0 0 20px rgba(148, 163, 184, 0.3);
            filter: drop-shadow(0 0 2px rgba(148, 163, 184, 0.5));
            letter-spacing: -2px;
            text-transform: uppercase;
        }

        .neon-text-small {
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        
        /* White Glow for Menu Items */
        .glass-box {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        .glass-box:hover {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.02);
        }

        .coin-text {
            color: #fbbf24;
            text-shadow: 0 0 5px rgba(251, 191, 36, 0.5);
        }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
        "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
      }
    }
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful');
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</head>
<body>
    <div id="root" class="h-[100dvh] w-full overflow-hidden flex flex-col"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
      import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import { Rocket, ChevronLeft, Sprout, Heart, Star, CheckCircle, XCircle, Volume2, Maximize, ShoppingCart, Coins, Lock, Check, Brain, RefreshCcw, Skull, Worm, Zap, Lightbulb, Download, PlayCircle, Sun, CloudRain, Pickaxe, ClipboardList, Store, X, Shield, Crosshair } from 'lucide-react';

      // --- Helpers for Safe Storage ---
      const safeStorage = {
          getItem: (key) => {
              try { return localStorage.getItem(key); } catch(e) { return null; }
          },
          setItem: (key, value) => {
              try { localStorage.setItem(key, value); } catch(e) {}
          }
      };

      // --- Sound System ---
      let audioContext = null;
      const getAudioContext = () => {
          try {
            if (!audioContext) {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (AudioCtx) {
                    audioContext = new AudioCtx();
                }
            }
            return audioContext;
          } catch (e) { return null; }
      };

      const playSound = (type) => {
          const ctx = getAudioContext();
          if (!ctx) return;
          try {
            if (ctx.state === 'suspended') ctx.resume().catch(() => {});
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            osc.connect(gainNode);
            gainNode.connect(ctx.destination);
            const now = ctx.currentTime;

            switch(type) {
                case 'shoot':
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(880, now);
                    osc.frequency.exponentialRampToValueAtTime(110, now + 0.1);
                    gainNode.gain.setValueAtTime(0.05, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                    break;
                case 'explosion':
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(100, now);
                    osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.4);
                    gainNode.gain.setValueAtTime(0.2, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                    osc.start(now);
                    osc.stop(now + 0.4);
                    break;
                case 'powerup':
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, now);
                    osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                    break;
                 case 'boss_hit':
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(100, now + 0.1);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                    break;
            }
          } catch(e) {}
      };

      const toggleFullScreen = (e) => {
        if (e) e.stopPropagation();
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(err => {
            console.log(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
          });
        } else {
          if (document.exitFullscreen) document.exitFullscreen();
        }
      };

      // --- Install Button Component ---
      const InstallButton = () => {
          const [deferredPrompt, setDeferredPrompt] = useState(null);
          const [showIOSInstructions, setShowIOSInstructions] = useState(false);
          const [isIOS, setIsIOS] = useState(false);
          const [isStandalone, setIsStandalone] = useState(false);

          useEffect(() => {
              // Check if standalone (PWA already installed)
              const isStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
              setIsStandalone(isStandaloneMode);

              // Check if iOS
              const ios = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
              setIsIOS(ios);

              const handler = (e) => {
                  e.preventDefault();
                  setDeferredPrompt(e);
              };
              window.addEventListener('beforeinstallprompt', handler);
              return () => window.removeEventListener('beforeinstallprompt', handler);
          }, []);

          const handleInstall = async () => {
              if (deferredPrompt) {
                  deferredPrompt.prompt();
                  const { outcome } = await deferredPrompt.userChoice;
                  if (outcome === 'accepted') {
                      setDeferredPrompt(null);
                  }
              } else if (isIOS) {
                  setShowIOSInstructions(true);
              }
          };

          if (isStandalone) return null; // Already installed

          // Show button if android/desktop prompt is available OR if it's iOS
          if (!deferredPrompt && !isIOS) return null; 

          return (
              <>
                  <button 
                      onClick={handleInstall}
                      className="absolute top-4 left-4 p-2 bg-purple-600 hover:bg-purple-500 text-white rounded-full shadow-lg animate-pulse flex items-center gap-2 text-xs font-bold z-50 border border-purple-400"
                  >
                      <Download size={16} /> INSTALAR APP
                  </button>
                  
                  {showIOSInstructions && (
                      <div className="fixed inset-0 bg-black/90 z-[60] flex flex-col items-center justify-center p-6 text-center" onClick={() => setShowIOSInstructions(false)}>
                          <div className="bg-slate-800 p-6 rounded-xl border border-white/20 max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}>
                              <div className="flex justify-center mb-4 text-purple-400">
                                  <Download size={48} />
                              </div>
                              <h3 className="text-xl font-bold text-white mb-4">Instalar no iOS</h3>
                              <p className="text-gray-300 mb-6 text-sm leading-relaxed">
                                  Para instalar este app no seu iPhone ou iPad e ter uma experi√™ncia em tela cheia:
                              </p>
                              <div className="flex flex-col gap-4 text-left text-sm text-gray-400 bg-slate-900/50 p-4 rounded-lg">
                                  <div className="flex items-center gap-3">
                                      <div className="p-2 bg-slate-700 rounded text-blue-400">
                                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                                      </div> 
                                      <span>1. Toque no bot√£o <strong>Compartilhar</strong> na barra inferior do Safari.</span>
                                  </div>
                                  <div className="flex items-center gap-3">
                                      <div className="p-2 bg-slate-700 rounded text-white">
                                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                                      </div> 
                                      <span>2. Role para baixo e toque em <strong>Adicionar √† Tela de In√≠cio</strong>.</span>
                                  </div>
                              </div>
                              <button onClick={() => setShowIOSInstructions(false)} className="mt-6 w-full py-3 bg-purple-600 hover:bg-purple-500 rounded-lg font-bold text-white transition">ENTENDI</button>
                          </div>
                      </div>
                  )}
              </>
          );
      };

      // --- SHIP DEFINITIONS & SPRITE GENERATOR ---
      const SHIPS = [
          { id: 'starter', name: 'Prototype', adCost: 0, palette: { main: '#64748b', dark: '#334155', light: '#94a3b8', cockpit: '#0ea5e9', engine: '#f59e0b' } },
          { id: 'blue', name: 'Interceptor', adCost: 5, palette: { main: '#3b82f6', dark: '#1e3a8a', light: '#60a5fa', cockpit: '#06b6d4', engine: '#3b82f6' } },
          { id: 'purple', name: 'Void Walker', adCost: 10, palette: { main: '#7c3aed', dark: '#4c1d95', light: '#8b5cf6', cockpit: '#22d3ee', engine: '#d946ef' } },
          { id: 'green', name: 'Venom Striker', adCost: 15, palette: { main: '#22c55e', dark: '#14532d', light: '#4ade80', cockpit: '#facc15', engine: '#84cc16' } },
          { id: 'yellow', name: 'Solar Flare', adCost: 20, palette: { main: '#f97316', dark: '#9a3412', light: '#fbbf24', cockpit: '#38bdf8', engine: '#ef4444' } },
          { id: 'red', name: 'Crimson Fury', adCost: 25, palette: { main: '#ef4444', dark: '#7f1d1d', light: '#f87171', cockpit: '#10b981', engine: '#f59e0b' } },
          { id: 'legendary', name: 'Abyssal King', adCost: 30, palette: { main: '#172554', dark: '#020617', light: '#2563eb', cockpit: '#00ffff', engine: '#00ffff' } },
      ];

      const generatePlayerSprite = (palette) => {
          const canvas = document.createElement('canvas');
          const size = 32;
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext('2d');
          const P = palette.main; const D = palette.dark; const L = palette.light;
          const C = palette.cockpit; const W = '#ffffff'; const B = palette.engine;
          const pixelSize = 2;
          const grid = [
              "      11      ", "     1221     ", "     1441     ", "    124521    ", "    124421    ",
              "   12233221   ", "   12233221   ", "  1222222221  ", "  1222222221  ", " 122114411221 ",
              " 121124421121 ", " 121222222121 ", "12212222221221", "12211666611221", "111 116611 111", "     1111     "
          ];
          const colorMap = { '1': D, '2': P, '3': L, '4': C, '5': W, '6': B };
          for(let y=0; y<grid.length; y++) {
              const row = grid[y];
              for(let x=0; x<row.length; x++) {
                  const char = row[x];
                  if(colorMap[char]) { ctx.fillStyle = colorMap[char]; ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize); }
              }
          }
          const img = new Image(); img.src = canvas.toDataURL(); return img;
      };

      const generateEnemySprite = (type) => {
        const canvas = document.createElement('canvas');
        canvas.width = 32; canvas.height = 32;
        const ctx = canvas.getContext('2d');
        const pixelSize = 2;
        let color = '#ef4444'; 
        if(type === 'kamikaze') color = '#fbbf24';
        if(type === 'heavy') color = '#a855f7';
        if(type === 'boss') { color = '#dc2626'; canvas.width=64; canvas.height=64; }

        ctx.fillStyle = color;
        
        if (type === 'boss') {
            // Simple Boss Shape
            ctx.fillRect(8, 8, 48, 24);
            ctx.fillRect(16, 32, 32, 16);
            ctx.fillStyle = '#fca5a5';
            ctx.fillRect(24, 16, 8, 8); // Eyes
            ctx.fillRect(32, 16, 8, 8);
        } else {
             // Basic Enemy Shape
            ctx.fillRect(4, 4, 24, 16);
            ctx.fillRect(10, 20, 12, 8);
            ctx.fillStyle = '#000000';
            ctx.fillRect(8, 8, 4, 4);
            ctx.fillRect(20, 8, 4, 4);
        }
        
        const img = new Image(); img.src = canvas.toDataURL(); return img;
      };

      // --- COMPONENT: Galaxy Invader (Restored & Enhanced) ---
      const GalaxyInvader = ({ onBack, triggerAd, equippedShipId, addCoins, currentCoins }) => {
          const canvasRef = useRef(null);
          const [gameState, setGameState] = useState('playing'); // playing, gameover, boss
          const [score, setScore] = useState(0);
          const [hp, setHp] = useState(100);
          const [wave, setWave] = useState(1);
          const [weaponLevel, setWeaponLevel] = useState(1);
          
          const shipConfig = SHIPS.find(s => s.id === equippedShipId) || SHIPS[0];
          
          useEffect(() => {
              const canvas = canvasRef.current;
              const ctx = canvas.getContext('2d');
              let animationFrameId;
              let lastTime = 0;
              
              // Load Sprites
              const playerSprite = generatePlayerSprite(shipConfig.palette);
              const enemySprites = {
                  basic: generateEnemySprite('basic'),
                  kamikaze: generateEnemySprite('kamikaze'),
                  heavy: generateEnemySprite('heavy'),
                  boss: generateEnemySprite('boss')
              };

              // Game Entities
              let player = { x: canvas.width/2, y: canvas.height - 100, w: 40, h: 40, dx: 0, dy: 0, hp: 100, maxHp: 100, weapon: 1 };
              let bullets = [];
              let enemies = [];
              let particles = [];
              let powerups = [];
              let boss = null;
              let stars = [];
              
              // Input
              let touchX = null;
              let isTouching = false;
              
              // Init Stars
              for(let i=0; i<50; i++) {
                  stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, speed: Math.random() * 2 + 0.5, size: Math.random() * 2 });
              }

              const spawnEnemy = () => {
                  if (boss) return;
                  const types = ['basic', 'basic', 'basic', 'kamikaze', 'heavy'];
                  // Difficulty scaling
                  if (Math.random() < 0.02 + (score / 10000)) {
                      const type = types[Math.floor(Math.random() * types.length)];
                      const size = type === 'heavy' ? 40 : 30;
                      const hp = type === 'heavy' ? 3 + Math.floor(score/500) : 1;
                      enemies.push({
                          x: Math.random() * (canvas.width - size),
                          y: -50,
                          w: size, h: size,
                          type: type,
                          hp: hp,
                          speed: type === 'kamikaze' ? 5 : (type === 'heavy' ? 1.5 : 2.5),
                          vx: type === 'kamikaze' ? (Math.random() - 0.5) * 2 : 0
                      });
                  }
              };

              const spawnPowerup = (x, y) => {
                  if(Math.random() > 0.85) { // 15% drop rate
                       powerups.push({ x, y, w: 20, h: 20, type: Math.random() > 0.5 ? 'weapon' : 'heal' });
                  }
              };

              const spawnBoss = () => {
                  boss = {
                      x: canvas.width / 2 - 60,
                      y: -100,
                      w: 120, h: 80,
                      hp: 100 + (score * 0.1),
                      maxHp: 100 + (score * 0.1),
                      phase: 'enter', // enter, fight
                      dx: 2
                  };
                  playSound('boss_spawn');
              };

              // Main Loop
              const loop = (timestamp) => {
                  const dt = timestamp - lastTime;
                  lastTime = timestamp;

                  // Clear
                  ctx.fillStyle = '#000000';
                  ctx.fillRect(0, 0, canvas.width, canvas.height);

                  // Stars
                  ctx.fillStyle = '#ffffff';
                  stars.forEach(star => {
                      star.y += star.speed;
                      if(star.y > canvas.height) { star.y = 0; star.x = Math.random() * canvas.width; }
                      ctx.globalAlpha = Math.random() * 0.5 + 0.5;
                      ctx.fillRect(star.x, star.y, star.size, star.size);
                      ctx.globalAlpha = 1.0;
                  });

                  // Player Movement
                  if (isTouching && touchX !== null) {
                      const diff = touchX - player.x;
                      player.x += diff * 0.2; // Smooth lerp
                  }
                  
                  // Clamp Player
                  player.x = Math.max(player.w/2, Math.min(canvas.width - player.w/2, player.x));

                  // Auto Fire
                  if (timestamp % 15 < 1) { // Rate of fire
                       playSound('shoot');
                       // Weapon logic
                       bullets.push({ x: player.x, y: player.y - 20, w: 4, h: 10, vy: -10, color: '#38bdf8', damage: 1 });
                       if (player.weapon >= 2) {
                           bullets.push({ x: player.x - 10, y: player.y - 10, w: 3, h: 8, vy: -10, color: '#38bdf8', damage: 1 });
                           bullets.push({ x: player.x + 10, y: player.y - 10, w: 3, h: 8, vy: -10, color: '#38bdf8', damage: 1 });
                       }
                       if (player.weapon >= 3) { // Spread
                           bullets.push({ x: player.x, y: player.y - 20, w: 4, h: 8, vy: -9, vx: -2, color: '#facc15', damage: 1 });
                           bullets.push({ x: player.x, y: player.y - 20, w: 4, h: 8, vy: -9, vx: 2, color: '#facc15', damage: 1 });
                       }
                  }

                  // Update Bullets
                  for (let i = bullets.length - 1; i >= 0; i--) {
                      let b = bullets[i];
                      b.y += b.vy;
                      if (b.vx) b.x += b.vx;
                      
                      // Draw Bullet
                      ctx.fillStyle = b.color;
                      ctx.fillRect(b.x - b.w/2, b.y, b.w, b.h);

                      if (b.y < -50 || b.y > canvas.height + 50) {
                          bullets.splice(i, 1);
                          continue;
                      }

                      // Collision with Enemies
                      if (!b.enemyBullet) {
                          for (let j = enemies.length - 1; j >= 0; j--) {
                              let e = enemies[j];
                              if (Math.abs(b.x - (e.x + e.w/2)) < e.w/2 && Math.abs(b.y - (e.y + e.h/2)) < e.h/2) {
                                  e.hp -= b.damage;
                                  particles.push({x: b.x, y: b.y, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5, life: 10, color: '#fff'});
                                  bullets.splice(i, 1);
                                  
                                  if (e.hp <= 0) {
                                      playSound('explosion');
                                      spawnPowerup(e.x + e.w/2, e.y + e.h/2);
                                      setScore(prev => prev + (e.type === 'heavy' ? 50 : 10));
                                      addCoins(1); // 1 coin per kill
                                      enemies.splice(j, 1);
                                      // Explosion particles
                                      for(let k=0; k<10; k++) particles.push({x: e.x+e.w/2, y: e.y+e.h/2, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, life: 20, color: '#f87171'});
                                  }
                                  break;
                              }
                          }
                          // Collision with Boss
                          if (boss && boss.phase === 'fight') {
                              if (Math.abs(b.x - (boss.x + boss.w/2)) < boss.w/2 && Math.abs(b.y - (boss.y + boss.h/2)) < boss.h/2) {
                                  boss.hp -= b.damage;
                                  playSound('boss_hit');
                                  bullets.splice(i, 1);
                                  if (boss.hp <= 0) {
                                      playSound('explosion');
                                      // Big explosion
                                      for(let k=0; k<50; k++) particles.push({x: boss.x+boss.w/2, y: boss.y+boss.h/2, vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15, life: 60, color: '#facc15'});
                                      setScore(prev => prev + 1000);
                                      addCoins(50); // Boss Bounty
                                      spawnPowerup(boss.x + boss.w/2, boss.y + boss.h/2);
                                      boss = null;
                                  }
                              }
                          }
                      } else {
                           // Enemy Bullet hits Player
                           if (Math.abs(b.x - player.x) < player.w/3 && Math.abs(b.y - player.y) < player.h/3) {
                               player.hp -= 10;
                               setHp(player.hp);
                               bullets.splice(i, 1);
                               playSound('explosion');
                               for(let k=0; k<5; k++) particles.push({x: player.x, y: player.y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, life: 20, color: '#0ea5e9'});
                           }
                      }
                  }

                  // Boss Logic
                  if (boss) {
                      if (boss.phase === 'enter') {
                          boss.y += 1;
                          if (boss.y >= 50) boss.phase = 'fight';
                      } else {
                          boss.x += boss.dx;
                          if (boss.x <= 0 || boss.x + boss.w >= canvas.width) boss.dx *= -1;
                          
                          // Boss Shoot
                          if (Math.random() < 0.05) {
                              bullets.push({ x: boss.x + boss.w/2, y: boss.y + boss.h, w: 8, h: 8, vy: 5, color: '#ef4444', enemyBullet: true });
                              bullets.push({ x: boss.x + boss.w/2, y: boss.y + boss.h, w: 8, h: 8, vy: 4, vx: -2, color: '#ef4444', enemyBullet: true });
                              bullets.push({ x: boss.x + boss.w/2, y: boss.y + boss.h, w: 8, h: 8, vy: 4, vx: 2, color: '#ef4444', enemyBullet: true });
                          }
                      }
                      
                      // Draw Boss
                      if(enemySprites.boss.complete) ctx.drawImage(enemySprites.boss, boss.x, boss.y, boss.w, boss.h);
                      else { ctx.fillStyle = 'red'; ctx.fillRect(boss.x, boss.y, boss.w, boss.h); }
                      
                      // Boss HP Bar
                      ctx.fillStyle = 'black'; ctx.fillRect(boss.x, boss.y - 10, boss.w, 5);
                      ctx.fillStyle = 'red'; ctx.fillRect(boss.x, boss.y - 10, boss.w * (boss.hp / boss.maxHp), 5);
                  } else {
                      // Spawn Boss check
                      if (score > 0 && score % 2000 === 0 && score > (wave * 2000)) {
                          setWave(prev => prev + 1);
                          spawnBoss();
                      }
                      spawnEnemy();
                  }

                  // Update Enemies
                  for (let i = enemies.length - 1; i >= 0; i--) {
                      let e = enemies[i];
                      e.y += e.speed;
                      e.x += e.vx;
                      
                      // Kamikaze tracking
                      if (e.type === 'kamikaze') {
                          if (player.x > e.x) e.x += 1; else e.x -= 1;
                      }

                      // Enemy Shoot
                      if (e.type === 'heavy' && Math.random() < 0.02) {
                           bullets.push({ x: e.x + e.w/2, y: e.y + e.h, w: 6, h: 6, vy: 4, color: '#f87171', enemyBullet: true });
                      }

                      // Draw Enemy
                      let sprite = enemySprites.basic;
                      if(e.type === 'kamikaze') sprite = enemySprites.kamikaze;
                      if(e.type === 'heavy') sprite = enemySprites.heavy;
                      
                      if(sprite.complete) ctx.drawImage(sprite, e.x, e.y, e.w, e.h);
                      else { ctx.fillStyle = 'red'; ctx.fillRect(e.x, e.y, e.w, e.h); }

                      // Collision with Player
                      if (Math.abs(e.x - player.x) < (player.w + e.w)/3 && Math.abs(e.y - player.y) < (player.h + e.h)/3) {
                           player.hp -= 20;
                           setHp(player.hp);
                           enemies.splice(i, 1);
                           playSound('explosion');
                      }

                      if (e.y > canvas.height) enemies.splice(i, 1);
                  }

                  // Update Powerups
                  for (let i = powerups.length - 1; i >= 0; i--) {
                      let p = powerups[i];
                      p.y += 2;
                      
                      ctx.beginPath();
                      ctx.arc(p.x, p.y, 10, 0, Math.PI * 2);
                      ctx.fillStyle = p.type === 'weapon' ? '#fbbf24' : '#22c55e';
                      ctx.fill();
                      ctx.strokeStyle = 'white';
                      ctx.stroke();
                      
                      // Collision with Player
                      if (Math.abs(p.x - player.x) < 30 && Math.abs(p.y - player.y) < 30) {
                          if (p.type === 'weapon') {
                              player.weapon = Math.min(3, player.weapon + 1);
                              setWeaponLevel(player.weapon);
                          } else {
                              player.hp = Math.min(player.maxHp, player.hp + 30);
                              setHp(player.hp);
                          }
                          playSound('powerup');
                          powerups.splice(i, 1);
                      }
                      if (p.y > canvas.height) powerups.splice(i, 1);
                  }

                  // Draw Player
                  ctx.save();
                  ctx.translate(player.x, player.y);
                  // Basic tilt effect
                  if(touchX !== null) {
                       const tilt = (touchX - player.x) * 0.1;
                       ctx.rotate(tilt * Math.PI / 180);
                  }
                  if(playerSprite.complete) ctx.drawImage(playerSprite, -20, -20, 40, 40);
                  else { ctx.fillStyle = 'blue'; ctx.fillRect(-20, -20, 40, 40); }
                  ctx.restore();

                  // Particles
                  for (let i = particles.length - 1; i >= 0; i--) {
                      let p = particles[i];
                      p.x += p.vx; p.y += p.vy; p.life--;
                      ctx.fillStyle = p.color;
                      ctx.globalAlpha = p.life / 20;
                      ctx.fillRect(p.x, p.y, 2, 2);
                      ctx.globalAlpha = 1.0;
                      if (p.life <= 0) particles.splice(i, 1);
                  }

                  // Game Over Check
                  if (player.hp <= 0) {
                      setGameState('gameover');
                      cancelAnimationFrame(animationFrameId);
                      return;
                  }

                  animationFrameId = requestAnimationFrame(loop);
              };
              
              const handleTouchMove = (e) => {
                  e.preventDefault();
                  const rect = canvas.getBoundingClientRect();
                  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                  touchX = (clientX - rect.left) * (canvas.width / rect.width);
                  isTouching = true;
              };

              const handleTouchEnd = () => { isTouching = false; touchX = null; };

              canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
              canvas.addEventListener('touchend', handleTouchEnd);
              canvas.addEventListener('mousemove', handleTouchMove);
              canvas.addEventListener('mouseup', handleTouchEnd);
              
              animationFrameId = requestAnimationFrame(loop);

              return () => {
                  cancelAnimationFrame(animationFrameId);
                  canvas.removeEventListener('touchmove', handleTouchMove);
                  canvas.removeEventListener('touchend', handleTouchEnd);
                  canvas.removeEventListener('mousemove', handleTouchMove);
                  canvas.removeEventListener('mouseup', handleTouchEnd);
              };
          }, [gameState, equippedShipId, wave]); // Re-init on reset

          const restartGame = (withAd) => {
              if (withAd) triggerAd();
              setGameState('playing');
              setScore(0);
              setHp(100);
              setWave(1);
              setWeaponLevel(1);
          };

          return (
              <div className="fixed inset-0 bg-black z-50 flex flex-col">
                  {/* HUD */}
                  <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-start pointer-events-none z-10">
                      <div className="flex flex-col gap-1">
                          <div className="text-yellow-400 font-bold text-xl drop-shadow-md">SCORE: {score}</div>
                          <div className="text-gray-400 text-xs">WAVE {wave}</div>
                      </div>
                      <div className="flex flex-col items-end gap-2">
                          <button onClick={onBack} className="pointer-events-auto bg-white/10 p-2 rounded-full text-white backdrop-blur-md"><X size={20}/></button>
                          <div className="w-32 h-4 bg-gray-800 rounded-full border border-gray-600 overflow-hidden relative">
                              <div className="h-full bg-red-500 transition-all duration-300" style={{width: `${hp}%`}}></div>
                              <div className="absolute inset-0 flex items-center justify-center text-[10px] font-bold">HP {Math.floor(hp)}%</div>
                          </div>
                          <div className="flex gap-1">
                              {[1,2,3].map(l => (
                                  <div key={l} className={`w-2 h-2 rounded-full ${weaponLevel >= l ? 'bg-blue-400' : 'bg-gray-700'}`}></div>
                              ))}
                          </div>
                      </div>
                  </div>

                  <canvas 
                      ref={canvasRef} 
                      width={400} 
                      height={800} 
                      className="w-full h-full object-cover touch-none"
                  />
                  
                  {gameState === 'gameover' && (
                      <div className="absolute inset-0 bg-black/80 flex flex-col items-center justify-center gap-6 z-20 animate-fade-in p-6 text-center">
                          <Skull size={64} className="text-red-500 mb-4 animate-pulse" />
                          <h2 className="text-4xl font-bold text-white tracking-widest text-red-500">MISSION FAILED</h2>
                          <p className="text-2xl text-yellow-400">FINAL SCORE: {score}</p>
                          <div className="flex flex-col w-full max-w-xs gap-3">
                              <button onClick={() => restartGame(true)} className="bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-green-500/20">
                                  <RefreshCcw /> RESTART MISSION
                              </button>
                              <button onClick={onBack} className="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl">
                                  RETURN TO BASE
                              </button>
                          </div>
                      </div>
                  )}
              </div>
          );
      };

      // --- COMPONENT: Modal ---
      const Modal = ({ title, onClose, children }) => (
          <div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
              <div className="bg-slate-800 w-full max-w-sm rounded-2xl border-2 border-slate-600 shadow-2xl overflow-hidden flex flex-col max-h-[80%]" onClick={e => e.stopPropagation()}>
                  <div className="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
                      <h2 className="text-xl font-bold text-white">{title}</h2>
                      <button onClick={onClose}><X className="text-gray-400 hover:text-white" /></button>
                  </div>
                  <div className="p-4 overflow-y-auto flex-1">{children}</div>
              </div>
          </div>
      );

      // --- COMPONENT: ShipCard ---
      const ShipCard = ({ ship, unlockedShips, equippedShip, adProgress, handleShipAdWatch, equipShip }) => {
          const isUnlocked = unlockedShips.includes(ship.id);
          const isEquipped = equippedShip === ship.id;
          const spriteUrl = useMemo(() => generatePlayerSprite(ship.palette).src, [ship]);
          const currentAds = adProgress[ship.id] || 0;
          const reqAds = ship.adCost;

          const handleAction = () => {
              if (isUnlocked) {
                  equipShip(ship.id);
                  playSound('powerup');
              } else {
                  handleShipAdWatch(ship.id, reqAds);
                  playSound('buy');
              }
          };

          return (
              <div className={`glass-box relative rounded-xl p-4 flex flex-col items-center gap-3 transition-transform ${isEquipped ? 'border-green-500 border-2 shadow-[0_0_15px_rgba(34,197,94,0.5)]' : ''}`}>
                  <div className="text-sm font-bold text-gray-300">{ship.name}</div>
                  <div className="w-16 h-16 bg-black/50 rounded-lg flex items-center justify-center relative overflow-hidden">
                       <img src={spriteUrl} className="w-12 h-12 rendering-pixelated" alt={ship.name} />
                       {!isUnlocked && (
                           <div className="absolute inset-0 bg-black/60 flex items-center justify-center">
                               <Lock size={20} className="text-gray-400" />
                           </div>
                       )}
                  </div>
                  
                  {isUnlocked ? (
                      <button 
                          onClick={handleAction}
                          disabled={isEquipped}
                          className={`w-full py-2 rounded font-bold text-xs flex items-center justify-center gap-1
                              ${isEquipped ? 'bg-green-600/50 text-white cursor-default' : 'bg-blue-600 hover:bg-blue-500 text-white'}`}
                      >
                          {isEquipped ? <><Check size={12} /> EQUIPPED</> : 'SELECT'}
                      </button>
                  ) : (
                      <div className="w-full flex flex-col gap-1">
                          <button 
                              onClick={handleAction}
                              className={`w-full py-2 rounded font-bold text-xs flex items-center justify-center gap-1 bg-yellow-600 hover:bg-yellow-500 text-white`}
                          >
                              <PlayCircle size={12} /> WATCH AD ({currentAds}/{reqAds})
                          </button>
                          <div className="w-full h-1 bg-gray-700 rounded-full overflow-hidden">
                              <div className="h-full bg-yellow-400" style={{ width: `${Math.min(100, (currentAds / reqAds) * 100)}%` }}></div>
                          </div>
                      </div>
                  )}
              </div>
          );
      };

      // --- COMPONENT: Galaxy Menu ---
      const GalaxyMenu = ({ onStart, onShop, onBack, coins }) => {
          return (
              <div className="w-full h-full flex flex-col items-center justify-center relative bg-black/95">
                   <div className="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-transparent pointer-events-none" />
                   
                   <div className="z-10 flex flex-col items-center gap-6 w-full max-w-md px-4 animate-fade-in">
                       <div className="relative">
                          <Rocket size={80} className="text-blue-500 drop-shadow-[0_0_20px_rgba(59,130,246,0.5)]" />
                          <div className="absolute -inset-4 bg-blue-500/20 blur-xl rounded-full"></div>
                       </div>
                       
                       <h1 className="text-4xl md:text-5xl font-bold text-center text-white mb-2 neon-title tracking-widest leading-tight">
                          GALAXY<br/><span className="text-blue-400">INVADER</span>
                       </h1>
                       
                       <div className="flex items-center gap-2 bg-gray-900/80 px-4 py-2 rounded-full border border-yellow-600 shadow-[0_0_10px_rgba(234,179,8,0.2)]">
                            <Coins size={20} className="text-yellow-400" />
                            <span className="font-bold text-xl text-yellow-400">{coins}</span>
                       </div>

                       <div className="w-full grid gap-4 mt-8">
                           <button onClick={onStart} className="glass-box group relative w-full h-24 rounded-xl overflow-hidden border-blue-500/30 hover:border-blue-500 transition-all transform hover:scale-105">
                                <div className="absolute inset-0 bg-blue-600/10 group-hover:bg-blue-600/20 transition"></div>
                                <div className="relative z-10 flex items-center justify-center gap-3 h-full text-white">
                                    <span className="text-2xl font-bold tracking-wider">START MISSION</span>
                                    <ChevronLeft className="rotate-180" size={24} />
                                </div>
                           </button>
                           
                           <button onClick={onShop} className="glass-box group relative w-full h-20 rounded-xl overflow-hidden border-yellow-500/30 hover:border-yellow-500 transition-all transform hover:scale-105">
                                <div className="absolute inset-0 bg-yellow-600/10 group-hover:bg-yellow-600/20 transition"></div>
                                <div className="relative z-10 flex items-center justify-center gap-3 h-full text-yellow-400">
                                    <ShoppingCart size={24} />
                                    <span className="text-xl font-bold tracking-wider">HANGAR SHOP</span>
                                </div>
                           </button>
                       </div>

                       <button onClick={onBack} className="mt-8 flex items-center gap-2 text-gray-500 hover:text-white transition uppercase text-sm font-bold tracking-widest px-4 py-2 hover:bg-white/5 rounded-full">
                          <ChevronLeft size={16} /> Back to Hub
                       </button>
                   </div>
                   
                   <button onClick={toggleFullScreen} className="absolute top-6 right-6 p-3 bg-white/10 hover:bg-white/20 rounded-full transition text-gray-400 hover:text-white"><Maximize size={24}/></button>
              </div>
          );
      };

      // --- COMPONENT: Shop Screen ---
      const ShopScreen = ({ adProgress, handleShipAdWatch, equipShip, unlockedShips, equippedShip, onBack }) => {
          return (
              <div className="w-full h-full bg-[#050505] flex flex-col">
                   <div className="p-4 flex items-center justify-between bg-black/50 backdrop-blur border-b border-gray-800">
                      <button onClick={onBack} className="p-2 rounded-full hover:bg-white/10"><ChevronLeft /></button>
                      <h1 className="text-xl font-bold neon-title">HANGAR SHOP</h1>
                      <div className="w-10"></div>
                   </div>
                   
                   <div className="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-3 gap-4 pb-20">
                       {SHIPS.map(ship => (
                           <ShipCard 
                              key={ship.id} 
                              ship={ship} 
                              unlockedShips={unlockedShips} 
                              equippedShip={equippedShip} 
                              adProgress={adProgress}
                              handleShipAdWatch={handleShipAdWatch}
                              equipShip={equipShip}
                           />
                       ))}
                   </div>
              </div>
          );
      };

      // --- Farm Game ("Fazendinha") ---
      const FarmGame = ({ onBack, triggerAd, addCoins, coins }) => {
          const CROPS = {
              'wheat': { id: 'wheat', name: 'Trigo', cost: 0, reward: 5, time: 5000, icon: 'üåæ', color: '#fef08a', adCost: 0 },
              'corn': { id: 'corn', name: 'Milho', cost: 10, reward: 25, time: 10000, icon: 'üåΩ', color: '#facc15', adCost: 0 },
              'carrot': { id: 'carrot', name: 'Cenoura', cost: 30, reward: 70, time: 20000, icon: 'ü•ï', color: '#fb923c', adCost: 1 },
              'tomato': { id: 'tomato', name: 'Tomate', cost: 80, reward: 180, time: 45000, icon: 'üçÖ', color: '#f87171', adCost: 2 },
              'strawberry': { id: 'strawberry', name: 'Morango', cost: 150, reward: 350, time: 90000, icon: 'üçì', color: '#fca5a5', adCost: 3 },
              'grape': { id: 'grape', name: 'Uva', cost: 300, reward: 800, time: 180000, icon: 'üçá', color: '#c084fc', adCost: 5 },
              'pineapple': { id: 'pineapple', name: 'Abacaxi', cost: 600, reward: 1600, time: 300000, icon: 'üçç', color: '#fde047', adCost: 8 },
              'watermelon': { id: 'watermelon', name: 'Melancia', cost: 1200, reward: 3500, time: 600000, icon: 'üçâ', color: '#86efac', adCost: 12 },
              'pumpkin': { id: 'pumpkin', name: 'Ab√≥bora', cost: 2500, reward: 8000, time: 1200000, icon: 'üéÉ', color: '#fdba74', adCost: 15 },
          };

          const LAND_LEVELS = [
              { count: 4, adCost: 0 },
              { count: 6, adCost: 5 },
              { count: 8, adCost: 10 },
              { count: 12, adCost: 15 }
          ];

          const MERCHANT_QUOTES = [
              "Hoje o dia est√° √≥timo para plantar!",
              "Ouvi dizer que morangos d√£o muito lucro.",
              "Precisa de moedas? Continue colhendo!",
              "O segredo √© ter paci√™ncia... e adubo!",
              "Eu compraria suas ab√≥boras por um bom pre√ßo.",
              "Quer expandir? Junte moedas!"
          ];

          const MISSION_TEMPLATES = [
              { type: 'plant', target: 'any', count: 5, desc: 'Plante 5 Sementes', reward: 20 },
              { type: 'harvest', target: 'wheat', count: 5, desc: 'Colha 5 Trigos', reward: 30 },
              { type: 'harvest', target: 'corn', count: 3, desc: 'Colha 3 Milhos', reward: 50 },
              { type: 'harvest', target: 'strawberry', count: 2, desc: 'Colha 2 Morangos', reward: 100 },
              { type: 'earn', count: 50, desc: 'Lucre 50 Moedas', reward: 20 },
              { type: 'earn', count: 200, desc: 'Lucre 200 Moedas', reward: 50 }
          ];

          // States
          const [activeModal, setActiveModal] = useState(null); // 'shop', 'missions', 'expand', null
          const [landLevel, setLandLevel] = useState(() => {
              try {
                  const saved = safeStorage.getItem('farm_land_level');
                  return saved ? parseInt(saved) : 0;
              } catch(e) { return 0; }
          });
          const [grid, setGrid] = useState(() => {
              try {
                  const saved = safeStorage.getItem('farm_grid');
                  return saved ? JSON.parse(saved) : [];
              } catch(e) { return []; }
          });
          const [missions, setMissions] = useState(() => {
              try {
                  const saved = safeStorage.getItem('farm_missions');
                  return saved ? JSON.parse(saved) : [];
              } catch(e) { return []; }
          });
          const [unlockedCrops, setUnlockedCrops] = useState(() => {
              try {
                  const saved = safeStorage.getItem('farm_unlocked_crops');
                  return saved ? JSON.parse(saved) : ['wheat', 'corn'];
              } catch(e) { return ['wheat', 'corn']; }
          });
          const [cropAdProgress, setCropAdProgress] = useState(() => {
              try {
                  const saved = safeStorage.getItem('farm_crop_ad_progress');
                  return saved ? JSON.parse(saved) : {};
              } catch(e) { return {}; }
          });
          const [landAdProgress, setLandAdProgress] = useState(() => {
              try {
                  const saved = safeStorage.getItem('farm_land_ad_progress');
                  return saved ? parseInt(saved) : 0;
              } catch(e) { return 0; }
          });
          const [fertilizerAdProgress, setFertilizerAdProgress] = useState(() => {
              try {
                  const saved = safeStorage.getItem('farm_fertilizer_ad_progress');
                  return saved ? parseInt(saved) : 0;
              } catch(e) { return 0; }
          });

          const [selectedCrop, setSelectedCrop] = useState('wheat');
          const [now, setNow] = useState(Date.now());
          const [farmerPos, setFarmerPos] = useState({ col: 1, row: 1 });
          const [merchantQuote, setMerchantQuote] = useState("");
          const [showQuote, setShowQuote] = useState(false);

          // Logic
          const generateMissions = useCallback(() => {
              const newMissions = [];
              for(let i=0; i<3; i++) {
                  const template = MISSION_TEMPLATES[Math.floor(Math.random() * MISSION_TEMPLATES.length)];
                  newMissions.push({ id: Date.now() + i, ...template, progress: 0, completed: false });
              }
              setMissions(newMissions);
          }, []);

          useEffect(() => { if (missions.length === 0) generateMissions(); }, [missions, generateMissions]);
          useEffect(() => { safeStorage.setItem('farm_missions', JSON.stringify(missions)); }, [missions]);
          useEffect(() => { safeStorage.setItem('farm_land_level', landLevel); }, [landLevel]);
          useEffect(() => { if (grid.length > 0) safeStorage.setItem('farm_grid', JSON.stringify(grid)); }, [grid]);
          useEffect(() => { safeStorage.setItem('farm_unlocked_crops', JSON.stringify(unlockedCrops)); }, [unlockedCrops]);
          useEffect(() => { safeStorage.setItem('farm_crop_ad_progress', JSON.stringify(cropAdProgress)); }, [cropAdProgress]);
          useEffect(() => { safeStorage.setItem('farm_land_ad_progress', landAdProgress); }, [landAdProgress]);
          useEffect(() => { safeStorage.setItem('farm_fertilizer_ad_progress', fertilizerAdProgress); }, [fertilizerAdProgress]);
          
          useEffect(() => { const interval = setInterval(() => setNow(Date.now()), 1000); return () => clearInterval(interval); }, []);

          // Initialize Grid
          useEffect(() => {
              const targetCount = LAND_LEVELS[landLevel].count;
              setGrid(prev => {
                  if (prev.length === targetCount) return prev;
                  if (prev.length < targetCount) {
                      const newGrid = [...prev];
                      while(newGrid.length < targetCount) newGrid.push({ id: newGrid.length, crop: null, plantedAt: null });
                      return newGrid;
                  }
                  return prev.slice(0, targetCount); 
              });
          }, [landLevel]);

          const updateMissionProgress = (type, amount, targetId = null) => {
              setMissions(prev => prev.map(m => {
                  if (m.completed) return m;
                  let match = false;
                  if (m.type === type) {
                      if (m.target === 'any' || !m.target) match = true;
                      else if (m.target === targetId) match = true;
                  }
                  if (match) return { ...m, progress: Math.min(m.goal || m.count, m.progress + amount) };
                  return m;
              }));
          };

          const claimMission = (id) => {
              const mission = missions.find(m => m.id === id);
              if (mission && !mission.completed && mission.progress >= mission.count) {
                  addCoins(mission.reward);
                  playSound('powerup');
                  const newMissions = missions.map(m => m.id === id ? { ...m, completed: true } : m);
                  setMissions(newMissions);
                  if (newMissions.every(m => m.completed)) {
                      setTimeout(() => { generateMissions(); playSound('1up'); }, 1000);
                  }
              }
          };

          const handlePlotClick = (plot, index) => {
              const cols = grid.length < 6 ? 2 : 3;
              const col = (index % cols) + 1;
              const row = Math.floor(index / cols) + 1;
              setFarmerPos({ col, row });

              if (plot.crop) {
                  const cropDef = CROPS[plot.crop];
                  // Safe check if crop exists (legacy save compat)
                  if (!cropDef) {
                      setGrid(prev => prev.map(p => p.id === plot.id ? { ...p, crop: null, plantedAt: null } : p));
                      return;
                  }

                  const progress = Math.min(100, ((now - plot.plantedAt) / cropDef.time) * 100);
                  if (progress >= 100) {
                      playSound('harvest');
                      addCoins(cropDef.reward);
                      updateMissionProgress('harvest', 1, plot.crop);
                      updateMissionProgress('earn', cropDef.reward);
                      setGrid(prev => prev.map(p => p.id === plot.id ? { ...p, crop: null, plantedAt: null } : p));
                  } else { playSound('wrong'); }
              } else {
                  if (selectedCrop && unlockedCrops.includes(selectedCrop)) {
                      const cropDef = CROPS[selectedCrop];
                      if (coins >= cropDef.cost) {
                          playSound('plant');
                          addCoins(-cropDef.cost);
                          updateMissionProgress('plant', 1, selectedCrop);
                          setGrid(prev => prev.map(p => p.id === plot.id ? { ...p, crop: selectedCrop, plantedAt: Date.now() } : p));
                      } else { playSound('wrong'); }
                  }
              }
          };

          const handleFertilizer = () => {
              window.open('https://otieu.com/4/10270523', '_blank');
              const next = fertilizerAdProgress + 1;
              setFertilizerAdProgress(next);
              
              if (next >= 2) {
                  setGrid(prev => prev.map(p => p.crop ? { ...p, plantedAt: Date.now() - (CROPS[p.crop] ? CROPS[p.crop].time : 0) } : p));
                  playSound('powerup');
                  setFertilizerAdProgress(0); // Reset after use
              } else {
                  playSound('buy'); // Progress sound
              }
          };

          const handleExpand = () => {
              const nextLevelIndex = landLevel + 1;
              if (nextLevelIndex < LAND_LEVELS.length) {
                  const reqAds = LAND_LEVELS[nextLevelIndex].adCost;
                  
                  window.open('https://otieu.com/4/10270523', '_blank');
                  const next = landAdProgress + 1;
                  setLandAdProgress(next);
                  
                  if (next >= reqAds) {
                      setLandLevel(nextLevelIndex);
                      setLandAdProgress(0); // Reset for next level
                      playSound('buy');
                      setActiveModal(null);
                  } else {
                      playSound('buy');
                  }
              }
          };

          const handleCropAdWatch = (cropId, reqAds) => {
              window.open('https://otieu.com/4/10270523', '_blank');
              const current = cropAdProgress[cropId] || 0;
              const next = current + 1;
              setCropAdProgress(prev => ({...prev, [cropId]: next}));
              
              if (next >= reqAds) {
                  if (!unlockedCrops.includes(cropId)) {
                      setUnlockedCrops(prev => [...prev, cropId]);
                      playSound('powerup');
                  }
              }
          };

          const handleMerchantClick = () => {
              const randomQuote = MERCHANT_QUOTES[Math.floor(Math.random() * MERCHANT_QUOTES.length)];
              setMerchantQuote(randomQuote);
              setShowQuote(true);
              playSound('talk');
              setTimeout(() => setShowQuote(false), 4000);
          };

          const gridColsClass = grid.length < 6 ? 'grid-cols-2' : 'grid-cols-3';
          const nextLand = landLevel < LAND_LEVELS.length - 1 ? LAND_LEVELS[landLevel + 1] : null;

          return (
              <div className="w-full h-full flex flex-col bg-green-900 text-white relative overflow-hidden">
                  {/* Header */}
                  <div className="w-full p-4 flex items-center justify-between bg-black/50 backdrop-blur-md border-b border-green-800 z-10 absolute top-0 left-0 right-0">
                      <button onClick={onBack} className="p-2 rounded-full hover:bg-white/10 transition"><ChevronLeft /></button>
                      <div className="flex flex-col items-center">
                          <h1 className="text-xl font-bold text-green-300 drop-shadow-md flex items-center gap-2"><Sprout /> FAZENDINHA</h1>
                          {selectedCrop && (
                              <div className="text-xs text-green-200 bg-black/30 px-2 py-0.5 rounded-full flex items-center gap-1">
                                  Plantando: {CROPS[selectedCrop].icon} {CROPS[selectedCrop].name}
                              </div>
                          )}
                      </div>
                      <div className="flex items-center gap-2 bg-yellow-600/20 px-3 py-1 rounded-full border border-yellow-500/50">
                          <Coins size={16} className="text-yellow-400" />
                          <span className="font-bold text-yellow-400">{coins}</span>
                      </div>
                  </div>

                  {/* Main Game Area - Centered Grid */}
                  <div className="flex-1 w-full flex items-center justify-center p-6 relative">
                      <div className={`grid ${gridColsClass} gap-4 bg-green-800/50 p-6 rounded-2xl border-4 border-green-700 shadow-2xl relative transition-all duration-500`}>
                          {/* Merchant */}
                          <div className="absolute -bottom-10 -right-6 z-30 flex flex-col items-end pointer-events-auto">
                              {showQuote && (
                                  <div className="bg-white text-black p-2 rounded-lg rounded-br-none mb-2 shadow-lg text-xs font-bold max-w-[120px] animate-fade-in relative border-2 border-gray-300">
                                      {merchantQuote}
                                      <div className="absolute -bottom-2 right-4 w-0 h-0 border-l-8 border-l-transparent border-t-[10px] border-t-white border-r-0"></div>
                                  </div>
                              )}
                              <button onClick={handleMerchantClick} className="text-5xl filter drop-shadow-xl hover:scale-110 transition-transform active:scale-95">üßë‚Äçüíº</button>
                          </div>

                          {/* Farmer */}
                          <div className="absolute w-20 h-20 pointer-events-none transition-all duration-700 z-20 flex items-center justify-center text-5xl filter drop-shadow-lg" style={{ gridColumn: farmerPos.col, gridRow: farmerPos.row }}>üë®‚Äçüåæ</div>

                          {/* Plots */}
                          {grid.map((plot, index) => {
                              const cropDef = plot.crop ? CROPS[plot.crop] : null;
                              // Safety check
                              if (plot.crop && !cropDef) return null;

                              const progress = cropDef ? Math.min(100, ((now - plot.plantedAt) / cropDef.time) * 100) : 0;
                              const isReady = progress >= 100;
                              return (
                                  <button key={plot.id} onClick={() => handlePlotClick(plot, index)} className={`w-20 h-20 md:w-24 md:h-24 rounded-xl flex flex-col items-center justify-center relative transition-all transform active:scale-95 ${plot.crop ? (isReady ? 'bg-amber-200 border-yellow-400 animate-bounce' : 'bg-amber-700 border-amber-800') : 'bg-green-700 border-green-600 hover:bg-green-600'} border-b-4`}>
                                      {plot.crop ? (
                                          <>
                                              <div className="text-3xl md:text-4xl drop-shadow-md">{cropDef.icon}</div>
                                              {!isReady && (
                                                  <div className="absolute bottom-1 left-1 right-1 h-1.5 bg-black/30 rounded-full overflow-hidden">
                                                      <div className="h-full bg-green-400 transition-all duration-1000" style={{ width: `${progress}%` }}></div>
                                                  </div>
                                              )}
                                          </>
                                      ) : <div className="w-4 h-4 bg-green-900/30 rounded-full"></div>}
                                  </button>
                              );
                          })}
                      </div>
                  </div>

                  {/* Bottom Dock Menu */}
                  <div className="w-full bg-slate-900 border-t border-slate-700 p-2 safe-area-bottom z-40">
                      <div className="max-w-md mx-auto flex justify-around items-center">
                          <button onClick={() => setActiveModal('shop')} className="flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-green-400 transition-colors active:scale-95">
                              <Store size={24} />
                              <span className="text-[10px] font-bold uppercase">Loja</span>
                          </button>
                          <button onClick={() => setActiveModal('missions')} className="flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-yellow-400 transition-colors active:scale-95 relative">
                              <ClipboardList size={24} />
                              <span className="text-[10px] font-bold uppercase">Miss√µes</span>
                              {missions.some(m => !m.completed && m.progress >= m.count) && (
                                  <div className="absolute top-1 right-2 w-3 h-3 bg-red-500 rounded-full border-2 border-slate-900 animate-pulse"></div>
                              )}
                          </button>
                          <button onClick={() => setActiveModal('expand')} className="flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-blue-400 transition-colors active:scale-95">
                              <Pickaxe size={24} />
                              <span className="text-[10px] font-bold uppercase">Expandir</span>
                          </button>
                          <button onClick={handleFertilizer} className="flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-purple-400 transition-colors active:scale-95 relative">
                              <Zap size={24} className="fill-current" />
                              <span className="text-[10px] font-bold uppercase">Adubo ({fertilizerAdProgress}/2)</span>
                              <div className="absolute -top-1 -right-1 bg-purple-600 text-white text-[9px] px-1 rounded-full border border-purple-400">ADS</div>
                          </button>
                      </div>
                  </div>

                  {/* Modals */}
                  {activeModal === 'shop' && (
                      <Modal title="Loja de Sementes" onClose={() => setActiveModal(null)}>
                          <div className="grid grid-cols-2 gap-3">
                              {Object.values(CROPS).map(crop => {
                                  const isUnlocked = unlockedCrops.includes(crop.id);
                                  const adsWatched = cropAdProgress[crop.id] || 0;
                                  
                                  return (
                                      <button 
                                          key={crop.id} 
                                          onClick={() => { 
                                              if(isUnlocked) {
                                                  setSelectedCrop(crop.id); 
                                                  setActiveModal(null); 
                                              } else {
                                                  handleCropAdWatch(crop.id, crop.adCost);
                                              }
                                          }} 
                                          className={`p-3 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${selectedCrop === crop.id && isUnlocked ? 'bg-green-600/30 border-green-500' : 'bg-black/30 border-slate-700 hover:border-slate-500'}`}
                                      >
                                          <div className="text-4xl">{crop.icon}</div>
                                          <div className="w-full text-center">
                                              <div className="font-bold text-sm">{crop.name}</div>
                                              
                                              {isUnlocked ? (
                                                  <div className={`flex items-center justify-center gap-1 text-xs font-bold mt-1 ${coins < crop.cost ? 'text-red-400' : 'text-yellow-400'}`}>
                                                      <Coins size={12} /> {crop.cost}
                                                  </div>
                                              ) : (
                                                  <div className="flex flex-col gap-1 w-full mt-1">
                                                       <div className="text-[10px] font-bold text-blue-400 bg-blue-900/50 px-2 py-1 rounded">
                                                           VER AD ({adsWatched}/{crop.adCost})
                                                       </div>
                                                       <div className="w-full bg-slate-800 h-1 rounded-full overflow-hidden">
                                                           <div className="bg-blue-500 h-full" style={{ width: `${Math.min(100, (adsWatched / crop.adCost) * 100)}%` }}></div>
                                                       </div>
                                                  </div>
                                              )}
                                          </div>
                                      </button>
                                  );
                              })}
                          </div>
                      </Modal>
                  )}

                  {activeModal === 'missions' && (
                      <Modal title="Miss√µes Di√°rias" onClose={() => setActiveModal(null)}>
                          <div className="flex flex-col gap-3">
                              {missions.map(mission => (
                                  <div key={mission.id} className="bg-slate-700/50 p-3 rounded-xl flex items-center justify-between gap-3 border border-slate-600">
                                      <div className="flex-1">
                                          <div className="text-sm font-bold text-gray-200">{mission.desc}</div>
                                          <div className="w-full bg-slate-900 h-2 rounded-full mt-1 overflow-hidden">
                                              <div className="h-full bg-green-500 transition-all duration-500" style={{ width: `${Math.min(100, (mission.progress / mission.count) * 100)}%` }}></div>
                                          </div>
                                          <div className="text-xs text-gray-400 mt-1">{mission.progress} / {mission.count}</div>
                                      </div>
                                      {mission.completed ? (
                                          <div className="text-green-400 font-bold text-xs flex flex-col items-center"><CheckCircle size={20} /><span>FEITO</span></div>
                                      ) : (
                                          mission.progress >= mission.count ? (
                                              <button onClick={() => claimMission(mission.id)} className="bg-yellow-500 hover:bg-yellow-400 text-black font-bold px-3 py-1 rounded-lg text-xs animate-bounce">COLETAR<br/>+{mission.reward} üí∞</button>
                                          ) : <div className="text-xs font-bold text-yellow-500/50 border border-yellow-500/20 px-2 py-1 rounded">+{mission.reward} üí∞</div>
                                      )}
                                  </div>
                              ))}
                          </div>
                      </Modal>
                  )}

                  {activeModal === 'expand' && (
                      <Modal title="Expandir Terreno" onClose={() => setActiveModal(null)}>
                          {nextLand ? (
                              <div className="flex flex-col items-center gap-6 py-4">
                                  <div className="text-6xl animate-bounce">üöú</div>
                                  <div className="text-center">
                                      <p className="text-gray-300">Aumente sua fazenda para</p>
                                      <p className="text-2xl font-bold text-green-400">{nextLand.count} Blocos</p>
                                  </div>
                                  
                                  <div className="w-full flex flex-col gap-2">
                                      <button onClick={handleExpand} className="w-full py-4 rounded-xl font-bold flex flex-col items-center justify-center gap-1 transition-all bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-500/30">
                                          <span className="text-lg">EXPANDIR (VER AD)</span>
                                          <div className="flex items-center gap-1 text-sm"><PlayCircle size={14} /> {landAdProgress}/{nextLand.adCost}</div>
                                      </button>
                                      <div className="w-full bg-slate-800 h-2 rounded-full overflow-hidden border border-slate-600">
                                          <div className="h-full bg-blue-400 transition-all duration-500" style={{ width: `${Math.min(100, (landAdProgress / nextLand.adCost) * 100)}%` }}></div>
                                      </div>
                                  </div>
                              </div>
                          ) : (
                              <div className="text-center py-10 text-gray-400">
                                  <div className="text-4xl mb-4">üèÜ</div>
                                  <p>Voc√™ atingiu o tamanho m√°ximo da fazenda!</p>
                              </div>
                          )}
                      </Modal>
                  )}
              </div>
          );
      };

      // --- Main App ---
      const App = () => {
          const [currentScreen, setCurrentScreen] = useState('home');
          const [lastAdTime, setLastAdTime] = useState(0);
          
          // Persistence State - with Error Handling
          const [coins, setCoins] = useState(() => {
              try {
                const saved = safeStorage.getItem('galaxy_coins');
                const val = parseInt(saved);
                return !isNaN(val) ? val : 0;
              } catch(e) { return 0; }
          });
          const [unlockedShips, setUnlockedShips] = useState(() => {
              try {
                  const saved = safeStorage.getItem('galaxy_unlocked');
                  return saved ? JSON.parse(saved) : ['starter'];
              } catch(e) { return ['starter']; }
          });
          const [equippedShip, setEquippedShip] = useState(() => {
              const saved = safeStorage.getItem('galaxy_equipped');
              return saved || 'starter';
          });
          const [adProgress, setAdProgress] = useState(() => {
              try {
                  const saved = safeStorage.getItem('galaxy_ad_progress');
                  return saved ? JSON.parse(saved) : {};
              } catch(e) { return {}; }
          });

          // Sync with LocalStorage
          useEffect(() => { safeStorage.setItem('galaxy_coins', coins); }, [coins]);
          useEffect(() => { safeStorage.setItem('galaxy_unlocked', JSON.stringify(unlockedShips)); }, [unlockedShips]);
          useEffect(() => { safeStorage.setItem('galaxy_equipped', equippedShip); }, [equippedShip]);
          useEffect(() => { safeStorage.setItem('galaxy_ad_progress', JSON.stringify(adProgress)); }, [adProgress]);

          const addCoins = (amount) => setCoins(prev => prev + amount);
          
          const handleShipAdWatch = (shipId, reqAds) => {
              window.open('https://otieu.com/4/10270523', '_blank');
              const current = adProgress[shipId] || 0;
              const next = current + 1;
              setAdProgress(prev => ({...prev, [shipId]: next}));
              
              if (next >= reqAds) {
                  if (!unlockedShips.includes(shipId)) {
                      setUnlockedShips(prev => [...prev, shipId]);
                      playSound('powerup'); // Unlock Sound
                  }
              }
          };

          const equipShip = (shipId) => {
              if (unlockedShips.includes(shipId)) {
                  setEquippedShip(shipId);
              }
          };

          // Strict 3-minute cooldown (180000ms)
          const triggerAd = useCallback((e) => {
             const now = Date.now();
             if (now - lastAdTime < 180000) {
                 if (e && e.stopPropagation) {
                   e.stopPropagation();
                   if(e.nativeEvent && e.nativeEvent.stopImmediatePropagation) e.nativeEvent.stopImmediatePropagation();
                 }
                 return;
             }
             setLastAdTime(now);
          }, [lastAdTime]);

          const startGame = (gameName, e) => { 
             triggerAd(e); 
             if (document.documentElement.requestFullscreen) {
                 document.documentElement.requestFullscreen().catch(() => {});
             }
             setCurrentScreen(gameName); 
          };

          const renderScreen = () => {
              switch(currentScreen) {
                  case 'shop': return (
                      <ShopScreen 
                          adProgress={adProgress}
                          handleShipAdWatch={handleShipAdWatch}
                          unlockedShips={unlockedShips}
                          equippedShip={equippedShip}
                          equipShip={equipShip}
                          onBack={() => setCurrentScreen('galaxy-menu')}
                      />
                  );
                  case 'galaxy-menu': return (
                      <GalaxyMenu 
                          onStart={(e) => {
                              // Direct Link Logic for Start Mission
                              const now = Date.now();
                              // Check 3 min cooldown
                              if (now - lastAdTime >= 180000) {
                                  // Open Direct Link
                                  window.open('https://otieu.com/4/10270523', '_blank');
                                  setLastAdTime(now);
                                  // Prevent global script if possible, or let it be. 
                                  // Stop propagation to prevent 'double' ad if user has global click script.
                                  if (e && e.stopPropagation) e.stopPropagation();
                              } else {
                                  // If cooldown active, stop global script too
                                  if (e && e.stopPropagation) e.stopPropagation();
                              }
                              if (document.documentElement.requestFullscreen) {
                                  document.documentElement.requestFullscreen().catch(() => {});
                              }
                              setCurrentScreen('galaxy-game');
                          }}
                          onShop={() => setCurrentScreen('shop')}
                          onBack={() => setCurrentScreen('home')}
                          coins={coins}
                      />
                  );
                  case 'galaxy-game': return (
                      <GalaxyInvader 
                          onBack={() => setCurrentScreen('galaxy-menu')} 
                          triggerAd={triggerAd} 
                          equippedShipId={equippedShip}
                          addCoins={addCoins}
                          currentCoins={coins}
                      />
                  );
                  case 'farm': return <FarmGame onBack={() => setCurrentScreen('home')} triggerAd={triggerAd} addCoins={addCoins} coins={coins} />;
                  case 'slither': return (
                      <div className="w-full h-full flex items-center justify-center bg-black text-white">
                          <div className="text-center">
                              <h1 className="text-2xl font-bold mb-4">Em Breve</h1>
                              <button onClick={() => setCurrentScreen('home')} className="bg-gray-700 px-4 py-2 rounded">Voltar</button>
                          </div>
                      </div>
                  );
                   case 'hangman': return (
                      <div className="w-full h-full flex items-center justify-center bg-black text-white">
                          <div className="text-center">
                              <h1 className="text-2xl font-bold mb-4">Em Breve</h1>
                              <button onClick={() => setCurrentScreen('home')} className="bg-gray-700 px-4 py-2 rounded">Voltar</button>
                          </div>
                      </div>
                  );
                  default: return (
                          <div className="w-full h-full flex flex-col items-center justify-center relative overflow-hidden">
                              <InstallButton />
                              <div className="z-10 flex flex-col items-center gap-8 w-full max-w-md px-4">
                                  <h1 className="text-5xl md:text-6xl font-bold text-center neon-title tracking-wider">JoGos<br/>Online</h1>
                                  
                                  <div className="flex items-center gap-2 bg-gray-900/80 px-4 py-2 rounded-full border border-yellow-600">
                                      <Coins size={20} className="text-yellow-400" />
                                      <span className="font-bold text-xl text-yellow-400">{coins}</span>
                                  </div>

                                  <div className="w-full grid gap-4 mt-8">
                                      <button onClick={() => setCurrentScreen('galaxy-menu')} className="glass-box group relative w-full h-24 rounded-xl overflow-hidden">
                                          <div className="relative z-10 flex items-center justify-between p-6 h-full text-white">
                                              <div className="flex flex-col items-start"><span className="text-xl font-bold text-white drop-shadow-md neon-text-small">GALAXY INVADER</span><span className="text-xs text-gray-400">Space Shooter</span></div>
                                              <Rocket size={32} className="text-purple-400" />
                                          </div>
                                      </button>
                                      <button onClick={(e) => startGame('slither', e)} className="glass-box group relative w-full h-24 rounded-xl overflow-hidden">
                                          <div className="relative z-10 flex items-center justify-between p-6 h-full text-white">
                                              <div className="flex flex-col items-start"><span className="text-xl font-bold text-white drop-shadow-md neon-text-small">NEON SLITHER</span><span className="text-xs text-gray-400">Snake IO</span></div>
                                              <Worm size={32} className="text-pink-400" />
                                          </div>
                                      </button>
                                      <button onClick={(e) => startGame('farm', e)} className="glass-box group relative w-full h-24 rounded-xl overflow-hidden">
                                          <div className="relative z-10 flex items-center justify-between p-6 h-full text-white">
                                              <div className="flex flex-col items-start"><span className="text-xl font-bold text-white drop-shadow-md neon-text-small">FAZENDINHA</span><span className="text-xs text-gray-400">Farm Idle</span></div>
                                              <Sprout size={32} className="text-green-400" />
                                          </div>
                                      </button>
                                      <button onClick={(e) => startGame('hangman', e)} className="glass-box group relative w-full h-24 rounded-xl overflow-hidden">
                                          <div className="relative z-10 flex items-center justify-between p-6 h-full text-white">
                                              <div className="flex flex-col items-start"><span className="text-xl font-bold text-white drop-shadow-md neon-text-small">JOGO DA FORCA</span><span className="text-xs text-gray-400">Classic Puzzle</span></div>
                                              <Brain size={32} className="text-blue-400" />
                                          </div>
                                      </button>
                                  </div>
                              </div>
                              <button onClick={toggleFullScreen} className="absolute top-6 right-6 p-3 bg-white/10 hover:bg-white/20 rounded-full transition text-gray-400 hover:text-white"><Maximize size={24}/></button>
                              <div className="absolute bottom-4 text-gray-700 text-xs">v4.10.0</div>
                          </div>
                      );
              }
          };
          return renderScreen();
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>