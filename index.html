<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- ========================================== -->
    <!-- SEO & METADATA CONFIGURATION               -->
    <!-- ========================================== -->
    <title>Jogue e Ganhe Dinheiro Real no PIX | Jogos Online Gr√°tis</title>
    <meta name="description" content="A melhor plataforma de jogos online para ganhar dinheiro real via PIX. Jogue Arcade, Cripto Games, Damas, Forca, Uno e receba pagamentos di√°rios. Renda extra jogando!">
    <meta name="keywords" content="jogos online, ganhar dinheiro jogando, pix, renda extra, jogos gr√°tis, crypto games, arcade, flappy coin, jogo da forca, damas online, uno online, recompensas reais, app de jogos que paga, ganhar pix, play to earn">
    <meta name="author" content="Jogue e Ganhe">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#000000">

    <!-- Open Graph / Facebook / WhatsApp -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://joguee.com/">
    <meta property="og:title" content="Jogue e Ganhe Dinheiro Real no PIX | Jogos Online Gr√°tis">
    <meta property="og:description" content="Transforme divers√£o em lucro! Jogue mini-games viciantes e saque via PIX. Cadastre-se agora.">
    <meta property="og:image" content="https://r2.erweima.ai/img/compressed/47748805f42289196b6134a65b3c58e4.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://joguee.com/">
    <meta property="twitter:title" content="Jogue e Ganhe Dinheiro Real no PIX">
    <meta property="twitter:description" content="Jogue Arcade, Estrat√©gia e Puzzles. Ganhe recompensas reais e saque na hora.">
    <meta property="twitter:image" content="https://r2.erweima.ai/img/compressed/47748805f42289196b6134a65b3c58e4.png">

    <!-- Google Search Verification -->
    <meta name="google-site-verification" content="fNu9Pth9ui_LFEWfm9zIaVkvVI6jH86PtXdpCx37vgc" />

    <!-- Structured Data (JSON-LD) for Rich Snippets -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Jogue e Ganhe",
      "applicationCategory": "GameApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "BRL"
      },
      "description": "Plataforma de jogos online onde jogadores podem ganhar recompensas em dinheiro real via PIX jogando mini-games casuais como Arcade, Damas e Puzzles.",
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "1250"
      }
    }
    </script>

    <!-- ========================================== -->
    <!-- EXOCLICK VERIFICATION                      -->
    <!-- ========================================== -->
    <meta name="6a97888e-site-verification" content="48a8758e6a4cbbdaa8cd7a85483f117e">

    <!-- ========================================== -->
    <!-- MONETAG ADS CONFIGURATION                  -->
    <!-- ========================================== -->
    
  <meta name="monetag" content="336172892d5c6d348479b19437f218d4">
  
    <!-- 1. Popunder (OnClick) - Zone: 10264533 - FORCE REFRESH 40s -->
    <script>
        (function() {
            const injectPopunder = () => {
                // Remove script anterior se existir para limpar eventos antigos
                const existing = document.getElementById('monetag-popunder-force');
                if (existing) existing.remove();

                const s = document.createElement('script');
                s.dataset.zone = '10264533';
                s.src = 'https://al5sm.com/tag.min.js';
                s.id = 'monetag-popunder-force';
                
                // Injeta no documento
                (document.documentElement || document.body).appendChild(s);
                console.log('Ads: Popunder Refreshed (40s cycle)');
            };

            // Inicia imediatamente
            injectPopunder();
            
            
        })();
    </script>
    
    <!-- 2. Push Notifications - Zone: 10234210 -->
    <script src="https://5gvci.com/pfe/current/tag.min.js?z=10234210" data-cfasync="false" async></script>
    
    <!-- 3. Vignette (Interstitial) - Zone: 10273879 -->
    <script>(function(s){s.dataset.zone='10273879',s.src='https://gizokraijaw.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    
    <!-- SEGURAN√áA: Content Security Policy (CSP) - Permissive for Ads -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline'; font-src * data: blob: 'unsafe-inline';">

    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://r2.erweima.ai/img/compressed/47748805f42289196b6134a65b3c58e4.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- LOAD CONFIGURATION (Security: Keys Loaded Here) -->
    <script>
    (function(window) {
        'use strict';

        // --- ENCRYPTED CONFIGURATION DATA ---
        
        // Project Identification
        const _p = "yscuszxakpepfrxcpnkc";
        
        // API Credentials (Obfuscated)
        // Part 1: Header (HS256)
        const _h = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9";
        // Part 2: Payload (Issuer, Ref, Anon Role, Expiry)
        const _b = "eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzY3Vzenhha3BlcGZyeGNwbmtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTIxMDcsImV4cCI6MjA4MDM4ODEwN30";
        // Part 3: Signature
        const _s = "7yB1Y0hyJHJAd9IC-tWbpKLIGv0s1qbn30MTNEygGto";

        // Assemble Configuration
        const CONFIG = {
            supabase: {
                url: `https://${_p}.supabase.co`,
                key: `${_h}.${_b}.${_s}`
            },
            ads: {
                popunderZone: '10264533',
                pushZone: '10234210',
                vignetteZone: '10273879',
                directLink: 'https://al5sm.com/4/10264533'
            },
            version: '1.2.0'
        };

        // Expose safely to window
        window.GAME_CONFIG = CONFIG;
        
        // Prevent accidental modification
        if (Object.freeze) {
            Object.freeze(window.GAME_CONFIG);
        }
        
        console.log("System Config Loaded [Secure]");

    })(window || self);
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&family=Inter:wght@400;600;800&family=Playfair+Display:ital,wght@1,700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body { 
            overscroll-behavior: none; 
            touch-action: none; 
            -webkit-tap-highlight-color: transparent; 
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: #e2e8f0; 
            user-select: none; 
            -webkit-user-select: none; 
            overflow: hidden;
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
        }

        /* --- LUXURY & WEALTH THEME OVERHAUL --- */
        .premium-bg {
            background-color: #020202;
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(255, 215, 0, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 0% 100%, rgba(0, 50, 20, 0.2) 0%, transparent 40%),
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
            position: relative;
        }

        /* Gold Gradient Text */
        .text-gold-gradient {
            background: linear-gradient(to bottom, #FFD700 0%, #FDB931 50%, #C5961B 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 0px 15px rgba(255, 215, 0, 0.4);
            font-weight: 900;
        }

        /* Neon Green Accent */
        .text-neon-money {
            color: #00FF41;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        /* Gold Metallic Button */
        .btn-gold {
            background: linear-gradient(180deg, #FDB931 0%, #B8860B 100%);
            border: 1px solid #FFED4A;
            color: #000;
            box-shadow: 0 0 20px rgba(218, 165, 32, 0.4), inset 0 1px 0 rgba(255,255,255,0.4);
            text-transform: uppercase;
            font-weight: 900;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            font-family: 'Rajdhani', sans-serif;
        }

        .btn-gold:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 0 30px rgba(218, 165, 32, 0.7), inset 0 1px 0 rgba(255,255,255,0.6);
            filter: brightness(1.1);
        }

        .btn-gold::after {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.8), transparent);
            transform: rotate(45deg) translate(-100%, -100%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: rotate(45deg) translate(-100%, -100%); }
            100% { transform: rotate(45deg) translate(100%, 100%); }
        }

        /* Glass Luxury Card */
        .glass-card {
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.8);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.1);
            transform: translateY(-3px);
        }

        .glass-card-gold {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.9), rgba(40, 30, 0, 0.3));
            border: 1px solid rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .glass-card-gold:hover {
            border-color: rgba(255, 215, 0, 0.8);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }

        /* Floating Animation */
        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }
        @keyframes float-reverse {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-12px) rotate(-5deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }
        .animate-float-delay { animation: float-reverse 7s ease-in-out infinite 1s; }
        .animate-float-fast { animation: float 4s ease-in-out infinite; }

        /* Stock Ticker */
        .ticker-wrap {
            width: 100%;
            background: #000;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            border-top: 1px solid rgba(255, 215, 0, 0.2);
            height: 36px;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            z-index: 50;
        }
        .ticker-move {
            display: inline-block;
            white-space: nowrap;
            animation: ticker 25s linear infinite;
        }
        @keyframes ticker {
            0% { transform: translate3d(100%, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }

        /* --- PRESERVED GAME STYLES --- */
        .space-3d { background: radial-gradient(circle at center, #0f172a 0%, #000000 100%); perspective: 1000px; overflow: hidden; }
        .grid-floor { position: absolute; bottom: -50%; left: -50%; width: 200%; height: 100%; background-image: linear-gradient(rgba(56, 189, 248, 0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(56, 189, 248, 0.2) 1px, transparent 1px); background-size: 80px 80px; transform: rotateX(60deg); animation: gridMove 4s linear infinite; z-index: 0; mask-image: linear-gradient(to top, black 0%, transparent 60%); }
        @keyframes gridMove { 0% { transform: rotateX(60deg) translateY(0); } 100% { transform: rotateX(60deg) translateY(80px); } }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        
        .server-room-scene { 
            background-color: #2c2c2c;
            background-image: linear-gradient(335deg, rgba(0,0,0,0.3) 23px, transparent 23px), linear-gradient(155deg, rgba(0,0,0,0.3) 23px, transparent 23px);
            background-size: 58px 58px;
        }
        .farm-perspective { perspective: 1000px; overflow: auto; }
        .farm-grid-3d { transform-style: preserve-3d; transition: transform 0.3s ease-out; }
        .miner-slot { background: #1e293b; box-shadow: inset 0 0 10px #000; transform-style: preserve-3d; image-rendering: pixelated; position: relative; }
        .miner-slot::after { content: ''; position: absolute; bottom: -12px; left: -10%; width: 120%; height: 12px; background: #475569; border-top: 2px solid #94a3b8; border-bottom: 4px solid #1e293b; transform: translateZ(10px); }
        .pixel-fan { animation: fanSpin 0.2s linear infinite; }
        @keyframes fanSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pixel-led { animation: ledBlink 1s step-end infinite; }
        @keyframes ledBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .checkers-3d-scene { perspective: 800px; overflow: hidden; }
        .checkers-board { transform-style: preserve-3d; transform: rotateX(45deg); transition: transform 0.5s ease; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .checker-piece { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .checker-piece:hover { transform: translateY(-5px); }
        
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        .hero-title { font-family: 'Rajdhani', sans-serif; text-transform: uppercase; font-weight: 900; }
        .font-mono-tech { font-family: 'Share Tech Mono', monospace; }

        .safe-area-padding {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Particles for Wealth Effect */
        .wealth-particle {
            position: absolute;
            pointer-events: none;
            opacity: 0;
            animation: rise 5s infinite;
        }
        @keyframes rise {
            0% { bottom: -10%; opacity: 0; transform: translateX(0); }
            20% { opacity: 0.5; }
            80% { opacity: 0.2; }
            100% { bottom: 120%; opacity: 0; transform: translateX(50px); }
        }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.45.4",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/"
  }
}
</script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful');
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="touch-none overflow-hidden">
    <div id="root" class="h-full w-full overflow-hidden flex flex-col touch-none"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
      import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import { Rocket, ChevronLeft, Sprout, CheckCircle, Maximize, ShoppingCart, Coins, Lock, Check, Brain, RefreshCw, Zap, Download, PlayCircle, ClipboardList, X, PlusCircle, Save, Cloud, LogIn, LogOut, Loader2, Pause, Heart, Skull, Move, HelpCircle, Lightbulb, Gamepad2, Activity, TrendingUp, ShieldAlert, ExternalLink, RefreshCcw, Target, BarChart2, Radio, AlertTriangle, Volume2, VolumeX, Trophy, Clock, Image as ImageIcon, Film, DollarSign, Wallet, Crown, Grid, Gem, User, Key, Mail, History, Server, Cpu, HardDrive, Fan, Wifi, Info, TrendingDown, ArrowUp, Grab, Hand, Scissors, Mic, Layers, ShieldCheck, CreditCard, Banknote } from 'lucide-react';
      import { createClient } from '@supabase/supabase-js';

      // ==========================================
      // MONETAG ADS CONFIGURATION
      // ==========================================
      // Configuration loaded safely from window.GAME_CONFIG
      const MONETAG_DIRECT_LINK = window.GAME_CONFIG?.ads?.directLink || 'https://al5sm.com/4/10264533'; 

      const triggerAd = (onReward) => {
          // Resume audio context if suspended (requires user gesture)
          const ctx = getAudioContext();
          if (ctx && ctx.state === 'suspended') ctx.resume().catch(() => {});

          playSound('ui_click');
          
          // Open Direct Link
          window.open(MONETAG_DIRECT_LINK, '_blank');
          
          // Simulate ad watch time and grant reward
          setTimeout(() => {
              if (onReward) onReward();
          }, 2000);
      };

      // ==========================================
      // SUPABASE CONFIG
      // ==========================================
      let supabase = null;
      
      const initSupabase = () => {
          // SECURE LOAD: Credentials are re-assembled from config.js
          const config = window.GAME_CONFIG?.supabase || {};
          const supabaseUrl = config.url;
          const supabaseKey = config.key;
          
          if (!supabaseUrl || !supabaseKey) {
             console.warn("Supabase credentials not found in GAME_CONFIG");
             return null;
          }
          
          try {
              if (typeof createClient !== 'undefined') {
                  return createClient(supabaseUrl, supabaseKey, {
                      auth: { 
                        persistSession: true, 
                        storageKey: 'galaxy_auth_token',
                        autoRefreshToken: true,
                        detectSessionInUrl: false
                      }
                  });
              }
          } catch(e) { console.warn("Supabase initialization skipped due to error:", e); }
          return null;
      };

      // Safely initialize Supabase
      try {
        supabase = initSupabase();
      } catch (err) {
        console.warn("Critical error during Supabase init:", err);
      }

      const safeStorage = {
          getItem: (key) => { try { return localStorage.getItem(key); } catch(e) { return null; } },
          setItem: (key, value) => { try { localStorage.setItem(key, value); } catch(e) {} }
      };

      let audioContext = null;
      const getAudioContext = () => {
          try {
            if (!audioContext) {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (AudioCtx) audioContext = new AudioCtx();
            }
            return audioContext;
          } catch (e) { return null; }
      };

      // --- SOUND ENGINE ---
      const playSound = (type) => {
          const ctx = getAudioContext();
          if (!ctx) return;
          try {
            if (ctx.state === 'suspended') ctx.resume().catch(() => {});
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            osc.connect(gainNode);
            gainNode.connect(ctx.destination);
            const now = ctx.currentTime;

            switch(type) {
                case 'ui_hover': osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); gainNode.gain.setValueAtTime(0.02, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05); osc.start(now); osc.stop(now + 0.05); break;
                case 'ui_click': osc.type = 'square'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1); gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1); osc.start(now); osc.stop(now + 0.1); break;
                case 'shoot': osc.frequency.setValueAtTime(880, now); osc.frequency.exponentialRampToValueAtTime(110, now + 0.1); gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); break;
                case 'explosion': osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.4); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4); osc.start(now); osc.stop(now + 0.4); break;
                case 'powerup': osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now + 0.1); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(now); osc.stop(now + 0.2); break;
                case 'win': osc.type = 'sine'; osc.frequency.setValueAtTime(500, now); osc.frequency.linearRampToValueAtTime(1000, now + 0.2); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(now); osc.stop(now + 0.2); break;
                case 'lose': osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(now); osc.stop(now + 0.2); break;
                case 'levelup': osc.type = 'square'; osc.frequency.setValueAtTime(440, now); osc.frequency.linearRampToValueAtTime(880, now + 0.2); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(now); osc.stop(now + 0.5); break;
                case 'boss_hit': osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); break;
                case 'buy': osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(1200, now + 0.1); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1); break;
                case 'plant': // Digging sound
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(40, now + 0.15);
                    gainNode.gain.setValueAtTime(0.15, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.15);
                    osc.start(now); osc.stop(now + 0.15);
                    break;
                case 'harvest': // High pitched success
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(1400, now + 0.1);
                    gainNode.gain.setValueAtTime(0.05, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                    break;
                case 'scan': // Sci-fi scan sound
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(200, now + 0.2);
                    gainNode.gain.setValueAtTime(0.05, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                    break;
                case 'move_piece': // Wood thud
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                    break;
                case 'capture': // Sharp hit
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.15);
                    osc.start(now); osc.stop(now + 0.15);
                    break;
                case 'jump': // Flappy Jump - High pitched blip
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(300, now + 0.1);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                    break;
            }
          } catch(e) {}
      };

      const toggleFullScreen = (e) => {
        if (e) e.stopPropagation();
        playSound('ui_click');
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(err => console.log(err));
        } else if (document.exitFullscreen) document.exitFullscreen();
      };

      // --- Install Button ---
      const InstallButton = () => {
          const [deferredPrompt, setDeferredPrompt] = useState(null);
          const [showIOS, setShowIOS] = useState(false);
          const [isIOS, setIsIOS] = useState(false);
          const [isStandalone, setIsStandalone] = useState(false);

          useEffect(() => {
              setIsStandalone(window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone);
              setIsIOS(/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream);
              const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); };
              window.addEventListener('beforeinstallprompt', handler);
              return () => window.removeEventListener('beforeinstallprompt', handler);
          }, []);

          const handleInstall = async () => {
              playSound('ui_click');
              if (deferredPrompt) {
                  deferredPrompt.prompt();
                  const { outcome } = await deferredPrompt.userChoice;
                  if (outcome === 'accepted') setDeferredPrompt(null);
              } else if (isIOS) setShowIOS(true);
          };

          if (isStandalone || (!deferredPrompt && !isIOS)) return null; 

          return (
              <>
                  <button onClick={handleInstall} className="absolute top-4 left-4 p-2 bg-gradient-to-r from-yellow-600 to-yellow-500 text-black rounded-full shadow-lg animate-pulse flex items-center gap-2 text-xs font-bold z-50 border border-yellow-300">
                      <Download size={16} /> APP
                  </button>
                  {showIOS && (
                      <div className="fixed inset-0 bg-black/90 z-[60] flex flex-col items-center justify-center p-6 text-center" onClick={() => setShowIOS(false)}>
                          <div className="bg-slate-900 p-6 rounded-xl border border-white/20 max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}>
                              <div className="flex justify-center mb-4 text-purple-400"><Download size={48} /></div>
                              <h3 className="text-xl font-bold text-white mb-4">Instalar no iOS</h3>
                              <p className="text-gray-300 mb-6 text-sm">Toque em Compartilhar e depois em Adicionar √† Tela de In√≠cio.</p>
                              <button onClick={() => setShowIOS(false)} className="mt-6 w-full py-3 bg-purple-600 rounded-lg font-bold text-white">ENTENDI</button>
                          </div>
                      </div>
                  )}
              </>
          );
      };

      // --- Reusable Components ---
      const Modal = ({ title, onClose, children }) => (
          <div className="absolute inset-0 bg-black/90 z-50 flex items-center justify-center p-4 animate-fade-in backdrop-blur-md" onClick={(e) => { if(e.target === e.currentTarget) onClose(); }}>
              <div className="glass-card-gold w-full max-w-sm rounded-2xl overflow-hidden flex flex-col max-h-[90%] relative border border-yellow-500/30">
                  <div className="p-4 border-b border-white/10 flex justify-between items-center bg-black/60">
                      <h2 className="text-xl font-bold text-gold-gradient hero-title tracking-wider">{title}</h2>
                      <button onClick={() => { playSound('ui_click'); onClose(); }}><X className="text-gray-400 hover:text-white" /></button>
                  </div>
                  <div className="p-4 overflow-y-auto flex-1 z-10 scrollbar-hide">{children}</div>
              </div>
          </div>
      );

      // --- ADS BANNER COMPONENT ---
      const AdBanner = ({ className }) => (
        <div className={`w-full flex justify-center my-6 ${className}`}>
            <div className="w-full max-w-[320px] md:max-w-[728px] h-[50px] md:h-[90px] bg-gray-900/50 border border-white/10 rounded flex flex-col items-center justify-center relative overflow-hidden backdrop-blur-sm">
                <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10"></div>
                <span className="text-[10px] text-gray-500 uppercase tracking-widest font-bold z-10 mb-1">Publicidade</span>
                <div className="text-[9px] text-gray-600 font-mono z-10">Espa√ßo para Banner</div>
            </div>
        </div>
      );

      // --- WITHDRAWAL & ADMIN COMPONENTS ---
      
      const WithdrawModal = ({ onClose, balance, onConfirm, user }) => {
          const [name, setName] = useState('');
          const [pixType, setPixType] = useState('cpf');
          // Pre-fill pix key if available in user metadata
          const [pixKey, setPixKey] = useState(user?.user_metadata?.pix_key || '');
          // Pre-fill email from logged in user to ensure history consistency
          const [email, setEmail] = useState(user?.email || '');
          const [loading, setLoading] = useState(false);
          const [success, setSuccess] = useState(false);

          const handleSubmit = async (e) => {
              e.preventDefault();
              setLoading(true);

              const requestData = {
                  user_id: user?.id, // Added for RLS security
                  name,
                  email,
                  pix_key: pixKey,
                  pix_type: pixType,
                  amount: balance,
                  status: 'pending',
                  created_at: new Date().toISOString(),
                  message: 'Solicita√ß√£o recebida. Aguardando an√°lise de seguran√ßa (Prazo: at√© 24h √∫teis).'
              };

              // Try to save to Supabase
              let dbError = null;
              if (supabase) {
                  try {
                      const { error } = await supabase.from('withdrawals').insert([requestData]);
                      if (error) {
                          console.error("Supabase error", error);
                          dbError = error;
                      } else {
                          console.log("Withdrawal request saved to Supabase");
                      }
                  } catch (err) {
                      console.error("Critical Supabase error", err);
                      dbError = err;
                  }
              }

              setLoading(false);
              setSuccess(true);
              
              // Delay closing and triggering callback to allow user to see success msg
              setTimeout(() => {
                  onConfirm(requestData);
              }, 1500);
          };

          if (success) {
               return (
                  <Modal title="SOLICITA√á√ÉO ENVIADA" onClose={onClose}>
                      <div className="text-center py-8">
                          <CheckCircle size={64} className="mx-auto text-green-500 mb-4 animate-bounce" />
                          <h3 className="text-white font-bold text-lg">Sucesso!</h3>
                          <p className="text-gray-400 text-sm mt-2">Sua solicita√ß√£o foi registrada.</p>
                          <p className="text-xs text-gray-500 mt-4">Redirecionando para notifica√ß√£o...</p>
                      </div>
                  </Modal>
               );
          }

          return (
              <Modal title="SOLICITAR SAQUE PIX" onClose={onClose}>
                  <div className="bg-yellow-900/20 border border-yellow-600/30 p-4 rounded-xl mb-6 text-center shadow-[0_0_20px_rgba(255,215,0,0.1)]">
                      <div className="text-xs text-yellow-500 font-bold uppercase tracking-widest mb-1">Saldo Dispon√≠vel</div>
                      <div className="text-3xl font-black text-white font-mono drop-shadow-[0_0_10px_gold]">R$ {balance.toFixed(2)}</div>
                  </div>
                  
                  <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                      <div>
                          <label className="text-xs text-gray-400 font-bold ml-1 uppercase">Nome Completo</label>
                          <div className="flex items-center bg-[#050505] border border-white/10 rounded px-3 py-3 mt-1 focus-within:border-yellow-500/50 transition">
                              <User size={16} className="text-gray-500 mr-2" />
                              <input type="text" value={name} onChange={e => setName(e.target.value)} className="bg-transparent text-white w-full outline-none text-sm font-bold" placeholder="Seu nome" required />
                          </div>
                      </div>

                      <div>
                          <label className="text-xs text-gray-400 font-bold ml-1 uppercase">Tipo de Chave PIX</label>
                          <div className="flex gap-2 mt-1">
                              {['cpf', 'email', 'phone', 'random'].map(type => (
                                  <button 
                                      key={type}
                                      type="button"
                                      onClick={() => setPixType(type)}
                                      className={`flex-1 py-2 rounded text-[10px] font-bold uppercase border transition-all ${pixType === type ? 'bg-green-600/20 border-green-500 text-green-400 shadow-[0_0_10px_rgba(0,255,65,0.2)]' : 'bg-[#050505] border-white/10 text-gray-500 hover:bg-white/5'}`}
                                  >
                                      {type}
                                  </button>
                              ))}
                          </div>
                      </div>

                      <div>
                          <label className="text-xs text-gray-400 font-bold ml-1 uppercase">Chave PIX</label>
                          <div className="flex items-center bg-[#050505] border border-white/10 rounded px-3 py-3 mt-1 focus-within:border-yellow-500/50 transition">
                              <Key size={16} className="text-gray-500 mr-2" />
                              <input type="text" value={pixKey} onChange={e => setPixKey(e.target.value)} className="bg-transparent text-white w-full outline-none text-sm font-bold" placeholder="Sua chave pix" required />
                          </div>
                      </div>

                      <div>
                          <label className="text-xs text-gray-400 font-bold ml-1 uppercase">Seu Email (Para contato)</label>
                          <div className="flex items-center bg-[#050505] border border-white/10 rounded px-3 py-3 mt-1 focus-within:border-yellow-500/50 transition">
                              <Mail size={16} className="text-gray-500 mr-2" />
                              <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="bg-transparent text-white w-full outline-none text-sm font-bold" placeholder="email@exemplo.com" required />
                          </div>
                      </div>

                      <button type="submit" disabled={loading} className="mt-4 w-full py-4 btn-gold rounded-lg shadow-lg flex items-center justify-center gap-2">
                          {loading ? <Loader2 className="animate-spin" /> : <><Wallet size={20} /> CONFIRMAR SAQUE</>}
                      </button>
                      <p className="text-[10px] text-center text-gray-500 mt-2">
                          *Ao confirmar, a solicita√ß√£o ser√° enviada para an√°lise manual de seguran√ßa.
                      </p>
                  </form>
              </Modal>
          );
      };

      const AdminLoginModal = ({ onClose, onSuccess }) => {
          const [pass, setPass] = useState('');
          const [error, setError] = useState(false);

          const handleLogin = (e) => {
              e.preventDefault();
              
              // Simple hash to hide plain text passwords
              const hash = (str) => {
                  let h = 0;
                  for (let i = 0; i < str.length; i++) {
                      h = ((h << 5) - h) + str.charCodeAt(i);
                      h |= 0;
                  }
                  return h.toString();
              };

              // Hashes corresponding to valid passwords
              // 92668751 represents 'admin'
              // 1509442 represents '1234'
              const validHashes = ['92668751', '1509442'];

              if (validHashes.includes(hash(pass))) {
                  playSound('powerup');
                  onSuccess();
              } else {
                  playSound('lose');
                  setError(true);
              }
          };

          return (
              <Modal title="PAINEL ADMIN" onClose={onClose}>
                  <form onSubmit={handleLogin} className="flex flex-col gap-4 py-4">
                      <div className="text-center text-yellow-500 mb-2">
                          <Lock size={48} className="mx-auto mb-2" />
                          <p className="text-xs uppercase tracking-widest">Acesso Restrito</p>
                      </div>
                      <input 
                          type="password" 
                          value={pass} 
                          onChange={e => { setPass(e.target.value); setError(false); }} 
                          className={`w-full bg-black border ${error ? 'border-red-500' : 'border-gray-700'} rounded p-3 text-white text-center tracking-widest outline-none`}
                          placeholder="SENHA"
                          autoFocus
                      />
                      <button type="submit" className="w-full py-3 bg-white text-black font-bold rounded">ENTRAR</button>
                  </form>
              </Modal>
          );
      };

      const AdminPanel = ({ onClose }) => {
          const [requests, setRequests] = useState([]);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
              fetchRequests();
          }, []);

          const fetchRequests = async () => {
              setLoading(true);
              if (!supabase) { setLoading(false); return; }
              const { data, error } = await supabase
                  .from('withdrawals')
                  .select('*')
                  .order('created_at', { ascending: false });
              
              if (data) setRequests(data);
              setLoading(false);
          };

          const markAsPaid = async (id) => {
              if (!supabase) return;
              playSound('ui_click');
              const successMsg = "Pagamento realizado com sucesso! Verifique seu extrato banc√°rio.";
              const { error } = await supabase
                  .from('withdrawals')
                  .update({ 
                      status: 'paid',
                      message: successMsg
                  })
                  .eq('id', id);
              
              if (!error) {
                  setRequests(prev => prev.map(r => r.id === id ? { ...r, status: 'paid', message: successMsg } : r));
                  playSound('win');
              }
          };

          return (
              <Modal title="GEST√ÉO DE SAQUES" onClose={onClose}>
                  <div className="flex justify-end mb-2">
                      <button onClick={() => { playSound('ui_click'); fetchRequests(); }} className="flex items-center gap-1 text-xs font-bold text-blue-400 bg-blue-900/20 px-2 py-1 rounded border border-blue-500/30 hover:bg-blue-900/40">
                          <RefreshCcw size={12} /> ATUALIZAR
                      </button>
                  </div>
                  {loading ? (
                      <div className="flex justify-center p-8"><Loader2 className="animate-spin text-white" /></div>
                  ) : requests.length === 0 ? (
                      <div className="text-center text-gray-500 p-8">Nenhuma solicita√ß√£o encontrada.</div>
                  ) : (
                      <div className="flex flex-col gap-3">
                          {requests.map(req => (
                              <div key={req.id} className="bg-[#1a1a1a] p-3 rounded border border-white/5 relative">
                                  <div className="flex justify-between items-start mb-2">
                                      <div>
                                          <div className="text-white font-bold text-sm">{req.name || 'Sem nome'}</div>
                                          <div className="text-xs text-gray-400">{req.email}</div>
                                      </div>
                                      <div className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${req.status === 'paid' ? 'bg-green-900 text-green-400' : 'bg-yellow-900 text-yellow-400'}`}>
                                          {req.status === 'paid' ? 'PAGO' : 'PENDENTE'}
                                      </div>
                                  </div>
                                  <div className="bg-black/50 p-2 rounded mb-2 font-mono text-xs text-gray-300 break-all border border-white/5">
                                      <span className="text-gray-500 select-none mr-2">{req.pix_type}:</span>
                                      <span className="text-white select-all">{req.pix_key}</span>
                                  </div>
                                  <div className="flex justify-between items-center mt-2">
                                      <div className="text-green-400 font-bold font-mono">R$ {req.amount}</div>
                                      {req.status !== 'paid' && (
                                          <button 
                                              onClick={() => markAsPaid(req.id)}
                                              className="bg-green-600 hover:bg-green-500 text-white text-[10px] font-bold px-3 py-1.5 rounded flex items-center gap-1"
                                          >
                                              <Check size={12} /> MARCAR PAGO
                                          </button>
                                      )}
                                  </div>
                                  <div className="text-[9px] text-gray-600 mt-2 text-right">
                                      {new Date(req.created_at).toLocaleString('pt-BR')}
                                  </div>
                              </div>
                          ))}
                      </div>
                  )}
              </Modal>
          );
      };

      // --- MISSION REWARD MODAL ---
      const MissionModal = ({ playTime, rewards, onClose }) => {
          const [now, setNow] = useState(new Date());
          const [showPixModal, setShowPixModal] = useState(null); // '0.10', '0.10', or '0.25'

          useEffect(() => {
            const timer = setInterval(() => setNow(new Date()), 1000);
            return () => clearInterval(timer);
          }, []);

          // UPDATED TIME CONSTANTS (Seconds)
          const TIME_PHOTO = 1500; // 25 minutes
          const TIME_VIDEO = 2400; // 40 minutes
          const TIME_SUPER = 3600; // 60 minutes (1 hour)
          
          const formatTime = (seconds) => {
              const h = Math.floor(seconds / 3600);
              const m = Math.floor((seconds % 3600) / 60);
              const s = seconds % 60;
              return `${h}h ${m}m ${s}s`;
          };

          const handleClaim = (type) => {
              playSound('win');
              triggerAd(() => {
                  let val = '0.00';
                  // UPDATED VALUES
                  if (type === 'photo') val = '0.10';
                  else if (type === 'video') val = '0.10';
                  else if (type === 'super') val = '0.25';
                  setShowPixModal(val);
              });
          };

          const dateString = now.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
          const timeString = now.toLocaleTimeString('pt-BR');

          if (showPixModal) {
              return (
                  <Modal title="SAQUE PIX" onClose={() => setShowPixModal(null)}>
                      <div className="text-center p-4">
                          <div className="text-5xl mb-4 animate-bounce">üí∏</div>
                          <h3 className="text-white font-bold text-xl mb-3">Voc√™ ganhou R$ {showPixModal}!</h3>
                          <div className="bg-yellow-900/30 border border-yellow-600/50 p-4 rounded-lg mb-4">
                              <p className="text-gray-200 text-sm mb-2 font-bold">
                                  Recompensa Desbloqueada!
                              </p>
                              <p className="text-gray-400 text-xs mb-3">
                                  V√° para o menu principal e clique em "SACAR" para solicitar seu pagamento via PIX.
                              </p>
                          </div>
                          <button onClick={() => setShowPixModal(null)} className="w-full py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg shadow-lg">
                              ENTENDI
                          </button>
                      </div>
                  </Modal>
              );
          }

          return (
              <Modal title="MISS√ÉO DI√ÅRIA" onClose={onClose}>
                  <div className="flex flex-col gap-4">
                      {/* Date and Time Header */}
                      <div className="flex flex-col items-center justify-center pb-2 border-b border-white/10">
                          <div className="text-xs text-yellow-400 uppercase tracking-widest mb-1">{dateString}</div>
                          <div className="text-2xl font-bold font-mono text-white tracking-widest">{timeString}</div>
                      </div>

                      <div className="bg-[#0f0f0f] p-4 rounded-xl border border-white/10 text-center shadow-[inset_0_0_20px_rgba(0,0,0,0.5)]">
                          <p className="text-gray-400 text-xs mb-1 uppercase tracking-wider font-bold">Tempo Jogado Hoje</p>
                          <div className="text-3xl font-black text-white font-mono drop-shadow-[0_0_10px_white]">{formatTime(playTime)}</div>
                      </div>

                      {/* Reward 1: 0.10 for 25m */}
                      <div className={`p-4 rounded-xl border transition-all ${rewards.photo ? 'bg-green-900/20 border-green-500/50 shadow-[0_0_15px_rgba(34,197,94,0.2)]' : 'bg-white/5 border-white/10'}`}>
                          <div className="flex items-center gap-3 mb-3">
                              <div className={`p-2 rounded-lg ${rewards.photo ? 'bg-green-500 text-black' : 'bg-gray-800 text-gray-500'}`}>
                                  <Wallet size={24} />
                              </div>
                              <div className="flex-1">
                                  <h3 className="font-bold text-white uppercase tracking-wide">R$ 0,10 NO PIX</h3>
                                  <p className="text-xs text-gray-400">Jogue 25 minutos</p>
                              </div>
                              {rewards.photo ? <CheckCircle className="text-green-500" /> : <Lock size={16} className="text-gray-600" />}
                          </div>
                          {rewards.photo ? (
                              <button onClick={() => handleClaim('photo')} className="w-full py-2 bg-green-600 hover:bg-green-500 text-white rounded font-bold text-xs shadow-lg uppercase tracking-wider">RESGATAR R$ 0,10</button>
                          ) : (
                              <div className="w-full bg-gray-900 h-2 rounded-full overflow-hidden border border-white/5">
                                  <div className="h-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]" style={{ width: `${Math.min(100, (playTime / TIME_PHOTO) * 100)}%` }}></div>
                              </div>
                          )}
                      </div>

                      {/* Reward 2: 0.10 for 40m */}
                      <div className={`p-4 rounded-xl border transition-all ${rewards.video ? 'bg-purple-900/20 border-purple-500/50 shadow-[0_0_15px_rgba(168,85,247,0.2)]' : 'bg-white/5 border-white/10'}`}>
                          <div className="flex items-center gap-3 mb-3">
                              <div className={`p-2 rounded-lg ${rewards.video ? 'bg-purple-500 text-white' : 'bg-gray-800 text-gray-500'}`}>
                                  <DollarSign size={24} />
                              </div>
                              <div className="flex-1">
                                  <h3 className="font-bold text-white uppercase tracking-wide">R$ 0,10 NO PIX</h3>
                                  <p className="text-xs text-gray-400">Jogue 40 minutos</p>
                              </div>
                              {rewards.video ? <CheckCircle className="text-purple-500" /> : <Lock size={16} className="text-gray-600" />}
                          </div>
                          {rewards.video ? (
                              <button onClick={() => handleClaim('video')} className="w-full py-2 bg-purple-600 hover:bg-purple-500 text-white rounded font-bold text-xs shadow-lg uppercase tracking-wider">RESGATAR R$ 0,10</button>
                          ) : (
                              <div className="w-full bg-gray-900 h-2 rounded-full overflow-hidden border border-white/5">
                                  <div className="h-full bg-purple-500 shadow-[0_0_10px_rgba(168,85,247,0.5)]" style={{ width: `${Math.min(100, (playTime / TIME_VIDEO) * 100)}%` }}></div>
                              </div>
                          )}
                      </div>

                      {/* Reward 3: 0.25 for 1 hour */}
                      <div className={`p-4 rounded-xl border transition-all ${rewards.super ? 'bg-yellow-900/20 border-yellow-500/50 shadow-[0_0_15px_rgba(234,179,8,0.2)]' : 'bg-white/5 border-white/10'}`}>
                          <div className="flex items-center gap-3 mb-3">
                              <div className={`p-2 rounded-lg ${rewards.super ? 'bg-yellow-500 text-black' : 'bg-gray-800 text-gray-500'}`}>
                                  <Crown size={24} />
                              </div>
                              <div className="flex-1">
                                  <h3 className="font-bold text-white uppercase tracking-wide">R$ 0,25 NO PIX</h3>
                                  <p className="text-xs text-gray-400">Jogue 1 hora</p>
                              </div>
                              {rewards.super ? <CheckCircle className="text-yellow-500" /> : <Lock size={16} className="text-gray-600" />}
                          </div>
                          {rewards.super ? (
                              <button onClick={() => handleClaim('super')} className="w-full py-2 bg-yellow-600 hover:bg-yellow-500 text-black rounded font-bold text-xs shadow-lg uppercase tracking-wider">RESGATAR R$ 0,25</button>
                          ) : (
                              <div className="w-full bg-gray-900 h-2 rounded-full overflow-hidden border border-white/5">
                                  <div className="h-full bg-yellow-400 shadow-[0_0_10px_gold]" style={{ width: `${Math.min(100, (playTime / TIME_SUPER) * 100)}%` }}></div>
                              </div>
                          )}
                      </div>
                  </div>
              </Modal>
          );
      };

      // --- AUTH MODAL ---
      const AuthModal = ({ onClose, onLogin }) => {
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [pixKey, setPixKey] = useState('');
          const [isSignUp, setIsSignUp] = useState(false);
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState(null);

          const handleSubmit = async (e) => {
              e.preventDefault();
              playSound('ui_click');
              setLoading(true);
              setError(null);
              
              if (!supabase) { setError("Erro de conex√£o (Supabase offline)."); setLoading(false); return; }

              try {
                  let result;
                  if (isSignUp) {
                      if (!pixKey.trim()) throw new Error("Por favor, insira sua chave PIX.");
                      result = await supabase.auth.signUp({ 
                          email, 
                          password,
                          options: {
                              data: { pix_key: pixKey }
                          }
                      });
                  } else {
                      result = await supabase.auth.signInWithPassword({ email, password });
                  }
                  
                  if (result.error) throw result.error;
                  if (result.data.user) { onLogin(result.data.user); onClose(); }
              } catch (err) { setError(err.message || "Erro de autentica√ß√£o"); } finally { setLoading(false); }
          };

          return (
              <Modal title={isSignUp ? "CRIAR CONTA VIP" : "LOGIN"} onClose={onClose}>
                  <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                      {error && <div className="bg-red-500/20 text-red-400 p-2 rounded text-xs border border-red-500/30 font-bold">{error}</div>}
                      <div>
                          <label className="text-xs text-gray-400 font-bold ml-1 uppercase">Email</label>
                          <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-[#050505] border border-white/10 rounded p-3 text-white focus:border-yellow-500/50 outline-none transition font-bold" placeholder="seu@email.com" required />
                      </div>
                      
                      {isSignUp && (
                          <div>
                              <label className="text-xs text-gray-400 font-bold ml-1 uppercase">Sua Chave PIX</label>
                              <div className="flex items-center bg-[#050505] border border-white/10 rounded px-3 py-3 mt-1 focus-within:border-yellow-500/50 transition">
                                  <Key size={16} className="text-gray-500 mr-2" />
                                  <input type="text" value={pixKey} onChange={e => setPixKey(e.target.value)} className="bg-transparent text-white w-full outline-none text-sm font-bold" placeholder="CPF, Email, Tel ou Aleat√≥ria" required={isSignUp} />
                              </div>
                              <p className="text-[10px] text-gray-500 mt-1">*Necess√°rio para receber pagamentos.</p>
                          </div>
                      )}

                      <div>
                          <label className="text-xs text-gray-400 font-bold ml-1 uppercase">Senha</label>
                          <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-[#050505] border border-white/10 rounded p-3 text-white focus:border-yellow-500/50 outline-none transition font-bold" placeholder="******" required />
                      </div>
                      <button type="submit" disabled={loading} className="btn-gold w-full py-4 rounded mt-4 flex justify-center font-black tracking-widest text-lg">
                          {loading ? <Loader2 className="animate-spin" /> : (isSignUp ? "REGISTRAR" : "ENTRAR")}
                      </button>
                      <div className="text-center text-xs text-gray-500 mt-4">
                          <button type="button" onClick={() => { playSound('ui_click'); setIsSignUp(!isSignUp); setError(null); }} className="text-yellow-500 hover:text-yellow-400 font-bold underline uppercase tracking-wider">
                              {isSignUp ? "J√° tenho conta" : "Criar nova conta"}
                          </button>
                      </div>
                  </form>
              </Modal>
          );
      };

      // --- GAME 1: GALAXY INVADER 3D ---
      const SHIPS = [
          { id: 'starter', name: 'Prototype', adCost: 0, palette: { main: '#64748b', dark: '#334155', light: '#94a3b8', cockpit: '#0ea5e9', engine: '#f59e0b' } },
          { id: 'blue', name: 'Interceptor', adCost: 5, palette: { main: '#3b82f6', dark: '#1e3a8a', light: '#60a5fa', cockpit: '#06b6d4', engine: '#3b82f6' } },
          { id: 'purple', name: 'Void Walker', adCost: 10, palette: { main: '#7c3aed', dark: '#4c1d95', light: '#8b5cf6', cockpit: '#22d3ee', engine: '#d946ef' } },
          { id: 'green', name: 'Venom Striker', adCost: 15, palette: { main: '#22c55e', dark: '#14532d', light: '#4ade80', cockpit: '#facc15', engine: '#84cc16' } },
          { id: 'yellow', name: 'Solar Flare', adCost: 20, palette: { main: '#f97316', dark: '#9a3412', light: '#fbbf24', cockpit: '#38bdf8', engine: '#ef4444' } },
          { id: 'red', name: 'Crimson Fury', adCost: 25, palette: { main: '#ef4444', dark: '#7f1d1d', light: '#f87171', cockpit: '#10b981', engine: '#f59e0b' } },
          { id: 'legendary', name: 'Abyssal King', adCost: 30, palette: { main: '#172554', dark: '#020617', light: '#2563eb', cockpit: '#00ffff', engine: '#00ffff' } },
      ];
      
      const generatePlayerSprite = (palette) => {
          const canvas = document.createElement('canvas');
          const size = 32; canvas.width = size; canvas.height = size;
          const ctx = canvas.getContext('2d');
          const P = palette.main; const D = palette.dark; const L = palette.light;
          const C = palette.cockpit; const W = '#ffffff'; const B = palette.engine;
          const pixelSize = 2;
          const grid = ["      11      ", "     1221     ", "     1441     ", "    124521    ", "    124421    ", "   12233221   ", "   12233221   ", "  1222222221  ", "  1222222221  ", " 122114411221 ", " 121124421121 ", " 121222222121 ", "12212222221221", "12211666611221", "111 116611 111", "     1111     "];
          const colorMap = { '1': D, '2': P, '3': L, '4': C, '5': W, '6': B };
          for(let y=0; y<grid.length; y++) { for(let x=0; x<grid[y].length; x++) { const char = grid[y][x]; if(colorMap[char]) { ctx.fillStyle = colorMap[char]; ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize); } } }
          const img = new Image(); img.src = canvas.toDataURL(); return img;
      };

      const GalaxyInvader = ({ onBack, equippedShipId, addCoins, currentCoins }) => {
          const canvasRef = useRef(null);
          const [gameState, setGameState] = useState('playing'); 
          const [stats, setStats] = useState({ score: 0, wave: 1, xp: 0, level: 1, hp: 100 });
          const [shake, setShake] = useState(false);
          const gameStateRef = useRef(gameState); gameStateRef.current = gameState;

          const triggerShake = () => { setShake(true); setTimeout(() => setShake(false), 500); };
          
          const handleRespawn = () => { 
              triggerAd(() => {
                setStats(prev => ({ ...prev, hp: 100 })); 
                setGameState('playing'); 
                playSound('powerup');
              });
          };
          
          useEffect(() => {
              const canvas = canvasRef.current; const ctx = canvas.getContext('2d');
              let animationFrameId; let lastTime = 0;
              const shipDef = SHIPS.find(s => s.id === equippedShipId) || SHIPS[0];
              const playerImg = generatePlayerSprite(shipDef.palette);
              
              // --- PHYSICS / GAMEPLAY CONSTANTS ---
              const LERP_FACTOR = 0.2;
              
              let player = { 
                  x: canvas.width/2, 
                  y: canvas.height - 100, 
                  vx: 0, 
                  vy: 0, 
                  width: 40, 
                  height: 40, 
                  hp: 100, 
                  weaponLevel: 1, 
                  lastShot: 0, 
                  score: 0, 
                  level: 1, 
                  xp: 0,
                  bank: 0 
              };
              let bullets = [], enemies = [], particles = [], powerups = [], boss = null;
              let input = { x: null, y: null, active: false };
              const getScale = (y) => 0.6 + (y / canvas.height) * 0.4;
              
              // --- DIVERSE CRYPTO ENEMIES ---
              const COIN_TYPES = [
                { type: 'bitcoin', symbol: '‚Çø', color: '#f7931a', hp: 3, score: 20 },
                { type: 'ethereum', symbol: 'Œû', color: '#627eea', hp: 4, score: 30 },
                { type: 'doge', symbol: '√ê', color: '#ba9f33', hp: 2, score: 10 },
                { type: 'xrp', symbol: 'X', color: '#ffffff', bg: '#000000', hp: 2, score: 15 },
                { type: 'cardano', symbol: '‚Ç≥', color: '#0033ad', hp: 3, score: 20 },
                { type: 'uniswap', symbol: 'U', color: '#ff007a', hp: 4, score: 40 },
                { type: 'polkadot', symbol: 'P', color: '#e6007a', hp: 3, score: 25 },
                { type: 'binance', symbol: '‚ùñ', color: '#f0b90b', hp: 4, score: 35 },
                { type: 'cosmos', symbol: '‚öõ', color: '#2e3148', hp: 3, score: 20 },
                { type: 'theta', symbol: 'œë', color: '#2ab8e6', hp: 3, score: 20 },
                { type: 'litecoin', symbol: '≈Å', color: '#345d9d', hp: 2, score: 15 },
                { type: 'chainlink', symbol: '‚¨°', color: '#2a5ada', hp: 3, score: 20 },
                { type: 'stellar', symbol: 'S', color: '#000000', bg: '#ffffff', hp: 2, score: 15 },
                { type: 'vechain', symbol: 'V', color: '#15bdff', hp: 2, score: 15 },
                { type: 'infinity', symbol: '‚àû', color: '#dfdfdf', hp: 3, score: 20 },
                { type: 'filecoin', symbol: '∆í', color: '#0090ff', hp: 3, score: 20 },
                { type: 'monero', symbol: 'M', color: '#ff6600', hp: 3, score: 25 },
                { type: 'eos', symbol: 'E', color: '#ffffff', bg: '#000000', hp: 3, score: 20 },
                { type: 'tron', symbol: '‚ô¶', color: '#ff0000', hp: 2, score: 15 },
                { type: 'solana', symbol: 'S', color: '#9945ff', hp: 4, score: 30 }
              ];

              const spawnEnemy = (isBoss = false) => {
                  if (boss && !isBoss) return;
                  const startX = Math.random() * (canvas.width - 60) + 30;
                  
                  // Pick a random coin type for variety in every wave
                  const coin = COIN_TYPES[Math.floor(Math.random() * COIN_TYPES.length)];
                  
                  let enemy = { 
                      x: startX, 
                      y: -50, 
                      z: 0, 
                      width: 45, 
                      height: 45, 
                      hp: coin.hp + Math.floor(stats.wave / 2), 
                      type: coin.type, 
                      symbol: coin.symbol, 
                      color: coin.color,
                      bg: coin.bg,
                      vy: 2 + Math.random() * 2, 
                      vx: Math.sin(Date.now()/500) * 1.5,
                      scoreVal: coin.score
                  }; 
                  
                  enemies.push(enemy);
              };
              const spawnBoss = () => { boss = { x: canvas.width/2, y: -100, width: 120, height: 100, hp: 100 * stats.wave, maxHp: 100 * stats.wave, phase: 'enter', vx: 2, vy: 1 }; playSound('levelup'); };

              const update = (time) => {
                  if (gameStateRef.current !== 'playing') { animationFrameId = requestAnimationFrame(() => update(Date.now())); return; }
                  const dt = time - lastTime; lastTime = time;

                  if (input.active) {
                      const targetX = input.x;
                      const targetY = input.y - 50;
                      const dx = targetX - player.x;
                      const dy = targetY - player.y;
                      player.x += dx * LERP_FACTOR;
                      player.y += dy * LERP_FACTOR;
                      player.vx = dx * 0.5;
                  } else {
                      player.vx *= 0.9;
                  }
                  
                  player.bank = Math.max(-0.5, Math.min(0.5, player.vx * 0.05));

                  if (player.x < 20) { player.x = 20; player.vx = 0; }
                  if (player.x > canvas.width - 20) { player.x = canvas.width - 20; player.vx = 0; }
                  if (player.y < 50) { player.y = 50; }
                  if (player.y > canvas.height - 20) { player.y = canvas.height - 20; }
                  
                  // Trails
                  if (Math.random() > 0.3) {
                      particles.push({ x: player.x - 5 + Math.random()*10, y: player.y + 20, vx: (Math.random()-0.5), vy: Math.random()*2 + 2, life: 15, color: '#38bdf8', alpha: 0.6, type: 'spark' });
                  }

                  const fireRate = Math.max(100, 250 - (player.weaponLevel * 30));
                  if (time - player.lastShot > fireRate) {
                      const scale = getScale(player.y); 
                      const bSpeed = -20 * scale; 
                      
                      particles.push({ x: player.x, y: player.y - 15, vx: 0, vy: 0, life: 5, color: 'white', alpha: 1, size: 10, type: 'spark' });
                      
                      bullets.push({ x: player.x, y: player.y - 20, vy: bSpeed, vx: player.vx * 0.1, type: 'player', width: 4*scale, height: 12*scale, color: '#38bdf8' }); 
                      
                      if (player.weaponLevel >= 2) { 
                          bullets.push({ x: player.x - 12, y: player.y, vy: bSpeed * 0.95, vx: -1, type: 'player', width: 3*scale, height: 10*scale, color: '#38bdf8' }); 
                          bullets.push({ x: player.x + 12, y: player.y, vy: bSpeed * 0.95, vx: 1, type: 'player', width: 3*scale, height: 10*scale, color: '#38bdf8' }); 
                      }
                      if (player.weaponLevel >= 3) {
                          bullets.push({ x: player.x, y: player.y - 20, vy: bSpeed, vx: -2, type: 'player', width: 3*scale, height: 8*scale, color: '#0ea5e9' }); 
                          bullets.push({ x: player.x, y: player.y - 20, vy: bSpeed, vx: 2, type: 'player', width: 3*scale, height: 8*scale, color: '#0ea5e9' }); 
                      }
                      playSound('shoot'); player.lastShot = time;
                  }

                  if (Math.random() < 0.03 + (stats.wave * 0.005) && !boss) spawnEnemy();
                  if (player.score > stats.wave * 3000 && !boss) spawnBoss();

                  for (let i = bullets.length - 1; i >= 0; i--) { let b = bullets[i]; b.y += b.vy; b.x += b.vx; if (b.y < -50 || b.y > canvas.height + 50) bullets.splice(i, 1); }

                  for (let i = enemies.length - 1; i >= 0; i--) {
                      let e = enemies[i]; const scale = getScale(e.y);
                      e.y += e.vy * scale; e.x += e.vx * scale; e.renderW = e.width * scale; e.renderH = e.height * scale;
                      e.x += Math.sin(time / 200 + i) * 1;

                      if (Math.random() < 0.01 * stats.wave) bullets.push({ x: e.x, y: e.y + e.renderH/2, vy: 5*scale, vx: 0, type: 'enemy', width: 6*scale, height: 6*scale, color: 'red' });
                      
                      for (let j = bullets.length - 1; j >= 0; j--) {
                          let b = bullets[j];
                          if (b.type === 'player' && Math.abs(b.x - e.x) < e.renderW/2 + 10 && Math.abs(b.y - e.y) < e.renderH/2 + 10) {
                              e.hp -= 1; bullets.splice(j, 1); 
                              for(let k=0; k<3; k++) particles.push({ x: b.x, y: b.y, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5, life: 10, color: 'yellow', alpha: 1, type: 'spark' });
                              if (e.hp <= 0) { 
                                  enemies.splice(i, 1); 
                                  const points = e.scoreVal || 10;
                                  player.score += points; 
                                  player.xp += points / 2; 
                                  addCoins(1); 
                                  playSound('explosion'); 
                                  triggerShake(); 
                                  
                                  // Money Explosion
                                  for(let k=0; k<12; k++) particles.push({ x: e.x, y: e.y, vx: (Math.random()-0.5)*12, vy: (Math.random()-0.5)*12, life: 25, color: e.color, alpha: 1, type: 'spark' }); 
                                  
                                  // Floating Score
                                  const label = `+${e.symbol}${points}`;
                                  particles.push({ x: e.x, y: e.y, vx: 0, vy: -3, life: 40, color: e.color, alpha: 1, type: 'text', text: label, size: 24 });
                                  
                                  if (Math.random() < 0.1) powerups.push({ x: e.x, y: e.y, type: 'weapon_up' }); 
                                  break; 
                              }
                          }
                      }
                      if (Math.abs(e.x - player.x) < (e.renderW + player.width)/2 && Math.abs(e.y - player.y) < (e.renderH + player.height)/2) { enemies.splice(i, 1); player.hp -= 20; triggerShake(); playSound('explosion'); }
                      if (e.y > canvas.height + 50) enemies.splice(i, 1);
                  }

                  if (boss) {
                      const scale = getScale(boss.y); boss.renderW = boss.width * scale; boss.renderH = boss.height * scale;
                      if (boss.phase === 'enter') { boss.y += 1; if (boss.y > 100) boss.phase = 'attack'; } 
                      else { boss.x += boss.vx; if (boss.x > canvas.width - 50 || boss.x < 50) boss.vx *= -1; if (Math.random() < 0.05) { const angle = Math.atan2(player.y - boss.y, player.x - boss.x); bullets.push({ x: boss.x, y: boss.y + 40, vy: Math.sin(angle)*6, vx: Math.cos(angle)*6, type: 'enemy', width: 8, height: 8, color: '#f0f' }); } }
                      
                      for (let j = bullets.length - 1; j >= 0; j--) { 
                          let b = bullets[j]; 
                          if (boss && b.type === 'player' && Math.abs(b.x - boss.x) < boss.renderW/2 && Math.abs(b.y - boss.y) < boss.renderH/2) { 
                              boss.hp--; bullets.splice(j, 1); playSound('boss_hit'); 
                              if (boss.hp <= 0) { 
                                  const deathX = boss.x; const deathY = boss.y;
                                  boss = null; 
                                  player.score += 1000; player.xp += 200; addCoins(50); setStats(s => ({ ...s, wave: s.wave + 1 })); playSound('win'); triggerShake(); 
                                  
                                  for(let k=0; k<50; k++) particles.push({ x: deathX, y: deathY, vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15, life: 40, color: 'gold', alpha: 1, type: 'spark' }); 
                                  particles.push({ x: deathX, y: deathY, vx: 0, vy: -2, life: 60, color: 'gold', alpha: 1, type: 'text', text: 'JACKPOT! +$1000', size: 32 });
                                  
                                  break;
                              } 
                          } 
                      }
                  }

                  for (let i = powerups.length - 1; i >= 0; i--) { let p = powerups[i]; p.y += 2; if (Math.abs(p.x - player.x) < 30 && Math.abs(p.y - player.y) < 30) { player.weaponLevel = Math.min(3, player.weaponLevel + 1); player.hp = Math.min(100, player.hp + 20); powerups.splice(i, 1); playSound('powerup'); } }
                  for (let i = bullets.length - 1; i >= 0; i--) { let b = bullets[i]; if (b.type === 'enemy' && Math.abs(b.x - player.x) < player.width/2 && Math.abs(b.y - player.y) < player.height/2) { player.hp -= 10; bullets.splice(i, 1); triggerShake(); playSound('explosion'); } }

                  if (player.xp >= player.level * 100) { player.xp -= player.level * 100; player.level++; playSound('levelup'); }
                  if (time % 60 === 0) { setStats({ score: player.score, hp: player.hp, wave: stats.wave, level: player.level, xp: player.xp }); }
                  if (player.hp <= 0) { setGameState('gameover'); }

                  ctx.clearRect(0, 0, canvas.width, canvas.height);
                  
                  // Render Particles
                  for (let i = particles.length - 1; i >= 0; i--) { 
                      let p = particles[i]; 
                      p.x += p.vx; p.y += p.vy; p.life--; 
                      ctx.globalAlpha = p.alpha ? (p.life / 20) * p.alpha : p.life / 20; 
                      
                      if (p.type === 'text') {
                          ctx.font = `bold ${p.size || 16}px "Rajdhani"`;
                          ctx.fillStyle = p.color;
                          ctx.textAlign = 'center';
                          ctx.fillText(p.text, p.x, p.y);
                      } else {
                          ctx.fillStyle = p.color; 
                          const size = p.size || 4;
                          ctx.fillRect(p.x, p.y, size, size); 
                      }
                      
                      if (p.life <= 0) particles.splice(i, 1); 
                  } 
                  ctx.globalAlpha = 1;

                  const pScale = getScale(player.y);
                  
                  ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.ellipse(player.x, player.y + 30*pScale, 15*pScale, 5*pScale, 0, 0, Math.PI*2); ctx.fill();
                  ctx.save(); ctx.translate(player.x, player.y); ctx.scale(pScale, pScale); ctx.rotate(player.bank); 
                  if (playerImg.complete) ctx.drawImage(playerImg, -20, -20, 40, 40); 
                  ctx.fillStyle = '#38bdf8'; ctx.globalAlpha = 0.6 + Math.random() * 0.4; ctx.beginPath(); ctx.arc(0, 15, 5, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1; ctx.restore();

                  // RENDER ENEMIES AS CRYPTO SYMBOLS
                  enemies.forEach(e => { 
                      // Shadow
                      ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.ellipse(e.x, e.y + e.renderH/2 + 5, e.renderW/3, e.renderH/5, 0, 0, Math.PI*2); ctx.fill(); 
                      
                      // Draw Coin Body
                      ctx.beginPath();
                      ctx.arc(e.x, e.y, e.renderW/2, 0, Math.PI*2);
                      ctx.fillStyle = e.bg || e.color; 
                      ctx.fill();
                      
                      // Border
                      ctx.lineWidth = 3;
                      ctx.strokeStyle = e.bg ? e.color : '#ffffff';
                      ctx.stroke();

                      // Symbol
                      ctx.font = `900 ${e.renderH * 0.6}px sans-serif`;
                      ctx.fillStyle = e.bg ? e.color : '#ffffff';
                      ctx.textAlign = 'center';
                      ctx.textBaseline = 'middle';
                      ctx.shadowBlur = 10;
                      ctx.shadowColor = e.color;
                      ctx.fillText(e.symbol, e.x, e.y + 2);
                      ctx.shadowBlur = 0;
                      
                      // HP Bar
                      ctx.fillStyle = 'red'; ctx.fillRect(e.x - e.renderW/2, e.y - e.renderH/2 - 5, e.renderW, 3); 
                      // Calculate maxHP roughly based on type or use a stored property if needed, simplified here
                      const maxHp = e.hp + 2; // Approximation visual only
                      ctx.fillStyle = 'lime'; ctx.fillRect(e.x - e.renderW/2, e.y - e.renderH/2 - 5, e.renderW * Math.min(1, Math.max(0, e.hp / maxHp)), 3); 
                  });

                  if (boss) { 
                      // BOSS IS A GIANT BANK OR COIN
                      ctx.shadowBlur = 20; ctx.shadowColor = 'gold';
                      ctx.fillStyle = '#ffd700';
                      ctx.font = `900 ${boss.renderW}px sans-serif`;
                      ctx.textAlign = 'center';
                      ctx.textBaseline = 'middle';
                      ctx.fillText('üè¶', boss.x, boss.y); // Bank Emoji
                      ctx.shadowBlur = 0;
                      
                      // Boss HP
                      ctx.fillStyle = 'gray'; ctx.fillRect(boss.x - 50, boss.y - 80, 100, 8); 
                      ctx.fillStyle = '#d946ef'; ctx.fillRect(boss.x - 50, boss.y - 80, 100 * (boss.hp / boss.maxHp), 8); 
                      ctx.strokeStyle = 'white'; ctx.strokeRect(boss.x - 50, boss.y - 80, 100, 8); 
                  }
                  
                  bullets.forEach(b => { ctx.fillStyle = b.color; ctx.shadowBlur = 5; ctx.shadowColor = b.color; ctx.fillRect(b.x - b.width/2, b.y - b.height/2, b.width, b.height); ctx.shadowBlur = 0; });
                  powerups.forEach(p => { ctx.fillStyle = '#0ff'; ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke(); });

                  if (gameStateRef.current === 'playing') animationFrameId = requestAnimationFrame(() => update(Date.now()));
              };

              const handleResize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }; window.addEventListener('resize', handleResize); handleResize(); update(Date.now());
              const onTouchMove = (e) => { e.preventDefault(); input = { x: e.touches[0].clientX, y: e.touches[0].clientY, active: true }; };
              const onMouseMove = (e) => { input = { x: e.clientX, y: e.clientY, active: true }; };
              const onEnd = () => { input.active = false; };
              canvas.addEventListener('touchmove', onTouchMove, { passive: false }); canvas.addEventListener('touchend', onEnd); canvas.addEventListener('mousemove', onMouseMove); canvas.addEventListener('mouseup', onEnd);
              return () => { window.removeEventListener('resize', handleResize); cancelAnimationFrame(animationFrameId); canvas.removeEventListener('touchmove', onTouchMove); };
          }, [equippedShipId, gameState]);

          return (
              <div className={`relative w-full h-full space-3d ${shake ? 'shake' : ''}`}>
                  <div className="grid-floor"></div>
                  <canvas ref={canvasRef} className="block w-full h-full relative z-10" />
                  <div className="absolute top-0 w-full p-4 flex justify-between items-start z-20 pointer-events-none safe-area-padding">
                      <div className="flex flex-col gap-1">
                          <div className="text-sm font-bold text-cyan-400 drop-shadow">SCORE: {stats.score}</div>
                          <div className="flex items-center gap-1"><Heart size={16} className="text-green-400" /><div className="w-32 h-3 bg-gray-800 rounded border border-gray-600"><div className={`h-full transition-all ${stats.hp > 30 ? 'bg-green-500' : 'bg-red-500'}`} style={{ width: `${Math.max(0, stats.hp)}%` }}></div></div></div>
                      </div>
                      <div className="flex flex-col items-end gap-1">
                          <button onClick={() => { playSound('ui_click'); setGameState(g => g === 'paused' ? 'playing' : 'paused'); }} className="pointer-events-auto p-2 bg-white/10 rounded-full mb-2"><Pause size={20} /></button>
                          <div className="text-xs font-bold text-purple-400">WAVE {stats.wave}</div>
                          <div className="text-xs font-bold text-yellow-400">LVL {stats.level}</div>
                          <div className="w-24 h-1 bg-gray-800 rounded"><div className="h-full bg-yellow-400" style={{ width: `${Math.min(100, (stats.xp / (stats.level*100))*100)}%` }}></div></div>
                      </div>
                  </div>
                  {gameState === 'paused' && (
                      <div className="absolute inset-0 bg-black/60 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
                          <h2 className="text-4xl font-bold text-white mb-6 tracking-widest">PAUSED</h2>
                          <button onClick={() => { playSound('ui_click'); setGameState('playing'); }} className="px-8 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-bold mb-4 w-48">RESUME</button>
                          <button onClick={() => { playSound('ui_click'); onBack(); }} className="px-8 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-bold w-48">EXIT</button>
                      </div>
                  )}
                  {gameState === 'gameover' && (
                      <div className="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center animate-fade-in">
                          <Skull size={64} className="text-red-500 mb-4 animate-pulse" />
                          <h2 className="text-5xl font-bold text-red-500 mb-2 neon-title">MISSION FAILED</h2>
                          <div className="text-2xl text-white mb-8">Final Score: <span className="text-yellow-400">{stats.score}</span></div>
                          <div className="flex flex-col gap-4 w-64">
                              <button onClick={() => { playSound('ui_click'); handleRespawn(); }} className="w-full py-4 bg-green-600 hover:bg-green-500 rounded-xl font-bold text-white flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(34,197,94,0.4)] transition-transform hover:scale-105"><PlayCircle size={24} /> REVIVE (AD)</button>
                              <button onClick={() => { playSound('ui_click'); setStats({ score: 0, wave: 1, xp: 0, level: 1, hp: 100 }); setGameState('playing'); }} className="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-white flex items-center justify-center gap-2"><RefreshCw size={20} /> RESTART MISSION</button>
                              <button onClick={() => { playSound('ui_click'); onBack(); }} className="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-gray-300">RETURN TO BASE</button>
                          </div>
                      </div>
                  )}
              </div>
          );
      };

      const GalaxyMenu = ({ onStart, onShop, onBack, coins }) => (
          <div className="w-full h-full flex flex-col items-center justify-center relative premium-bg safe-area-padding">
               <div className="z-10 flex flex-col items-center gap-8 w-full max-w-md px-4 animate-fade-in">
                   <div className="relative">
                      <Rocket size={100} className="text-blue-500 drop-shadow-[0_0_30px_rgba(59,130,246,0.8)] animate-float" />
                      <div className="absolute -inset-8 bg-blue-500/20 blur-2xl rounded-full"></div>
                   </div>
                   <h1 className="text-4xl md:text-6xl font-black text-center hero-title leading-tight drop-shadow-[0_0_10px_rgba(59,130,246,0.6)]">INVASOR<br/><span className="text-blue-400">GAL√ÅCTICO</span></h1>
                   <div className="flex items-center gap-3 bg-black/60 px-6 py-3 rounded-full border border-yellow-500/30 shadow-[0_0_20px_rgba(234,179,8,0.1)]">
                        <Coins size={24} className="text-yellow-400 drop-shadow-[0_0_10px_gold]" />
                        <span className="font-bold text-2xl text-yellow-400 tracking-wider">{coins}</span>
                   </div>
                   <div className="w-full grid gap-6 mt-8">
                       <button onClick={() => { playSound('ui_click'); onStart(); }} onMouseEnter={() => playSound('ui_hover')} className="glass-card-gold w-full h-24 rounded-2xl flex items-center justify-center gap-4 text-2xl font-bold tracking-widest group border border-white/20 hover:bg-white/10">
                            <span className="group-hover:text-blue-400 transition-colors">INICIAR MISS√ÉO</span>
                            <ChevronLeft className="rotate-180 group-hover:translate-x-2 transition-transform" size={28} />
                       </button>
                       <button onClick={() => { playSound('ui_click'); onShop(); }} onMouseEnter={() => playSound('ui_hover')} className="glass-card w-full h-20 rounded-2xl flex items-center justify-center gap-4 text-xl font-bold tracking-wider text-yellow-400 group border border-yellow-600/30 hover:bg-yellow-900/10">
                            <ShoppingCart size={24} />
                            <span>LOJA DE NAVES</span>
                       </button>
                   </div>
                   <button onClick={() => { playSound('ui_click'); onBack(); }} className="mt-8 flex items-center gap-2 text-gray-400 hover:text-white transition uppercase text-sm font-bold tracking-widest px-6 py-3 hover:bg-white/5 rounded-full border border-transparent hover:border-white/10"><ChevronLeft size={16} /> Voltar ao Hub</button>
               </div>
               <button onClick={toggleFullScreen} className="absolute top-6 right-6 p-3 bg-white/10 hover:bg-white/20 rounded-full transition text-gray-400 hover:text-white"><Maximize size={24}/></button>
          </div>
      );

      // --- COMPONENT: Shop Screen ---
      const ShopScreen = ({ adProgress, handleShipAdWatch, equipShip, unlockedShips, equippedShip, onBack }) => {
          const ShipCard = ({ ship }) => {
              const isUnlocked = unlockedShips.includes(ship.id);
              const isEquipped = equippedShip === ship.id;
              const spriteUrl = useMemo(() => generatePlayerSprite(ship.palette).src, [ship]);
              const currentAds = adProgress[ship.id] || 0;
              const reqAds = ship.adCost;

              const handleAction = () => {
                  if (isUnlocked) {
                      equipShip(ship.id);
                      playSound('powerup');
                  } else {
                      // Trigger Direct Link via click and give reward
                      triggerAd(() => {
                          handleShipAdWatch(ship.id, reqAds);
                          playSound('buy');
                      });
                  }
              };

              return (
                  <div className={`glass-card relative rounded-xl p-4 flex flex-col items-center gap-3 transition-transform ${isEquipped ? 'border-green-500 border-2 shadow-[0_0_15px_rgba(34,197,94,0.5)]' : ''}`}>
                      <div className="text-sm font-bold text-gray-300">{ship.name}</div>
                      <div className="w-16 h-16 bg-black/50 rounded-lg flex items-center justify-center relative overflow-hidden">
                           <img src={spriteUrl} className="w-12 h-12 rendering-pixelated" alt={ship.name} />
                           {!isUnlocked && (
                               <div className="absolute inset-0 bg-black/60 flex items-center justify-center">
                                   <Lock size={20} className="text-gray-400" />
                               </div>
                           )}
                      </div>
                      
                      {isUnlocked ? (
                          <button 
                              onClick={handleAction}
                              disabled={isEquipped}
                              className={`w-full py-2 rounded font-bold text-xs flex items-center justify-center gap-1
                                  ${isEquipped ? 'bg-green-600/50 text-white cursor-default' : 'bg-blue-600 hover:bg-blue-500 text-white'}`}
                          >
                              {isEquipped ? <><Check size={12} /> EQUIPADO</> : 'SELECIONAR'}
                          </button>
                      ) : (
                          <div className="w-full flex flex-col gap-1">
                              <button 
                                  onClick={handleAction}
                                  className={`w-full py-2 rounded font-bold text-xs flex items-center justify-center gap-1 bg-yellow-600 hover:bg-yellow-500 text-white`}
                              >
                                  <PlayCircle size={12} /> ASSISTIR AD ({currentAds}/{reqAds})
                              </button>
                              <div className="w-full h-1 bg-gray-700 rounded-full overflow-hidden">
                                  <div className="h-full bg-yellow-400" style={{ width: `${Math.min(100, (currentAds / reqAds) * 100)}%` }}></div>
                              </div>
                          </div>
                      )}
                  </div>
              );
          };

          return (
              <div className="w-full h-full bg-[#050505] flex flex-col premium-bg safe-area-padding">
                   <div className="p-4 flex items-center justify-between bg-black/50 backdrop-blur border-b border-gray-800">
                      <button onClick={onBack} className="p-2 rounded-full hover:bg-white/10"><ChevronLeft /></button>
                      <h1 className="text-xl font-bold hero-title">LOJA DE NAVES</h1>
                      <div className="w-10"></div>
                   </div>
                   
                   <div className="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-3 gap-4 pb-20">
                       {SHIPS.map(ship => (
                           <ShipCard key={ship.id} ship={ship} />
                       ))}
                   </div>
              </div>
          );
      };

      // --- GAME 2: CRYPTO MINING FARM (PIXEL ART) ---
      const CryptoFarmGame = ({ onBack, addCoins, coins }) => {
          const MACHINES = { 
              'usb_miner': { id: 'usb_miner', name: 'USB Miner', cost: 10, rate: 0.1, duration: 3000, icon: <div className="w-full h-full bg-gray-700 rounded flex items-center justify-center border-2 border-gray-600 relative overflow-hidden"><div className="w-2 h-4 bg-gray-400 absolute top-1"></div><div className="pixel-led w-1 h-1 bg-green-500 absolute bottom-2 rounded-full"></div></div>, type: 'basic', color: '#94a3b8' }, 
              'gpu_rig': { id: 'gpu_rig', name: 'GPU Rig', cost: 50, rate: 0.5, duration: 5000, icon: <div className="w-full h-full bg-gray-900 border-2 border-gray-700 p-1 flex gap-1 relative"><div className="w-3 h-full bg-gray-800 border border-gray-600 flex flex-col justify-center items-center"><Fan size={10} className="text-cyan-400 pixel-fan" /></div><div className="w-3 h-full bg-gray-800 border border-gray-600 flex flex-col justify-center items-center"><Fan size={10} className="text-cyan-400 pixel-fan" /></div><div className="pixel-led-fast w-1 h-1 bg-cyan-400 absolute top-0.5 right-0.5 shadow-[0_0_5px_cyan]"></div></div>, type: 'gpu', color: '#22d3ee' },
              'asic_miner': { id: 'asic_miner', name: 'ASIC Miner', cost: 200, rate: 2.5, duration: 8000, icon: <div className="w-full h-full bg-slate-800 border-2 border-yellow-700 flex flex-col items-center justify-center relative"><div className="w-8 h-2 bg-yellow-900 mb-1"></div><Fan size={16} className="text-yellow-500 pixel-fan" /><div className="pixel-led w-8 h-1 bg-red-500 mt-1"></div></div>, type: 'asic', color: '#eab308' },
              'server_rack': { id: 'server_rack', name: 'Server Rack', cost: 1000, rate: 15, duration: 15000, icon: <div className="w-full h-full bg-black border-2 border-green-800 flex flex-col justify-evenly p-0.5"><div className="h-1 w-full bg-green-900 pixel-led-fast"></div><div className="h-1 w-full bg-green-900 pixel-led"></div><div className="h-1 w-full bg-green-900 pixel-led-fast"></div><Server size={20} className="text-green-500 absolute opacity-50" /></div>, type: 'server', color: '#22c55e' },
              'quantum_pc': { id: 'quantum_pc', name: 'Quantum PC', cost: 5000, rate: 100, duration: 30000, icon: <div className="w-full h-full bg-indigo-950 border-2 border-indigo-500 flex items-center justify-center relative overflow-hidden"><div className="absolute inset-0 bg-indigo-500/20 animate-pulse"></div><Cpu size={24} className="text-indigo-400 relative z-10" /><div className="pixel-led-fast w-1 h-1 bg-white absolute top-1 right-1 shadow-[0_0_5px_white]"></div></div>, type: 'quantum', color: '#818cf8' }
          };
          
          const [grid, setGrid] = useState(() => { try { return JSON.parse(localStorage.getItem('crypto_grid_v1') || '[]'); } catch { return []; } });
          const [selectedMachine, setSelectedMachine] = useState('usb_miner'); 
          const [now, setNow] = useState(Date.now()); 
          const [landLevel, setLandLevel] = useState(() => { try { return parseInt(localStorage.getItem('crypto_land') || '6'); } catch { return 6; } });
          const [hashRate, setHashRate] = useState(0);

          // Calculate Hashrate
          useEffect(() => {
              const rate = grid.reduce((acc, plot) => acc + (plot.machine ? MACHINES[plot.machine].rate : 0), 0);
              setHashRate(rate);
          }, [grid]);

          useEffect(() => { 
              if (grid.length < landLevel) { 
                  const newGrid = [...grid]; 
                  while(newGrid.length < landLevel) newGrid.push({ id: Date.now() + Math.random(), machine: null, plantedAt: null }); 
                  setGrid(newGrid); 
              } 
              const interval = setInterval(() => setNow(Date.now()), 100); 
              return () => clearInterval(interval); 
          }, [landLevel]);

          useEffect(() => safeStorage.setItem('crypto_grid_v1', JSON.stringify(grid)), [grid]); 
          useEffect(() => safeStorage.setItem('crypto_land', landLevel.toString()), [landLevel]);

          const handlePlotClick = (index) => { 
            const plot = grid[index]; 
            
            // If slot has machine -> Collect or Upgrade check
            if (plot.machine) { 
                const def = MACHINES[plot.machine];
                const elapsed = now - plot.plantedAt;
                const progress = Math.min(100, (elapsed / def.duration) * 100);
                
                // If ready to collect
                if (progress >= 100) {
                    const reward = def.rate * (def.duration / 1000); // Base reward calculation
                    if (supabase && navigator.onLine) { supabase.rpc('add_coins', { amount: reward }).then(({ error }) => { if (!error) addCoins(reward); else addCoins(reward); }); } 
                    else { addCoins(reward); } 
                    
                    playSound('harvest');
                    const newGrid = [...grid]; 
                    newGrid[index] = { ...plot, plantedAt: now }; // Reset timer, keep machine
                    setGrid(newGrid);
                    
                    // Show floating text effect (simplified)
                    // In a real implementation, we'd add a floating text element here
                } else {
                    // Not ready, maybe replace?
                    const selectedDef = MACHINES[selectedMachine];
                    if (coins >= selectedDef.cost && selectedMachine !== plot.machine) {
                        // Ask to replace? For now, just direct replace if affordable and different
                        // Or simple mode: click empty to buy, click full to collect.
                        // To keep it simple: You can only replace if you select a machine from shop and click.
                        // But to prevent accidental replace, let's say you can only replace if you have enough money AND confirms?
                        // Let's stick to "Click to Collect". To replace, maybe we need a dedicated "Sell" mode or overwrite.
                        // For MVP: Clicking with a selected machine on an occupied slot REPLACES it if affordable.
                        if (window.confirm(`Substituir ${def.name} por ${selectedDef.name} por ${selectedDef.cost} moedas?`)) {
                             if (coins >= selectedDef.cost) {
                                addCoins(-selectedDef.cost);
                                playSound('buy');
                                const newGrid = [...grid];
                                newGrid[index] = { ...plot, machine: selectedMachine, plantedAt: now };
                                setGrid(newGrid);
                             } else {
                                 playSound('lose');
                             }
                        }
                    } else {
                        playSound('scan'); // Just a sound feedback
                    }
                }
            } else { 
                // Empty slot -> Buy Machine
                const item = MACHINES[selectedMachine]; 
                if (coins >= item.cost) { 
                    addCoins(-item.cost); 
                    playSound('plant'); // Mechanical sound
                    const newGrid = [...grid]; 
                    newGrid[index] = { ...plot, machine: selectedMachine, plantedAt: now }; 
                    setGrid(newGrid); 
                } else { 
                    playSound('lose'); 
                } 
            } 
          };
          
          const handleExpand = () => { 
              triggerAd(() => {
                setLandLevel(prev => prev + 2); 
                playSound('buy');
              });
          };

          return (
              <div className="w-full h-full server-room-scene flex flex-col overflow-hidden relative text-white font-sans safe-area-padding">
                   {/* Top Bar */}
                   <div className="absolute top-0 w-full p-4 flex flex-col gap-2 z-40 bg-gradient-to-b from-black/90 to-transparent pointer-events-none">
                       <div className="flex justify-between items-start">
                           <button onClick={() => { playSound('ui_click'); onBack(); }} className="pointer-events-auto p-2 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur"><ChevronLeft /></button>
                           <div className="flex flex-col items-center">
                               <div className="flex items-center gap-2 mb-1 bg-black/50 px-3 py-1 rounded border border-green-500/30">
                                   <Activity size={16} className="text-green-500 animate-pulse" />
                                   <div className="text-xs font-mono text-green-400">{hashRate.toFixed(1)} MH/s</div>
                               </div>
                           </div>
                           <div className="flex items-center gap-2">
                               <div className="bg-yellow-500/80 px-4 py-1.5 rounded-full font-bold text-white shadow-[0_0_15px_rgba(234,179,8,0.5)] border border-yellow-300 flex items-center gap-2">
                                   <Coins size={16} className="text-white fill-white" /> {coins.toFixed(2)}
                               </div>
                           </div>
                       </div>
                   </div>
                   
                   {/* Main Game Area - Shelf/Rack View */}
                   <div className="flex-1 flex items-center justify-center farm-perspective relative overflow-hidden">
                       <div 
                            className="farm-grid-3d grid grid-cols-2 gap-x-4 gap-y-8 p-6 relative origin-center max-w-lg" 
                            style={{ 
                                transform: 'perspective(800px) rotateX(10deg) translateY(-20px)',
                                width: 'fit-content'
                            }}
                       >
                           {/* Ambient Lighting */}
                           <div className="absolute inset-0 bg-blue-500/5 blur-3xl rounded-full pointer-events-none"></div>
                           
                           {grid.map((plot, i) => { 
                               const def = plot.machine ? MACHINES[plot.machine] : null;
                               const progress = def ? Math.min(100, ((now - plot.plantedAt)/def.duration)*100) : 0; 
                               const isReady = progress >= 100; 
                               
                               return (
                                   <div 
                                      key={i} 
                                      onClick={(e) => { e.stopPropagation(); handlePlotClick(i); }} 
                                      className={`w-32 h-24 rounded-t-lg miner-slot relative group cursor-pointer transition-transform active:scale-95 flex items-end justify-center ${isReady ? 'border-green-400 shadow-[0_0_20px_rgba(34,197,94,0.4)]' : ''}`}
                                   >
                                       {/* Base / Empty */}
                                       {!def && <div className="text-gray-600 font-mono text-[10px] opacity-50 mb-4">ESPA√áO VAZIO</div>}

                                       {/* Machine Sprite */}
                                       {def && (
                                           <div className="w-full h-full p-2 relative">
                                               {/* Visual Representation */}
                                               <div className="w-full h-full transform transition-transform hover:-translate-y-1 duration-200">
                                                   {def.icon}
                                               </div>
                                               
                                               {/* Mining Progress Bar (Small) */}
                                               {!isReady && (
                                                   <div className="absolute top-1 left-2 right-2 h-1 bg-black rounded-full overflow-hidden border border-white/10">
                                                       <div className="h-full bg-green-500" style={{ width: `${progress}%` }}></div>
                                                   </div>
                                               )}

                                               {/* Ready Indicator */}
                                               {isReady && (
                                                   <div className="absolute -top-6 left-1/2 -translate-x-1/2 animate-bounce drop-shadow-[0_0_5px_gold]">
                                                       <div className="bg-yellow-500 text-black font-bold text-[10px] px-2 py-0.5 rounded-full border border-white">
                                                           COLETAR
                                                       </div>
                                                   </div>
                                               )}
                                           </div>
                                       )}
                                   </div>
                               ); 
                           })}
                           
                           {/* Add Plot Button (Visual only, mapped to expand logic) */}
                           <div onClick={handleExpand} className="w-32 h-24 rounded-t-lg border-2 border-dashed border-gray-700 flex flex-col items-center justify-center cursor-pointer hover:border-green-500 hover:text-green-500 text-gray-600 transition-colors bg-black/20 relative" style={{ transform: 'rotateZ(0deg)' }}>
                               <PlusCircle size={24} />
                               <span className="text-[8px] font-bold mt-1">EXPANDIR (AD)</span>
                               {/* Shelf Graphic for Add Button too */}
                               <div className="absolute -bottom-3 -left-[10%] w-[120%] h-3 bg-[#475569] border-t-2 border-[#94a3b8] border-b-4 border-[#1e293b] rounded-sm shadow-lg"></div>
                           </div>
                       </div>
                   </div>
                   
                   {/* Shop Bar */}
                   <div className="h-44 w-full z-40 flex flex-col bg-black/80 border-t border-gray-800 backdrop-blur-md">
                       <div className="px-4 py-2 border-b border-gray-800 flex justify-between items-center">
                           <div className="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">
                               <ShoppingCart size={14} /> LOJA DE HARDWARE
                           </div>
                       </div>
                       <div className="flex-1 overflow-x-auto flex gap-3 p-4 items-center">
                           {Object.values(MACHINES).map(item => (
                               <button 
                                   key={item.id} 
                                   onClick={() => { setSelectedMachine(item.id); playSound('ui_click'); }} 
                                   className={`flex-shrink-0 w-24 h-28 rounded-xl flex flex-col items-center justify-between p-2 border transition-all active:scale-95 relative overflow-hidden ${selectedMachine === item.id ? 'border-green-500 bg-green-900/20 shadow-[0_0_10px_rgba(34,197,94,0.2)]' : 'border-gray-700 bg-gray-900/50 hover:border-gray-500'}`}
                               >
                                   <div className="w-10 h-10 mt-1">{item.icon}</div>
                                   <div className="text-center w-full">
                                       <div className="text-[10px] font-bold text-white uppercase tracking-tighter truncate w-full">{item.name}</div>
                                       <div className="text-[9px] text-gray-400 font-mono">+{item.rate} MH/s</div>
                                   </div>
                                   <div className="text-[10px] text-yellow-400 font-bold bg-black/60 px-2 py-0.5 rounded w-full text-center border border-yellow-500/20">
                                       ${item.cost}
                                   </div>
                               </button>
                           ))}
                       </div>
                   </div>
              </div>
          );
      };

      // --- GAME 6: FLAPPY COIN ---
      const FlappyCoinGame = ({ onBack, addCoins }) => {
          const canvasRef = useRef(null);
          const [gameState, setGameState] = useState('start'); // start, playing, gameover
          const [score, setScore] = useState(0);
          
          const GRAVITY = 0.3;
          const JUMP = -6;
          const SPEED = 3;
          const GAP = 200;
          const PIPE_WIDTH = 60;
          
          const gameRef = useRef({
              player: { y: 300, velocity: 0, radius: 15 },
              pipes: [],
              frame: 0,
              score: 0
          });

          // Reset Logic
          const resetGame = () => {
              gameRef.current = {
                  player: { y: 300, velocity: 0, radius: 15 },
                  pipes: [],
                  frame: 0,
                  score: 0
              };
              setScore(0);
              setGameState('start');
          };

          const handleJump = useCallback(() => {
              if (gameState === 'start') setGameState('playing');
              if (gameState !== 'playing') return;
              
              gameRef.current.player.velocity = JUMP;
              playSound('jump');
          }, [gameState]);

          useEffect(() => {
              const canvas = canvasRef.current;
              const ctx = canvas.getContext('2d');
              let animationFrameId;

              const loop = () => {
                  const { player, pipes, frame } = gameRef.current;
                  
                  // Clear canvas
                  ctx.fillStyle = '#111827'; // Dark financial bg
                  ctx.fillRect(0, 0, canvas.width, canvas.height);
                  
                  // Draw Background Chart Grid
                  ctx.strokeStyle = '#1f2937';
                  ctx.lineWidth = 1;
                  for(let i=0; i<canvas.width; i+=40) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, canvas.height); ctx.stroke(); }
                  for(let i=0; i<canvas.height; i+=40) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width, i); ctx.stroke(); }

                  // Draw Background Chart Line (Decorative)
                  ctx.strokeStyle = '#374151';
                  ctx.lineWidth = 2;
                  ctx.beginPath();
                  ctx.moveTo(0, canvas.height/2);
                  for(let i=0; i<canvas.width; i+=20) {
                       ctx.lineTo(i, canvas.height/2 + Math.sin(i/50 + frame/50) * 100);
                  }
                  ctx.stroke();

                  if (gameState === 'playing') {
                      // Update Player
                      player.velocity += GRAVITY;
                      player.y += player.velocity;
                      
                      // Spawning Pipes (Candles)
                      // Every 120 frames or so depending on width
                      if (frame % 100 === 0) {
                          const minHeight = 50;
                          const availableHeight = canvas.height - GAP - minHeight * 2;
                          const topHeight = Math.random() * availableHeight + minHeight;
                          pipes.push({ x: canvas.width, topHeight, passed: false });
                      }

                      // Update Pipes
                      for (let i = pipes.length - 1; i >= 0; i--) {
                          const p = pipes[i];
                          p.x -= SPEED;
                          
                          // Remove if off screen
                          if (p.x + PIPE_WIDTH < 0) {
                              pipes.splice(i, 1);
                              continue;
                          }
                          
                          // Collision Detection
                          // AABB collision logic (Circle vs Rect simplified to box)
                          const hitTop = player.y - player.radius < p.topHeight && player.x + player.radius > p.x && player.x - player.radius < p.x + PIPE_WIDTH;
                          const hitBottom = player.y + player.radius > p.topHeight + GAP && player.x + player.radius > p.x && player.x - player.radius < p.x + PIPE_WIDTH;
                          
                          if (hitTop || hitBottom || player.y + player.radius > canvas.height || player.y - player.radius < 0) {
                              setGameState('gameover');
                              playSound('lose');
                          }
                          
                          // Score
                          if (!p.passed && player.x > p.x + PIPE_WIDTH) {
                              p.passed = true;
                              gameRef.current.score += 1;
                              setScore(gameRef.current.score);
                              playSound('harvest'); // Ding sound
                              
                              if (gameRef.current.score % 10 === 0) {
                                  // Bonus coin every 10 points
                                  addCoins(1);
                              }
                          }
                      }
                      
                      gameRef.current.frame++;
                  }

                  // Render Pipes (Candles)
                  pipes.forEach(p => {
                      // Top Candle (Red - Resistance)
                      ctx.fillStyle = '#ef4444'; 
                      ctx.fillRect(p.x, 0, PIPE_WIDTH, p.topHeight);
                      // Wick
                      ctx.fillStyle = '#f87171';
                      ctx.fillRect(p.x + PIPE_WIDTH/2 - 1, p.topHeight - 10, 2, 20); // Small visual wick detail if wanted, or simple rect
                      // Bottom Candle (Green - Support)
                      ctx.fillStyle = '#22c55e';
                      ctx.fillRect(p.x, p.topHeight + GAP, PIPE_WIDTH, canvas.height - (p.topHeight + GAP));
                  });

                  // Render Player (Bitcoin)
                  ctx.save();
                  ctx.translate(player.x, player.y);
                  ctx.rotate(Math.min(Math.PI / 4, Math.max(-Math.PI / 4, (player.velocity * 0.1))));
                  
                  ctx.fillStyle = '#f59e0b'; // Gold
                  ctx.beginPath();
                  ctx.arc(0, 0, player.radius, 0, Math.PI*2);
                  ctx.fill();
                  
                  ctx.strokeStyle = '#fff';
                  ctx.lineWidth = 2;
                  ctx.stroke();
                  
                  ctx.fillStyle = '#fff';
                  ctx.font = 'bold 20px sans-serif';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'middle';
                  ctx.fillText('‚Çø', 0, 0);
                  
                  ctx.restore();

                  // Ground line (optional)
                  ctx.fillStyle = '#374151';
                  ctx.fillRect(0, canvas.height - 10, canvas.width, 10);

                  animationFrameId = requestAnimationFrame(loop);
              };
              
              const handleResize = () => {
                   canvas.width = window.innerWidth;
                   canvas.height = window.innerHeight;
                   // Adjust player X on resize
                   gameRef.current.player.x = canvas.width / 3;
              };
              window.addEventListener('resize', handleResize);
              handleResize();
              
              loop();
              return () => {
                  window.removeEventListener('resize', handleResize);
                  cancelAnimationFrame(animationFrameId);
              };
          }, [gameState, addCoins]);

          return (
              <div 
                className="w-full h-full relative overflow-hidden bg-gray-900 select-none" 
                onClick={handleJump}
              >
                  <canvas ref={canvasRef} className="block w-full h-full" />
                  
                  {/* UI Layer */}
                  <div className="absolute top-0 w-full p-6 flex justify-between items-start pointer-events-none safe-area-padding">
                      <button onClick={(e) => { e.stopPropagation(); onBack(); }} className="pointer-events-auto p-3 bg-white/10 rounded-full backdrop-blur text-white hover:bg-white/20 z-50">
                          <ChevronLeft size={24} />
                      </button>
                      <div className="flex flex-col items-center pointer-events-none">
                          <h1 className="text-4xl font-bold font-mono text-white drop-shadow-md">{score}</h1>
                          <div className="text-xs text-green-400 font-bold tracking-widest uppercase">PONTOS</div>
                      </div>
                      <div className="w-12"></div>
                  </div>

                  {/* Start Screen */}
                  {gameState === 'start' && (
                      <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/40 backdrop-blur-sm z-40 pointer-events-none">
                          <div className="bg-black/80 p-8 rounded-2xl border border-yellow-500/30 text-center animate-bounce">
                              <ArrowUp size={48} className="text-yellow-400 mx-auto mb-2" />
                              <h2 className="text-2xl font-bold text-white mb-2">TOQUE PARA VOAR</h2>
                              <p className="text-gray-400 text-sm">Desvie dos gr√°ficos!</p>
                          </div>
                      </div>
                  )}

                  {/* Game Over Screen */}
                  {gameState === 'gameover' && (
                      <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur animate-fade-in p-4">
                          <div className="bg-gray-900 border border-red-500/30 p-8 rounded-2xl text-center shadow-2xl max-w-sm w-full" onClick={(e) => e.stopPropagation()}>
                              <TrendingDown size={64} className="text-red-500 mx-auto mb-4" />
                              <h2 className="text-3xl font-bold text-white mb-2 hero-title">MERCADO CAIU!</h2>
                              <p className="text-gray-400 mb-6">Pontua√ß√£o Final: <span className="text-white font-bold text-xl">{score}</span></p>
                              
                              <button 
                                  onClick={(e) => { 
                                      e.stopPropagation(); 
                                      triggerAd(() => {
                                          resetGame();
                                          playSound('ui_click');
                                      });
                                  }} 
                                  className="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg uppercase tracking-wider mb-3 flex items-center justify-center gap-2 shadow-lg"
                              >
                                  <RefreshCw size={20} /> TENTAR NOVAMENTE
                              </button>
                              
                              <button onClick={(e) => { e.stopPropagation(); onBack(); }} className="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white font-bold rounded-lg uppercase tracking-wider">
                                  VOLTAR AO MENU
                              </button>
                          </div>
                      </div>
                  )}
              </div>
          );
      };

      // --- GAME 8: NEON CARDS (UNO STYLE) ---
      const UnoGame = ({ onBack, addCoins }) => {
          const COLORS = ['red', 'blue', 'green', 'yellow'];
          const NUMBERS = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '+2'];

          const createDeck = () => {
              let deck = [];
              COLORS.forEach(color => {
                  NUMBERS.forEach(value => {
                      deck.push({ id: Math.random(), color, value, type: 'number' });
                      if (value !== '0') deck.push({ id: Math.random(), color, value, type: 'number' });
                  });
              });
              for (let i = 0; i < 4; i++) {
                  deck.push({ id: Math.random(), color: 'wild', value: 'W', type: 'wild' });
                  deck.push({ id: Math.random(), color: 'wild', value: '+4', type: 'wild4' });
              }
              return deck.sort(() => Math.random() - 0.5);
          };

          const [deck, setDeck] = useState(createDeck());
          const [discardPile, setDiscardPile] = useState([]);
          const [playerHand, setPlayerHand] = useState([]);
          const [cpuHand, setCpuHand] = useState([]);
          const [turn, setTurn] = useState('player'); // 'player' | 'cpu'
          const [activeColor, setActiveColor] = useState(null);
          const [gameStatus, setGameStatus] = useState('start'); // start, playing, won, lost
          const [message, setMessage] = useState('');

          const initGame = () => {
              const newDeck = createDeck();
              const pHand = newDeck.splice(0, 7);
              const cHand = newDeck.splice(0, 7);
              const startCard = newDeck.shift();
              
              // Ensure start card isn't wild for simplicity
              if (startCard.color === 'wild') {
                  newDeck.push(startCard);
                  // Quick retry recursive or simple reload for simplicity in this constrained env
                  return initGame();
              }

              setDeck(newDeck);
              setPlayerHand(pHand);
              setCpuHand(cHand);
              setDiscardPile([startCard]);
              setActiveColor(startCard.color);
              setTurn('player');
              setGameStatus('playing');
              setMessage('Sua Vez!');
          };

          useEffect(() => {
              if (gameStatus === 'start') initGame();
          }, []);

          const drawCard = (targetHand, setTargetHand, count = 1) => {
              if (deck.length < count) {
                  // Reshuffle discard into deck if empty
                  if (discardPile.length > 1) {
                      const top = discardPile[discardPile.length - 1];
                      const newDeck = discardPile.slice(0, discardPile.length - 1).sort(() => Math.random() - 0.5);
                      setDiscardPile([top]);
                      setDeck(prev => [...prev, ...newDeck]);
                      // We'll let the next render cycle handle the draw
                      return;
                  } else {
                       setMessage("Sem cartas!");
                       return;
                  }
              }
              const drawn = deck.slice(0, count);
              setDeck(prev => prev.slice(count));
              setTargetHand(prev => [...prev, ...drawn]);
              playSound('move_piece');
              return drawn;
          };

          const handlePlayCard = (card) => {
              if (turn !== 'player' || gameStatus !== 'playing') return;

              const topCard = discardPile[discardPile.length - 1];
              const isMatch = card.color === activeColor || card.value === topCard.value || card.color === 'wild';

              if (isMatch) {
                  playSound('ui_click');
                  setPlayerHand(prev => prev.filter(c => c.id !== card.id));
                  setDiscardPile(prev => [...prev, card]);

                  // Special Card Logic
                  if (card.color === 'wild') {
                      // Auto-pick color based on most abundant color in hand to keep flow fast
                      const counts = { red: 0, blue: 0, green: 0, yellow: 0 };
                      playerHand.forEach(c => { if(c.color !== 'wild') counts[c.color]++; });
                      const bestColor = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
                      setActiveColor(bestColor);
                      setMessage(`Cor alterada para ${bestColor.toUpperCase()}!`);
                      if (card.value === '+4') {
                          drawCard(cpuHand, setCpuHand, 4);
                          setTurn('player'); // Skip opponent
                          return; // Keep turn
                      }
                  } else {
                      setActiveColor(card.color);
                      if (card.value === '+2') {
                          drawCard(cpuHand, setCpuHand, 2);
                          setTurn('player'); // Skip opponent
                          return;
                      }
                  }

                  if (playerHand.length === 1) { // Will be 0 after update
                      playSound('win');
                      setGameStatus('won');
                      addCoins(50);
                      return;
                  }
                  
                  if (playerHand.length === 2) {
                       playSound('scan'); // UNO alert sound
                       setMessage("UNO!");
                  }

                  setTurn('cpu');
              } else {
                  playSound('lose'); // Invalid move sound
              }
          };

          const handlePlayerDraw = () => {
              if (turn !== 'player') return;
              drawCard(playerHand, setPlayerHand, 1);
              setTurn('cpu');
          };

          // CPU Logic
          useEffect(() => {
              if (turn === 'cpu' && gameStatus === 'playing') {
                  setTimeout(() => {
                      const topCard = discardPile[discardPile.length - 1];
                      const validCards = cpuHand.filter(c => c.color === activeColor || c.value === topCard.value || c.color === 'wild');

                      if (validCards.length > 0) {
                          // Play Logic
                          // Prefer non-wilds first to save wilds
                          validCards.sort((a,b) => (a.color === 'wild' ? 1 : -1));
                          const cardToPlay = validCards[0];

                          setCpuHand(prev => prev.filter(c => c.id !== cardToPlay.id));
                          setDiscardPile(prev => [...prev, cardToPlay]);
                          playSound('move_piece');

                          if (cardToPlay.color === 'wild') {
                               const colors = ['red', 'blue', 'green', 'yellow'];
                               const randColor = colors[Math.floor(Math.random() * colors.length)];
                               setActiveColor(randColor);
                               setMessage(`CPU mudou para ${randColor.toUpperCase()}`);
                               if (cardToPlay.value === '+4') {
                                   drawCard(playerHand, setPlayerHand, 4);
                                   setTurn('cpu'); // CPU goes again (Skip player)
                                   return; 
                               }
                          } else {
                               setActiveColor(cardToPlay.color);
                               if (cardToPlay.value === '+2') {
                                   drawCard(playerHand, setPlayerHand, 2);
                                   setTurn('cpu'); 
                                   return;
                               }
                          }

                          if (cpuHand.length === 1) { // 0 after update
                              setGameStatus('lost');
                              playSound('lose');
                              return;
                          }
                          setTurn('player');
                      } else {
                          // Draw
                          drawCard(cpuHand, setCpuHand, 1);
                          setTurn('player');
                      }
                  }, 1500);
              }
          }, [turn, gameStatus, activeColor]); // Dependencies simplifed for effect

          const Card = ({ card, onClick, isFaceUp = true, isPlayable = false }) => {
              const gradients = {
                  red: 'bg-gradient-to-br from-red-500 to-red-800',
                  blue: 'bg-gradient-to-br from-blue-500 to-blue-900',
                  green: 'bg-gradient-to-br from-emerald-500 to-green-800',
                  yellow: 'bg-gradient-to-br from-yellow-400 to-amber-600',
                  wild: 'bg-[conic-gradient(at_center,_var(--tw-gradient-stops))] from-red-500 via-blue-500 to-green-500'
              };

              if (!isFaceUp) {
                  return (
                      <div className="w-16 h-24 md:w-20 md:h-28 rounded-xl bg-gradient-to-br from-slate-900 to-black border-2 border-slate-700 flex items-center justify-center shadow-lg relative overflow-hidden">
                           <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-30"></div>
                           <Layers className="text-gray-600" size={32} />
                      </div>
                  );
              }

              return (
                  <div 
                      onClick={() => isPlayable && onClick(card)}
                      className={`
                          w-16 h-24 md:w-20 md:h-28 rounded-xl ${gradients[card.color]} 
                          flex items-center justify-center shadow-xl border-2 border-white/20 
                          relative overflow-hidden transition-all duration-300
                          ${isPlayable ? 'cursor-pointer hover:-translate-y-4 hover:shadow-[0_0_20px_white]' : ''}
                      `}
                  >
                      {/* Gloss */}
                      <div className="absolute inset-0 bg-gradient-to-b from-white/20 to-transparent pointer-events-none"></div>
                      
                      {/* Center Content */}
                      <div className="w-10 h-10 md:w-14 md:h-14 bg-white/90 rounded-full flex items-center justify-center shadow-inner">
                          <span className={`text-xl md:text-2xl font-black ${card.color === 'wild' ? 'text-black' : `text-${card.color}-600`}`} style={{ color: card.color === 'wild' ? 'black' : '' }}>
                              {card.value}
                          </span>
                      </div>
                      
                      {/* Corner Numbers */}
                      <span className="absolute top-1 left-1 text-xs font-bold text-white drop-shadow-md">{card.value}</span>
                      <span className="absolute bottom-1 right-1 text-xs font-bold text-white drop-shadow-md rotate-180">{card.value}</span>
                  </div>
              );
          };

          return (
              <div className="w-full h-full bg-[#0a0a0a] flex flex-col relative overflow-hidden safe-area-padding">
                   {/* Background */}
                   <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-gray-900 via-black to-black"></div>
                   <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px)', backgroundSize: '50px 50px' }}></div>

                   {/* Header */}
                   <div className="w-full p-4 flex justify-between items-center z-20 bg-black/40 backdrop-blur border-b border-white/10">
                        <button onClick={onBack} className="p-2 rounded-full bg-white/10 text-white"><ChevronLeft /></button>
                        <div className="flex flex-col items-center">
                            <h1 className="text-xl font-bold font-['Rajdhani'] text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 tracking-widest drop-shadow-[0_0_10px_rgba(236,72,153,0.5)]">NEON CARDS</h1>
                            <div className="text-xs text-gray-400 font-mono">{message}</div>
                        </div>
                        <div className="w-10"></div> {/* Spacer */}
                   </div>

                   {/* Game Area */}
                   <div className="flex-1 flex flex-col items-center justify-between py-6 relative z-10">
                       
                       {/* CPU Hand */}
                       <div className="flex justify-center -space-x-4">
                           {cpuHand.map((c, i) => (
                               <div key={c.id} style={{ transform: `translateY(${i%2===0 ? '0' : '2px'})` }}>
                                   <Card card={c} isFaceUp={false} />
                               </div>
                           ))}
                       </div>

                       {/* Center Pile */}
                       <div className="flex items-center gap-8">
                           {/* Draw Pile */}
                           <div onClick={handlePlayerDraw} className={`cursor-pointer transition-transform active:scale-95 ${turn==='player' ? 'animate-pulse' : ''}`}>
                               <div className="w-20 h-28 rounded-xl bg-slate-900 border-2 border-slate-600 flex items-center justify-center shadow-2xl relative">
                                    <Layers className="text-slate-500" />
                                    <div className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 rounded-full">{deck.length}</div>
                               </div>
                               {turn === 'player' && <div className="text-[10px] text-center text-gray-400 mt-2 font-bold uppercase">COMPRAR</div>}
                           </div>

                           {/* Discard Pile */}
                           <div className="relative">
                               {discardPile.slice(-3).map((c, i) => (
                                   <div key={c.id} className="absolute top-0 left-0" style={{ transform: `rotate(${i * 5 - 10}deg)` }}>
                                       <Card card={c} />
                                   </div>
                               ))}
                               {/* Active Color Indicator */}
                               <div className={`absolute -bottom-8 left-1/2 -translate-x-1/2 w-16 h-1 rounded-full shadow-[0_0_10px_currentColor] transition-colors duration-500 
                                   ${activeColor === 'red' ? 'bg-red-500 text-red-500' : 
                                     activeColor === 'blue' ? 'bg-blue-500 text-blue-500' : 
                                     activeColor === 'green' ? 'bg-green-500 text-green-500' : 
                                     activeColor === 'yellow' ? 'bg-yellow-500 text-yellow-500' : 'bg-white text-white'}`}
                               ></div>
                           </div>
                       </div>

                       {/* Player Hand */}
                       <div className="flex justify-center -space-x-6 md:-space-x-4 px-4 overflow-x-auto w-full pb-4 pt-8">
                           {playerHand.map((c, i) => {
                               const topCard = discardPile[discardPile.length - 1];
                               const isPlayable = turn === 'player' && (c.color === activeColor || c.value === topCard.value || c.color === 'wild');
                               return (
                                   <div key={c.id} className="transform transition-transform hover:-translate-y-4 hover:z-10 origin-bottom" style={{ transform: `rotate(${(i - playerHand.length/2) * 5}deg)` }}>
                                       <Card card={c} isPlayable={isPlayable} onClick={handlePlayCard} />
                                   </div>
                               )
                           })}
                       </div>

                   </div>

                   {/* Game Over Modal */}
                   {gameStatus !== 'playing' && gameStatus !== 'start' && (
                       <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur animate-fade-in p-4">
                           <div className="bg-gradient-to-br from-gray-900 to-black p-8 rounded-2xl border border-white/10 text-center shadow-2xl max-w-sm w-full">
                               {gameStatus === 'won' ? (
                                   <>
                                       <Trophy size={64} className="text-yellow-400 mx-auto mb-4 animate-bounce" />
                                       <h2 className="text-3xl font-bold text-white mb-2 hero-title">VIT√ìRIA!</h2>
                                       <p className="text-gray-400 mb-6">+50 Moedas</p>
                                   </>
                               ) : (
                                   <>
                                       <Skull size={64} className="text-red-500 mx-auto mb-4" />
                                       <h2 className="text-3xl font-bold text-red-500 mb-2 hero-title">DERROTA</h2>
                                       <p className="text-gray-400 mb-6">A CPU venceu desta vez.</p>
                                   </>
                               )}
                               <button 
                                  onClick={() => { triggerAd(() => initGame()); playSound('ui_click'); }}
                                  className="w-full py-4 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg uppercase tracking-wider mb-3 flex items-center justify-center gap-2 shadow-lg"
                               >
                                  <RefreshCw size={20} /> JOGAR NOVAMENTE
                               </button>
                               <button onClick={onBack} className="w-full py-3 bg-white/5 hover:bg-white/10 text-white font-bold rounded-lg uppercase tracking-wider border border-white/10">
                                  VOLTAR AO MENU
                               </button>
                           </div>
                       </div>
                   )}
              </div>
          );
      };

      // --- GAME 3: HANGMAN (Luxurious Dark & Cyan) ---
      const HangmanGame = ({ onBack, addCoins }) => {
        const WORDS = [
          // TECH & DEV
          { word: "JAVASCRIPT", hint: "Linguagem da Web" },
          { word: "REACT", hint: "Biblioteca UI" },
          { word: "TYPESCRIPT", hint: "JS com tipos" },
          { word: "HTML", hint: "Estrutura Web" },
          { word: "CSS", hint: "Estilo Web" },
          { word: "DATABASE", hint: "Banco de dados" },
          { word: "SERVER", hint: "Servidor" },
          { word: "FRONTEND", hint: "Interface do usu√°rio" },
          { word: "BACKEND", hint: "L√≥gica do servidor" },
          { word: "API", hint: "Interface de Programa" },
          { word: "BUG", hint: "Erro no c√≥digo" },
          { word: "DEBUG", hint: "Corrigir erro" },
          { word: "COMPILADOR", hint: "Traduz c√≥digo" },
          { word: "LINUX", hint: "Sistema Operacional Livre" },
          { word: "WINDOWS", hint: "SO da Microsoft" },
          { word: "APPLE", hint: "Dona do iPhone" },
          { word: "ANDROID", hint: "SO do Google" },
          { word: "WIFI", hint: "Internet sem fio" },
          { word: "BLUETOOTH", hint: "Conex√£o azul" },
          { word: "ROUTER", hint: "Roteador" },
          { word: "FIREWALL", hint: "Parede de fogo" },
          { word: "VIRUS", hint: "Malware" },
          { word: "HACKER", hint: "Invade sistemas" },
          { word: "ENCRIPTAR", hint: "Proteger dados" },
          { word: "SENHA", hint: "C√≥digo secreto" },
          
          // SPACE & SCI-FI
          { word: "GALAXY", hint: "Via L√°ctea √© uma" },
          { word: "UNIVERSO", hint: "Tudo que existe" },
          { word: "ESTRELA", hint: "Sol √© uma" },
          { word: "PLANETA", hint: "Orbita estrela" },
          { word: "ASTEROIDE", hint: "Rocha espacial" },
          { word: "COMETA", hint: "Gelo sujo" },
          { word: "MARTE", hint: "Planeta Vermelho" },
          { word: "LUA", hint: "Sat√©lite da Terra" },
          { word: "FOGUETE", hint: "Ve√≠culo espacial" },
          { word: "GRAVIDADE", hint: "For√ßa de atra√ß√£o" },
          { word: "ALIEN", hint: "Extraterrestre" },
          { word: "UFO", hint: "Objeto Voador" },
          { word: "ROBO", hint: "M√°quina inteligente" },
          { word: "CYBORG", hint: "Meio homem, meio m√°quina" },
          { word: "LASER", hint: "Luz focada" },
          { word: "PLASMA", hint: "Estado da mat√©ria" },
          { word: "SOL", hint: "Nossa estrela" },
          { word: "NEBULOSA", hint: "Ber√ß√°rio de estrelas" },
          { word: "SUPERNOVA", hint: "Explos√£o estelar" },
          
          // GENERAL
          { word: "FAZENDA", hint: "Local rural" },
          { word: "TRATOR", hint: "Ve√≠culo agr√≠cola" },
          { word: "COLHEITA", hint: "Recolher frutos" },
          { word: "PLANTAR", hint: "Semear" },
          { word: "AGUA", hint: "H2O" },
          { word: "TERRA", hint: "Nosso planeta" },
          { word: "FOGO", hint: "Quente e queima" },
          { word: "AR", hint: "Respiramos" },
          { word: "VIDA", hint: "Contr√°rio de morte" },
          { word: "TEMPO", hint: "Rel√≥gio mede" },
          { word: "DINHEIRO", hint: "Moeda de troca" },
          { word: "OURO", hint: "Metal precioso" },
          { word: "DIAMANTE", hint: "Carbono duro" },
          { word: "ESCOLA", hint: "Lugar de aprender" },
          { word: "LIVRO", hint: "Tem p√°ginas" },
          { word: "MUSICA", hint: "Sons ritmados" },
          { word: "FILME", hint: "Cinema" },
          { word: "JOGO", hint: "Divers√£o" },
          { word: "AMIGO", hint: "Companheiro" }
        ];

        const getNewWord = () => {
            let playedWords = [];
            try {
                playedWords = JSON.parse(safeStorage.getItem('hangman_played') || '[]');
            } catch (e) { playedWords = []; }

            const available = WORDS.filter(w => !playedWords.includes(w.word));
            
            if (available.length === 0) {
                // All words played, reset history
                safeStorage.setItem('hangman_played', '[]');
                const rand = WORDS[Math.floor(Math.random() * WORDS.length)];
                safeStorage.setItem('hangman_played', JSON.stringify([rand.word]));
                return rand;
            }

            const rand = available[Math.floor(Math.random() * available.length)];
            
            // Mark as played
            playedWords.push(rand.word);
            safeStorage.setItem('hangman_played', JSON.stringify(playedWords));
            
            return rand;
        };

        const [game, setGame] = useState(() => {
           const rand = getNewWord();
           return { ...rand, guessed: [], errors: 0, status: 'playing' };
        });

        // --- PRESENTER LOGIC ---
        const [voiceEnabled, setVoiceEnabled] = useState(true);
        
        const speak = useCallback((text, force = false) => {
            if (!voiceEnabled && !force) return;
            try {
                window.speechSynthesis.cancel(); // Interrupt previous
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'pt-BR';
                u.rate = 1.1; // Slightly faster for excitement
                u.pitch = 1.0;
                
                // Attempt to find a Brazilian voice
                const voices = window.speechSynthesis.getVoices();
                // Prefer Google Portugu√™s do Brasil if available, or any pt-BR
                const ptVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('pt-BR')) || 
                                voices.find(v => v.lang === 'pt-BR') || 
                                voices.find(v => v.lang.includes('pt'));
                                
                if (ptVoice) u.voice = ptVoice;
                window.speechSynthesis.speak(u);
            } catch (e) { console.warn("Speech synthesis error", e); }
        }, [voiceEnabled]);

        // Intro
        useEffect(() => {
            const timer = setTimeout(() => {
                 speak("Ol√°! Bem vindo ao jogo da forca! Sou seu apresentador. Vamos descobrir a palavra secreta juntos!");
            }, 800);
            return () => { clearTimeout(timer); window.speechSynthesis.cancel(); };
        }, []);

        const handleGuess = (letter) => {
            if (game.status !== 'playing' || game.guessed.includes(letter)) return;
            
            const newGuessed = [...game.guessed, letter];
            const isError = !game.word.includes(letter);
            const newErrors = isError ? game.errors + 1 : game.errors;
            const isWin = game.word.split('').every(l => newGuessed.includes(l));
            const isLose = newErrors >= 6;
            
            playSound(isError ? 'ui_click' : 'powerup');
            
            // --- PRESENTER REACTION ---
            if (isWin) {
                playSound('win');
                addCoins(20);
                setTimeout(() => speak(`Incr√≠vel! Voc√™ venceu! A palavra era ${game.word}. Parab√©ns!`), 200);
            } else if (isLose) {
                playSound('lose');
                setTimeout(() => speak(`Ah que pena! Voc√™ foi enforcado. A palavra era ${game.word}. Tente na pr√≥xima!`), 200);
            } else if (isError) {
                const phrases = ["Errou!", "Essa n√£o tem!", "Cuidado com a forca!", "Tente outra letra!", "Ixi, errou feio!", "Preste aten√ß√£o!"];
                speak(phrases[Math.floor(Math.random() * phrases.length)]);
            } else {
                 const phrases = ["Muito bem!", "Acertou!", "Isso a√≠!", "Continue assim!", "Boa escolha!", "Essa tem!"];
                 speak(phrases[Math.floor(Math.random() * phrases.length)]);
            }

            setGame(prev => ({ ...prev, guessed: newGuessed, errors: newErrors, status: isWin ? 'won' : (isLose ? 'lost' : 'playing') }));
        };

        const handleRestart = () => {
            const rand = getNewWord();
            setGame({ ...rand, guessed: [], errors: 0, status: 'playing' });
            playSound('ui_click');
            speak("Novo jogo iniciado! Qual √© a palavra?");
        };

        const handleHint = () => {
             triggerAd(() => {
                 const hidden = game.word.split('').filter(l => !game.guessed.includes(l));
                 if (hidden.length > 0) {
                     const reveal = hidden[Math.floor(Math.random() * hidden.length)];
                     handleGuess(reveal);
                     speak("Aqui vai uma ajudinha!");
                 }
                 playSound('powerup');
             });
        };

        return (
            <div className="w-full h-full bg-[#020617] flex flex-col items-center justify-center relative overflow-hidden safe-area-padding">
                <div className="absolute inset-0 bg-gradient-to-b from-[#0f172a] via-[#020617] to-black"></div>
                
                {/* Cyan Glow Orbs */}
                <div className="absolute top-[-20%] left-[-20%] w-[50%] h-[50%] bg-cyan-500/5 rounded-full blur-[120px] pointer-events-none"></div>
                <div className="absolute bottom-[-20%] right-[-20%] w-[50%] h-[50%] bg-blue-600/5 rounded-full blur-[120px] pointer-events-none"></div>

                {/* 3D Grid Floor Effect - Cyan Tint */}
                <div className="absolute inset-0 opacity-20" style={{ 
                    backgroundImage: 'linear-gradient(rgba(34, 211, 238, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(34, 211, 238, 0.1) 1px, transparent 1px)', 
                    backgroundSize: '40px 40px',
                    transform: 'perspective(500px) rotateX(60deg) translateY(100px) scale(2)',
                    transformOrigin: 'bottom center',
                    maskImage: 'linear-gradient(to top, black 0%, transparent 60%)'
                }}></div>

                {/* Header UI */}
                <div className="absolute top-0 w-full p-6 flex justify-between items-start z-50">
                     <button onClick={() => { window.speechSynthesis.cancel(); onBack(); }} className="group flex items-center justify-center w-12 h-12 bg-black/40 backdrop-blur border border-cyan-500/20 rounded-full text-cyan-400 hover:bg-cyan-500/10 hover:border-cyan-400 hover:shadow-[0_0_15px_rgba(34,211,238,0.2)] transition-all duration-300"><ChevronLeft size={24} className="group-hover:-translate-x-1 transition-transform" /></button>
                     <div className="flex flex-col items-center">
                         <h1 className="text-2xl md:text-3xl font-bold font-['Rajdhani'] tracking-[0.2em] text-transparent bg-clip-text bg-gradient-to-b from-white to-cyan-400 drop-shadow-[0_0_10px_rgba(6,182,212,0.5)]">FORCA DE LUXO</h1>
                     </div>
                     <button onClick={() => setVoiceEnabled(!voiceEnabled)} className={`w-12 h-12 backdrop-blur border rounded-full transition-all duration-300 flex items-center justify-center ${voiceEnabled ? 'bg-cyan-950/30 border-cyan-400 text-cyan-400 shadow-[0_0_10px_rgba(34,211,238,0.2)]' : 'bg-black/40 border-slate-700 text-slate-500'}`}>
                        {voiceEnabled ? <Volume2 size={20} /> : <VolumeX size={20} />}
                     </button>
                </div>

                {/* Main Content */}
                 <div className="relative z-10 w-full max-w-2xl px-4 flex flex-col items-center">
                    
                    {/* Gallows Container */}
                    <div className="mb-8 relative">
                         <div className="w-56 h-56 rounded-full bg-[#050505]/60 backdrop-blur-md border border-cyan-500/20 shadow-[0_0_40px_rgba(6,182,212,0.05)] flex items-center justify-center relative z-10">
                            <div className="absolute inset-0 rounded-full opacity-10" style={{ backgroundImage: 'radial-gradient(circle, #22d3ee 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>
                            
                            <svg width="200" height="200" className="drop-shadow-[0_0_8px_rgba(34,211,238,0.3)]">
                                <path d="M40 180 L160 180 M80 180 L80 30 L160 30 L160 50" stroke="#22d3ee" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round" />
                                <g stroke="#ffffff" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round">
                                    {game.errors > 0 && <circle cx="160" cy="70" r="15" className="animate-[fadeIn_0.5s]" />}
                                    {game.errors > 1 && <path d="M160 85 L160 135" className="animate-[fadeIn_0.5s]" />}
                                    {game.errors > 2 && <path d="M160 95 L135 120" className="animate-[fadeIn_0.5s]" />}
                                    {game.errors > 3 && <path d="M160 95 L185 120" className="animate-[fadeIn_0.5s]" />}
                                    {game.errors > 4 && <path d="M160 135 L140 170" className="animate-[fadeIn_0.5s]" />}
                                    {game.errors > 5 && <path d="M160 135 L180 170" className="animate-[fadeIn_0.5s]" />}
                                </g>
                            </svg>
                         </div>
                    </div>

                    {/* Word Display */}
                    <div className="flex justify-center gap-2 mb-8 flex-wrap">
                        {game.word.split('').map((l, i) => (
                            <div key={i} className={`
                                w-10 h-14 flex items-center justify-center text-2xl font-bold rounded-lg border-b-2 transition-all duration-300
                                ${game.guessed.includes(l) 
                                    ? 'text-cyan-50 border-cyan-500 bg-cyan-500/10 shadow-[0_0_15px_rgba(34,211,238,0.2)] opacity-100' 
                                    : 'border-slate-800 bg-white/5 text-transparent'}
                            `}>
                                {game.guessed.includes(l) ? l : ''}
                            </div>
                        ))}
                    </div>

                    {/* Hint */}
                    <div className="flex justify-center mb-6">
                        <div className="px-4 py-1.5 bg-[#0f172a] rounded-full border border-cyan-900 flex items-center gap-2 shadow-lg">
                            <Lightbulb size={12} className="text-cyan-400" />
                            <span className="text-cyan-400/80 font-mono text-[10px] uppercase tracking-widest">DICA: <span className="text-white font-bold">{game.hint}</span></span>
                        </div>
                    </div>

                    {/* Keyboard */}
                    <div className="w-full max-w-lg grid grid-cols-7 gap-1.5 sm:gap-2 p-4 bg-black/20 rounded-2xl border border-white/5 backdrop-blur-sm">
                        {"ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('').map(l => {
                            const isGuessed = game.guessed.includes(l);
                            const isCorrect = isGuessed && game.word.includes(l);
                            
                            return (
                                <button 
                                    key={l} 
                                    disabled={game.status !== 'playing' || isGuessed} 
                                    onClick={() => handleGuess(l)} 
                                    className={`
                                        aspect-square rounded-md font-bold text-sm transition-all duration-200
                                        ${!isGuessed 
                                            ? 'bg-[#1e293b] text-slate-400 border border-slate-700 hover:border-cyan-500 hover:text-cyan-300 hover:shadow-[0_0_10px_rgba(34,211,238,0.2)]' 
                                            : isCorrect
                                                ? 'bg-cyan-600 border border-cyan-400 text-white shadow-[0_0_10px_cyan]'
                                                : 'bg-red-900/40 border border-red-900 text-red-500 opacity-50'}
                                    `}
                                >
                                    {l}
                                </button>
                            )
                        })}
                    </div>

                    {/* Footer Controls */}
                    <div className="mt-8 flex gap-4 w-full max-w-sm justify-center">
                        {game.status === 'playing' ? (
                            <button onClick={handleHint} className="flex-1 py-3 bg-yellow-600/10 hover:bg-yellow-600/20 border border-yellow-500/50 text-yellow-400 rounded-lg font-bold flex items-center justify-center gap-2 transition-all hover:scale-[1.02] text-xs tracking-wider uppercase">
                                 <span>Revelar Letra (AD)</span>
                            </button>
                        ) : (
                            <button onClick={handleRestart} className="flex-1 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-bold tracking-widest flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(34,211,238,0.3)] transition-all hover:scale-[1.02] text-xs uppercase">
                                 <RefreshCw size={16} /> Novo Jogo
                            </button>
                        )}
                    </div>

                    {/* Results Modal */}
                     {game.status !== 'playing' && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-black/80 backdrop-blur-sm animate-[fadeIn_0.5s]" onClick={handleRestart}></div>
                            <div className="relative bg-[#0f172a] border border-cyan-500/30 p-8 rounded-2xl flex flex-col items-center gap-3 animate-[zoomIn_0.3s] shadow-[0_0_50px_rgba(6,182,212,0.15)] max-w-xs w-full text-center">
                                {game.status === 'won' ? (
                                    <>
                                        <Trophy size={48} className="text-yellow-400 mb-2 drop-shadow-[0_0_15px_gold] animate-bounce" />
                                        <h2 className="text-2xl font-bold text-white tracking-widest">VITORIA</h2>
                                        <div className="text-cyan-400 text-sm">Palavra: <span className="text-white font-mono font-bold">{game.word}</span></div>
                                        <div className="text-xs text-gray-400">+20 moedas</div>
                                    </>
                                ) : (
                                    <>
                                        <h2 className="text-2xl font-bold text-red-500 tracking-widest">FALHA</h2>
                                        <div className="text-gray-400 text-sm">Palavra: <span className="text-white font-mono font-bold">{game.word}</span></div>
                                    </>
                                )}
                                <button onClick={handleRestart} className="w-full mt-2 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded transition shadow-lg text-xs uppercase tracking-wider">Continuar</button>
                            </div>
                        </div>
                    )}
                 </div>
            </div>
        );
      };

      // --- GAME 4: ROYAL CHECKERS 3D ---
      const CheckersGame = ({ onBack }) => {
        const BOARD_SIZE = 8;
        const [board, setBoard] = useState([]);
        const [turn, setTurn] = useState('player'); // 'player' (Red) or 'ai' (Black)
        const [selectedPiece, setSelectedPiece] = useState(null); // {r, c}
        const [validMoves, setValidMoves] = useState([]); // Array of {r, c, isJump}
        const [difficulty, setDifficulty] = useState('medium'); // easy, medium, hard
        const [gameStatus, setGameStatus] = useState('playing'); // playing, player_won, ai_won
        
        // Initialize Board
        const initBoard = () => {
            const newBoard = Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(null));
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if ((r + c) % 2 === 1) {
                        if (r < 3) newBoard[r][c] = { type: 'ai', isKing: false };
                        else if (r > 4) newBoard[r][c] = { type: 'player', isKing: false };
                    }
                }
            }
            setBoard(newBoard);
            setTurn('player');
            setGameStatus('playing');
            setSelectedPiece(null);
            setValidMoves([]);
        };

        useEffect(() => initBoard(), []);

        // Logic
        const isValidPos = (r, c) => r >= 0 && r < BOARD_SIZE && c >= 0 && c < BOARD_SIZE;

        const getMoves = (b, r, c) => {
            const piece = b[r][c];
            if (!piece) return [];
            
            const moves = [];
            const directions = [];
            
            if (piece.type === 'player' || piece.isKing) directions.push([-1, -1], [-1, 1]); // Up
            if (piece.type === 'ai' || piece.isKing) directions.push([1, -1], [1, 1]); // Down
            
            directions.forEach(([dr, dc]) => {
                // Regular Move
                if (isValidPos(r + dr, c + dc) && b[r + dr][c + dc] === null) {
                    moves.push({ r: r + dr, c: c + dc, isJump: false });
                }
                // Jump Move
                if (isValidPos(r + dr * 2, c + dc * 2) && 
                    b[r + dr * 2][c + dc * 2] === null &&
                    b[r + dr][c + dc] !== null && 
                    b[r + dr][c + dc].type !== piece.type) {
                    moves.push({ r: r + dr * 2, c: c + dc * 2, isJump: true, jumpR: r + dr, jumpC: c + dc });
                }
            });
            return moves;
        };

        const executeMove = (move) => {
            if (!selectedPiece) return;
            
            const newBoard = board.map(row => [...row]);
            const piece = newBoard[selectedPiece.r][selectedPiece.c];
            
            // Move piece
            newBoard[move.r][move.c] = piece;
            newBoard[selectedPiece.r][selectedPiece.c] = null;
            
            // Handle Jump (Capture)
            if (move.isJump) {
                newBoard[move.jumpR][move.jumpC] = null;
                playSound('capture');
            } else {
                playSound('move_piece');
            }
            
            // King Promotion
            if (piece.type === 'player' && move.r === 0) { piece.isKing = true; playSound('powerup'); }
            if (piece.type === 'ai' && move.r === BOARD_SIZE - 1) { piece.isKing = true; playSound('powerup'); }
            
            setBoard(newBoard);
            setSelectedPiece(null);
            setValidMoves([]);
            
            // Check Win Condition
            let playerCount = 0, aiCount = 0;
            newBoard.forEach(row => row.forEach(p => {
                if (p?.type === 'player') playerCount++;
                if (p?.type === 'ai') aiCount++;
            }));
            
            if (aiCount === 0) { setGameStatus('player_won'); playSound('win'); return; }
            if (playerCount === 0) { setGameStatus('ai_won'); playSound('lose'); return; }

            // Switch Turn
            setTurn(prev => prev === 'player' ? 'ai' : 'player');
        };

        const handleTap = (r, c) => {
            if (turn !== 'player' || gameStatus !== 'playing') return;

            // If tapping a valid move
            const move = validMoves.find(m => m.r === r && m.c === c);
            if (move) {
                executeMove(move);
                return;
            }

            // If tapping own piece
            const piece = board[r][c];
            if (piece && piece.type === 'player') {
                setSelectedPiece({ r, c });
                setValidMoves(getMoves(board, r, c));
                playSound('ui_click');
            } else {
                setSelectedPiece(null);
                setValidMoves([]);
            }
        };

        // AI Logic
        useEffect(() => {
            if (turn === 'ai' && gameStatus === 'playing') {
                const timer = setTimeout(() => {
                    // Collect all AI pieces
                    const aiPieces = [];
                    for (let r = 0; r < BOARD_SIZE; r++) {
                        for (let c = 0; c < BOARD_SIZE; c++) {
                            if (board[r][c]?.type === 'ai') aiPieces.push({ r, c });
                        }
                    }

                    // Find all possible moves
                    let allMoves = [];
                    aiPieces.forEach(p => {
                        const moves = getMoves(board, p.r, p.c);
                        moves.forEach(m => allMoves.push({ from: p, to: m }));
                    });

                    if (allMoves.length === 0) {
                        setGameStatus('player_won');
                        playSound('win');
                        return;
                    }

                    // Scoring Strategy
                    // Jump > King > Edge > Random
                    allMoves.sort((a, b) => {
                        const scoreA = (a.to.isJump ? 10 : 0) + (a.to.r === BOARD_SIZE - 1 ? 5 : 0) + (Math.random() * (difficulty === 'hard' ? 2 : 5));
                        const scoreB = (b.to.isJump ? 10 : 0) + (b.to.r === BOARD_SIZE - 1 ? 5 : 0) + (Math.random() * (difficulty === 'hard' ? 2 : 5));
                        return scoreB - scoreA;
                    });

                    const bestMove = allMoves[0];
                    
                    // Execute AI Move
                    const newBoard = board.map(row => [...row]);
                    const piece = newBoard[bestMove.from.r][bestMove.from.c];
                    newBoard[bestMove.to.r][bestMove.to.c] = piece;
                    newBoard[bestMove.from.r][bestMove.from.c] = null;
                    
                    if (bestMove.to.isJump) {
                        newBoard[bestMove.to.jumpR][bestMove.to.jumpC] = null;
                        playSound('capture');
                    } else {
                        playSound('move_piece');
                    }

                    if (piece.type === 'ai' && bestMove.to.r === BOARD_SIZE - 1) { piece.isKing = true; }

                    setBoard(newBoard);
                    
                    // Check Win Condition
                    let playerCount = 0;
                    newBoard.forEach(row => row.forEach(p => { if (p?.type === 'player') playerCount++; }));
                    if (playerCount === 0) { setGameStatus('ai_won'); playSound('lose'); return; }

                    setTurn('player');

                }, 1000); // Thinking delay
                return () => clearTimeout(timer);
            }
        }, [turn, board, difficulty, gameStatus]);

        return (
            <div className="w-full h-full bg-[#1a0505] flex flex-col items-center justify-center relative font-sans safe-area-padding overflow-hidden">
                <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')] opacity-20"></div>
                <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black pointer-events-none"></div>

                {/* Header */}
                <div className="absolute top-0 w-full p-6 flex justify-between items-start z-50">
                     <button onClick={onBack} className="p-3 bg-white/10 rounded-full hover:bg-white/20 backdrop-blur border border-white/10 shadow-lg text-white"><ChevronLeft size={24} /></button>
                     <div className="flex flex-col items-center">
                         <h1 className="text-3xl font-bold text-[#f59e0b] drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] flex items-center gap-2"><Crown fill="#f59e0b" /> DAMAS REAIS</h1>
                         <div className="bg-black/40 px-3 py-1 rounded-full border border-white/10 mt-2 text-xs text-gray-300 font-bold uppercase tracking-widest flex items-center gap-2">
                            <span>Dif:</span>
                            <button onClick={() => setDifficulty('easy')} className={`${difficulty==='easy'?'text-green-400':'text-gray-600'}`}>F√°cil</button>|
                            <button onClick={() => setDifficulty('medium')} className={`${difficulty==='medium'?'text-yellow-400':'text-gray-600'}`}>M√©d</button>|
                            <button onClick={() => setDifficulty('hard')} className={`${difficulty==='hard'?'text-red-400':'text-gray-600'}`}>Dif</button>
                         </div>
                     </div>
                     <div className="w-12"></div>
                </div>

                {/* 3D Scene */}
                <div className="checkers-3d-scene w-full max-w-lg aspect-square p-2 flex items-center justify-center">
                    <div className="checkers-board w-full h-full bg-[#2c1a1a] border-[16px] border-[#422] rounded-lg relative grid grid-cols-8 grid-rows-8 shadow-2xl">
                        {board.map((row, r) => row.map((piece, c) => {
                            const isDark = (r + c) % 2 === 1;
                            const isSelected = selectedPiece?.r === r && selectedPiece?.c === c;
                            const isValidMove = validMoves.some(m => m.r === r && m.c === c);
                            
                            return (
                                <div 
                                    key={`${r}-${c}`} 
                                    onClick={() => handleTap(r, c)}
                                    className={`
                                        relative w-full h-full flex items-center justify-center
                                        ${isDark ? 'bg-[#5c3a2a] shadow-[inset_0_0_10px_rgba(0,0,0,0.5)]' : 'bg-[#eecfa1]'}
                                        ${isValidMove ? 'after:content-[""] after:absolute after:w-4 after:h-4 after:bg-green-500 after:rounded-full after:animate-pulse cursor-pointer shadow-[inset_0_0_20px_rgba(34,197,94,0.5)]' : ''}
                                    `}
                                >
                                    {piece && (
                                        <div className={`
                                            checker-piece w-[80%] h-[80%] rounded-full shadow-[0_5px_10px_rgba(0,0,0,0.7),inset_0_-5px_5px_rgba(0,0,0,0.5),inset_0_2px_5px_rgba(255,255,255,0.4)]
                                            flex items-center justify-center transform transition-transform
                                            ${piece.type === 'player' 
                                                ? 'bg-gradient-to-br from-red-600 to-red-900 ring-2 ring-red-900' 
                                                : 'bg-gradient-to-br from-gray-800 to-black ring-2 ring-black'}
                                            ${isSelected ? 'scale-110 ring-4 ring-yellow-400 shadow-[0_0_20px_gold]' : ''}
                                            ${piece.isKing ? 'border-2 border-yellow-400' : ''}
                                        `}>
                                            {piece.isKing && <Crown size={20} className="text-yellow-400 king-crown" />}
                                            {/* Inner detail */}
                                            <div className="absolute inset-2 rounded-full border border-white/20"></div>
                                        </div>
                                    )}
                                </div>
                            );
                        }))}
                    </div>
                </div>

                {/* Status Bar */}
                <div className="absolute bottom-10 w-full px-6 flex justify-center">
                    <div className="bg-black/60 backdrop-blur px-8 py-3 rounded-xl border border-white/10 flex items-center gap-4 shadow-xl">
                        <div className={`flex items-center gap-2 ${turn === 'player' ? 'text-red-400 font-bold scale-110' : 'text-gray-500'}`}>
                             <div className="w-3 h-3 rounded-full bg-red-600"></div> VOC√ä
                        </div>
                        <div className="h-6 w-px bg-white/20"></div>
                        <div className={`flex items-center gap-2 ${turn === 'ai' ? 'text-gray-200 font-bold scale-110' : 'text-gray-500'}`}>
                             CPU <div className="w-3 h-3 rounded-full bg-black border border-gray-600"></div>
                        </div>
                    </div>
                </div>

                {/* Game Over Modal */}
                {gameStatus !== 'playing' && (
                    <div className="absolute inset-0 bg-black/80 z-[60] flex items-center justify-center animate-fade-in p-4">
                        <div className="bg-[#1a0505] p-8 rounded-2xl border-2 border-yellow-600 text-center shadow-[0_0_50px_rgba(234,197,8,0.2)] max-w-sm w-full">
                            {gameStatus === 'player_won' ? (
                                <>
                                    <Crown size={64} className="text-yellow-400 mx-auto mb-4 animate-bounce" />
                                    <h2 className="text-3xl font-bold text-white mb-2 hero-title">VIT√ìRIA REAL!</h2>
                                    <p className="text-gray-300 mb-6">Voc√™ dominou o tabuleiro.</p>
                                </>
                            ) : (
                                <>
                                    <Skull size={64} className="text-red-500 mx-auto mb-4" />
                                    <h2 className="text-3xl font-bold text-red-500 mb-2 hero-title">DERROTA</h2>
                                    <p className="text-gray-400 mb-6">A IA foi superior desta vez.</p>
                                </>
                            )}
                            <button onClick={() => initBoard()} className="w-full py-3 bg-yellow-600 hover:bg-yellow-500 text-black font-bold rounded-lg uppercase tracking-wider mb-3">JOGAR NOVAMENTE</button>
                            <button onClick={onBack} className="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white font-bold rounded-lg uppercase tracking-wider">VOLTAR AO MENU</button>
                        </div>
                    </div>
                )}
            </div>
        );
      };

      // --- GAME 5: CRYPTO MEMORY ---
      const MemoryGame = ({ onBack, addCoins }) => {
          // Luxury/Crypto items
          const ITEMS = useMemo(() => [
            { id: 'btc', content: '‚Çø', color: 'text-yellow-500' },
            { id: 'eth', content: 'Œû', color: 'text-blue-400' },
            { id: 'bull', content: <TrendingUp size={32} />, color: 'text-green-500' },
            { id: 'bear', content: <TrendingDown size={32} />, color: 'text-red-500' },
            { id: 'gold', content: <Crown size={32} />, color: 'text-yellow-300' },
            { id: 'gem', content: 'üíé', color: 'text-cyan-300' },
            { id: 'bank', content: 'üè¶', color: 'text-gray-200' },
            { id: 'money', content: 'üí∞', color: 'text-green-400' },
            { id: 'lock', content: <Lock size={32} />, color: 'text-gray-400' },
            { id: 'chart', content: <Activity size={32} />, color: 'text-purple-400' }
          ], []);

          const [cards, setCards] = useState([]);
          const [flipped, setFlipped] = useState([]);
          const [matched, setMatched] = useState([]);
          const [moves, setMoves] = useState(0);
          const [gameStatus, setGameStatus] = useState('playing'); // playing, won

          // Initialize Game
          useEffect(() => {
              const gameItems = [...ITEMS]; // Use all items for 20 cards (5x4 grid)
              const deck = [...gameItems, ...gameItems]
                  .sort(() => Math.random() - 0.5)
                  .map((item, index) => ({ ...item, uniqueId: index }));
              setCards(deck);
          }, [ITEMS]);

          const handleCardClick = (index) => {
              if (gameStatus !== 'playing') return;
              if (flipped.length === 2) return;
              if (matched.includes(cards[index].uniqueId)) return;
              if (flipped.includes(index)) return;

              playSound('ui_click');
              const newFlipped = [...flipped, index];
              setFlipped(newFlipped);

              if (newFlipped.length === 2) {
                  setMoves(m => m + 1);
                  const first = cards[newFlipped[0]];
                  const second = cards[newFlipped[1]];

                  if (first.id === second.id) {
                      playSound('win');
                      setMatched(prev => [...prev, first.uniqueId, second.uniqueId]);
                      setFlipped([]);
                      
                      // Check Win
                      if (matched.length + 2 === cards.length) {
                          setTimeout(() => {
                              playSound('levelup');
                              setGameStatus('won');
                              addCoins(30);
                          }, 500);
                      }
                  } else {
                      setTimeout(() => {
                          setFlipped([]);
                      }, 1000);
                  }
              } else {
                  playSound('move_piece');
              }
          };

          const restartGame = () => {
              const deck = [...ITEMS, ...ITEMS]
                  .sort(() => Math.random() - 0.5)
                  .map((item, index) => ({ ...item, uniqueId: index }));
              setCards(deck);
              setFlipped([]);
              setMatched([]);
              setMoves(0);
              setGameStatus('playing');
              playSound('ui_click');
          };

          return (
              <div className="w-full h-full bg-[#050505] flex flex-col items-center relative overflow-hidden safe-area-padding">
                  {/* Background Luxury */}
                  <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-gray-900 via-black to-black"></div>
                  <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'linear-gradient(45deg, #FFD700 1px, transparent 1px)', backgroundSize: '30px 30px' }}></div>

                  {/* Header */}
                  <div className="w-full p-4 flex justify-between items-center z-20 border-b border-white/10 bg-black/40 backdrop-blur">
                      <button onClick={onBack} className="p-2 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 text-gray-300">
                          <ChevronLeft />
                      </button>
                      <div className="flex flex-col items-center">
                          <h1 className="text-xl font-bold text-gold-gradient tracking-widest uppercase">MEM√ìRIA CRIPTO</h1>
                          <div className="flex gap-4 text-xs font-mono text-gray-400">
                              <span>JOGADAS: <span className="text-white">{moves}</span></span>
                              <span>PARES: <span className="text-white">{matched.length / 2}/{ITEMS.length}</span></span>
                          </div>
                      </div>
                      <button onClick={restartGame} className="p-2 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 text-yellow-500">
                          <RefreshCw size={20} />
                      </button>
                  </div>

                  {/* Grid */}
                  <div className="flex-1 flex items-center justify-center p-4 w-full max-w-lg z-10">
                      <div className="grid grid-cols-4 gap-3 w-full aspect-[4/5]">
                          {cards.map((card, index) => {
                              const isFlipped = flipped.includes(index) || matched.includes(card.uniqueId);
                              const isMatched = matched.includes(card.uniqueId);
                              
                              return (
                                  <div 
                                      key={card.uniqueId}
                                      onClick={() => handleCardClick(index)}
                                      className="relative w-full h-full perspective-1000 cursor-pointer group"
                                  >
                                      <div className={`w-full h-full relative transition-all duration-500 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                                          {/* Front (Hidden) */}
                                          <div className="absolute inset-0 w-full h-full backface-hidden rounded-xl bg-gradient-to-br from-gray-800 to-black border border-yellow-900/30 flex items-center justify-center shadow-lg group-hover:border-yellow-500/50 transition-colors">
                                              <div className="text-2xl opacity-20">üíé</div>
                                              <div className="absolute inset-0 border-2 border-dashed border-white/5 rounded-xl m-1"></div>
                                          </div>
                                          
                                          {/* Back (Revealed) */}
                                          <div className={`absolute inset-0 w-full h-full backface-hidden rotate-y-180 rounded-xl flex items-center justify-center shadow-[0_0_15px_rgba(255,215,0,0.15)] border-2 ${isMatched ? 'bg-green-900/20 border-green-500' : 'bg-gradient-to-br from-gray-900 to-black border-yellow-500'}`}>
                                              <div className={`text-4xl ${card.color} drop-shadow-md transform transition-transform ${isMatched ? 'scale-110' : ''}`}>
                                                  {card.content}
                                              </div>
                                          </div>
                                      </div>
                                  </div>
                              );
                          })}
                      </div>
                  </div>

                  {/* Win Modal */}
                  {gameStatus === 'won' && (
                      <div className="absolute inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
                           <div className="bg-gradient-to-br from-gray-900 to-black p-8 rounded-2xl border border-yellow-500/30 text-center max-w-xs w-full shadow-[0_0_50px_rgba(255,215,0,0.2)]">
                               <div className="w-20 h-20 bg-yellow-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-yellow-500/50 animate-bounce">
                                   <Crown size={40} className="text-yellow-400" />
                               </div>
                               <h2 className="text-2xl font-bold text-white mb-2 hero-title">EXCELENTE!</h2>
                               <p className="text-gray-400 text-sm mb-6">Voc√™ completou o mercado em <span className="text-white font-bold">{moves}</span> movimentos.</p>
                               <div className="flex flex-col gap-2">
                                   <button onClick={restartGame} className="w-full py-3 bg-yellow-600 hover:bg-yellow-500 text-black font-bold rounded uppercase tracking-wider">Jogar Novamente</button>
                                   <button onClick={onBack} className="w-full py-3 bg-white/5 hover:bg-white/10 text-white font-bold rounded uppercase tracking-wider border border-white/10">Menu Principal</button>
                               </div>
                           </div>
                      </div>
                  )}
              </div>
          );
      };

      const HistoryModal = ({ onClose, user }) => {
          const [items, setItems] = useState([]);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
              const fetchHistory = async () => {
                  if (!user || !supabase) {
                      setLoading(false);
                      return;
                  }
                  const { data, error } = await supabase
                      .from('withdrawals')
                      .select('*')
                      .eq('email', user.email)
                      .order('created_at', { ascending: false });
                  
                  if (data) setItems(data);
                  setLoading(false);
              };
              fetchHistory();
          }, [user]);

          return (
              <Modal title="HIST√ìRICO DE SAQUES" onClose={onClose}>
                  {loading ? (
                      <div className="flex justify-center p-8"><Loader2 className="animate-spin text-white" /></div>
                  ) : items.length === 0 ? (
                      <div className="text-center text-gray-500 p-8">
                          <History size={48} className="mx-auto mb-2 opacity-50" />
                          <p>Nenhum registro encontrado.</p>
                          <p className="text-xs mt-2 text-gray-600">Jogue e solicite seu primeiro saque!</p>
                      </div>
                  ) : (
                      <div className="flex flex-col gap-3">
                          {items.map(item => (
                              <div key={item.id} className="bg-[#1a1a1a] p-3 rounded-lg border border-white/5 flex flex-col gap-2 relative overflow-hidden group">
                                  {/* Decoration */}
                                  <div className={`absolute top-0 left-0 w-1 h-full ${item.status === 'paid' ? 'bg-green-500' : 'bg-yellow-500'}`}></div>
                                  
                                  {/* Header: Date and Status */}
                                  <div className="flex justify-between items-center border-b border-white/5 pb-2 pl-2">
                                      <div className="flex flex-col">
                                          <span className="text-[10px] text-gray-400 font-mono">DATA DA SOLICITA√á√ÉO</span>
                                          <span className="text-xs text-white font-bold">
                                              {new Date(item.created_at).toLocaleDateString('pt-BR')} <span className="text-gray-500">|</span> {new Date(item.created_at).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'})}
                                          </span>
                                      </div>
                                      <div className={`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider border ${
                                          item.status === 'paid' ? 'bg-green-900/30 text-green-400 border-green-500/30' : 'bg-yellow-900/30 text-yellow-400 border-yellow-500/30'
                                      }`}>
                                          {item.status === 'paid' ? 'PAGO' : 'EM AN√ÅLISE'}
                                      </div>
                                  </div>

                                  {/* Details Grid */}
                                  <div className="grid grid-cols-2 gap-2 pl-2">
                                      <div>
                                          <div className="text-[9px] text-gray-500 uppercase font-bold">Valor do Saque</div>
                                          <div className="text-green-400 font-bold font-mono text-lg">R$ {item.amount.toFixed(2)}</div>
                                      </div>
                                      <div>
                                          <div className="text-[9px] text-gray-500 uppercase font-bold">M√©todo</div>
                                          <div className="text-white text-xs font-mono break-all">
                                              <span className="text-gray-400">{item.pix_type.toUpperCase()}:</span><br/>
                                              {item.pix_key}
                                          </div>
                                      </div>
                                  </div>

                                  {/* Message Box */}
                                  <div className="bg-black/40 p-2 rounded border border-white/5 mt-1 ml-2">
                                      <div className="text-[9px] text-gray-400 uppercase mb-1 flex items-center gap-1 font-bold">
                                          <ShieldAlert size={10} /> Status da Opera√ß√£o
                                      </div>
                                      <p className="text-[10px] text-gray-300 leading-relaxed font-mono">
                                          {item.message || (item.status === 'paid' 
                                              ? "Pagamento enviado com sucesso." 
                                              : "Aguardando an√°lise de seguran√ßa e processamento banc√°rio.")}
                                      </p>
                                  </div>
                              </div>
                          ))}
                      </div>
                  )}
              </Modal>
          );
      };

      // --- GAME 7: ROCK PAPER SCISSORS (NEON) ---
      const RockPaperScissorsGame = ({ onBack, addCoins }) => {
          const [playerChoice, setPlayerChoice] = useState(null); // 'rock', 'paper', 'scissors'
          const [cpuChoice, setCpuChoice] = useState(null);
          const [result, setResult] = useState(null); // 'win', 'lose', 'draw'
          const [score, setScore] = useState(0);
          const [streak, setStreak] = useState(0);
          const [isAnimating, setIsAnimating] = useState(false);

          const CHOICES = [
              { id: 'rock', icon: <Grab size={48} />, name: 'PEDRA', color: 'from-red-500 to-orange-500', beat: 'scissors' },
              { id: 'paper', icon: <Hand size={48} />, name: 'PAPEL', color: 'from-blue-500 to-cyan-500', beat: 'rock' },
              { id: 'scissors', icon: <Scissors size={48} />, name: 'TESOURA', color: 'from-purple-500 to-pink-500', beat: 'paper' }
          ];

          const playTurn = (choiceId) => {
              if (isAnimating) return;
              setIsAnimating(true);
              setPlayerChoice(choiceId);
              setCpuChoice(null);
              setResult(null);
              playSound('ui_click');

              // Animation delay simulation
              setTimeout(() => {
                  const cpu = CHOICES[Math.floor(Math.random() * CHOICES.length)].id;
                  setCpuChoice(cpu);

                  if (choiceId === cpu) {
                      setResult('draw');
                      playSound('scan');
                  } else if (CHOICES.find(c => c.id === choiceId).beat === cpu) {
                      setResult('win');
                      setScore(s => s + 1);
                      setStreak(s => s + 1);
                      addCoins(5 + streak); // Bonus coins for streak
                      playSound('win');
                  } else {
                      setResult('lose');
                      setStreak(0);
                      playSound('lose');
                  }
                  setIsAnimating(false);
              }, 1000);
          };

          const renderChoiceIcon = (id) => {
              if (!id) return <HelpCircle size={48} className="text-gray-700 animate-pulse" />;
              const choice = CHOICES.find(c => c.id === id);
              return (
                  <div className={`w-24 h-24 rounded-full bg-gradient-to-br ${choice.color} flex items-center justify-center shadow-[0_0_30px_currentColor] text-white animate-[zoomIn_0.3s]`}>
                      {choice.icon}
                  </div>
              );
          };

          return (
              <div className="w-full h-full bg-[#0a0a0a] flex flex-col items-center justify-center relative safe-area-padding overflow-hidden">
                  {/* Neon Background */}
                  <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-gray-900 via-black to-black"></div>
                  <div className="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/hexellence.png')]"></div>
                  
                  {/* Header */}
                  <div className="absolute top-0 w-full p-6 flex justify-between items-start z-50">
                      <button onClick={onBack} className="p-3 bg-white/5 hover:bg-white/10 rounded-full border border-white/10 text-white backdrop-blur transition"><ChevronLeft /></button>
                      <div className="flex flex-col items-center">
                          <h1 className="text-3xl font-bold font-['Rajdhani'] text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 tracking-widest drop-shadow-[0_0_10px_rgba(236,72,153,0.5)]">JO-KEN-PO</h1>
                          <div className="flex gap-4 mt-2">
                              <div className="bg-black/50 px-3 py-1 rounded border border-white/10 text-xs font-mono text-gray-300">SCORE: <span className="text-white font-bold">{score}</span></div>
                              <div className="bg-black/50 px-3 py-1 rounded border border-orange-500/30 text-xs font-mono text-orange-400">STREAK: <span className="text-white font-bold">x{streak}</span></div>
                          </div>
                      </div>
                      <div className="w-12"></div>
                  </div>

                  {/* Battle Arena */}
                  <div className="flex-1 w-full flex flex-col items-center justify-center gap-8 relative z-10">
                      
                      <div className="flex items-center justify-center gap-8 md:gap-20">
                          {/* Player */}
                          <div className="flex flex-col items-center gap-4">
                              <div className={`w-32 h-32 rounded-full border-4 border-white/10 bg-black/40 flex items-center justify-center relative ${isAnimating ? 'animate-bounce' : ''}`}>
                                  {renderChoiceIcon(playerChoice)}
                                  <div className="absolute -bottom-3 bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider shadow-lg">Voc√™</div>
                              </div>
                          </div>

                          {/* VS */}
                          <div className="text-4xl font-black italic text-white/20">VS</div>

                          {/* CPU */}
                          <div className="flex flex-col items-center gap-4">
                              <div className={`w-32 h-32 rounded-full border-4 border-white/10 bg-black/40 flex items-center justify-center relative ${isAnimating ? 'animate-bounce' : ''}`}>
                                  {renderChoiceIcon(cpuChoice)}
                                  <div className="absolute -bottom-3 bg-red-600 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider shadow-lg">CPU</div>
                              </div>
                          </div>
                      </div>

                      {/* Result Text */}
                      <div className="h-12 flex items-center justify-center">
                          {result && (
                              <div className={`text-4xl font-black uppercase tracking-widest animate-[zoomIn_0.2s] drop-shadow-[0_0_15px_rgba(0,0,0,0.8)]
                                  ${result === 'win' ? 'text-green-400' : result === 'lose' ? 'text-red-500' : 'text-yellow-400'}
                              `}>
                                  {result === 'win' ? 'VIT√ìRIA!' : result === 'lose' ? 'DERROTA!' : 'EMPATE!'}
                              </div>
                          )}
                          {isAnimating && <div className="text-gray-500 font-mono animate-pulse">PROCESSANDO...</div>}
                      </div>

                  </div>

                  {/* Controls */}
                  <div className="w-full p-8 pb-12 z-20">
                      <div className="grid grid-cols-3 gap-4 max-w-md mx-auto">
                          {CHOICES.map((choice) => (
                              <button
                                  key={choice.id}
                                  onClick={() => playTurn(choice.id)}
                                  disabled={isAnimating}
                                  className={`
                                      group relative h-24 rounded-2xl bg-black/40 border border-white/10 flex flex-col items-center justify-center gap-2 overflow-hidden transition-all duration-200 active:scale-95 hover:border-white/30
                                      ${playerChoice === choice.id ? 'border-white ring-2 ring-white/50' : ''}
                                  `}
                              >
                                  <div className={`absolute inset-0 bg-gradient-to-br ${choice.color} opacity-10 group-hover:opacity-20 transition-opacity`}></div>
                                  <div className={`text-white transition-transform group-hover:scale-110 drop-shadow-md`}>
                                      {React.cloneElement(choice.icon, { size: 32 })}
                                  </div>
                                  <span className="text-[10px] font-bold text-gray-300 uppercase tracking-widest z-10">{choice.name}</span>
                              </button>
                          ))}
                      </div>
                  </div>
              </div>
          );
      };

      const MainHub = ({ onSelect, coins, onOpenMissions, cashBalance, user, onLoginClick, onLogoutClick, onWithdraw, onAdminAccess }) => {
          const [showHistory, setShowHistory] = useState(false);
          const GAMES = [
              { id: 'galaxy', name: 'Invasor Gal√°ctico', icon: <Rocket size={32} />, color: 'from-blue-600 to-indigo-600', desc: 'Arcade Espacial' },
              { id: 'crypto', name: 'Fazenda Cripto', icon: <Cpu size={32} />, color: 'from-green-600 to-emerald-600', desc: 'Simulador Mining' },
              { id: 'flappy', name: 'Flappy Coin', icon: <ArrowUp size={32} />, color: 'from-yellow-500 to-amber-600', desc: 'Aventura Financeira' },
              { id: 'hangman', name: 'Forca Neon', icon: <Brain size={32} />, color: 'from-purple-600 to-fuchsia-600', desc: 'Puzzle Cyberpunk' },
              { id: 'checkers', name: 'Damas Reais', icon: <Grid size={32} />, color: 'from-amber-600 to-red-700', desc: 'Estrat√©gia 3D' },
              { id: 'memory', name: 'Mem√≥ria Cripto', icon: <Gem size={32} />, color: 'from-yellow-600 to-yellow-800', desc: 'Treino Cerebral' },
              { id: 'rps', name: 'Jo-Ken-Po Neon', icon: <Grab size={32} />, color: 'from-pink-600 to-rose-600', desc: 'Batalha Cl√°ssica' },
              { id: 'uno', name: 'Neon Cards', icon: <Layers size={32} />, color: 'from-fuchsia-600 to-purple-600', desc: 'Cartas Deluxe' }
          ];

          const [secretCount, setSecretCount] = useState(0);
          const secretTimerRef = useRef(null);

          const handleSecretClick = () => {
              if (secretTimerRef.current) clearTimeout(secretTimerRef.current);
              
              const newCount = secretCount + 1;
              setSecretCount(newCount);
              
              if (newCount >= 5) {
                  playSound('powerup');
                  onAdminAccess();
                  setSecretCount(0);
              } else {
                  // Reset count if not reached 5 clicks quickly enough
                  secretTimerRef.current = setTimeout(() => {
                      setSecretCount(0);
                  }, 1000);
              }
          };
          
          const gamesSectionRef = useRef(null);
          const scrollToGames = () => {
              playSound('ui_click');
              gamesSectionRef.current?.scrollIntoView({ behavior: 'smooth' });
          };

          return (
              <div className="w-full h-full premium-bg flex flex-col overflow-hidden safe-area-padding">
                   {/* Stock Ticker */}
                   <div className="ticker-wrap shrink-0 border-b border-yellow-500/20 bg-black/90 z-50">
                       <div className="ticker-move flex items-center gap-12 py-2 px-4 text-xs font-mono font-bold tracking-widest">
                            <span className="text-neon-money flex items-center gap-1 drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]"><TrendingUp size={12}/> BTC +4.5%</span>
                            <span className="text-yellow-400 flex items-center gap-1 drop-shadow-[0_0_5px_gold]"><DollarSign size={12}/> GANHE AT√â R$ 0,45 DI√ÅRIOS</span>
                            <span className="text-blue-400 flex items-center gap-1"><ShieldCheck size={12}/> PAGAMENTOS VIA PIX</span>
                            <span className="text-purple-400 flex items-center gap-1"><Gem size={12}/> ETH +2.1%</span>
                            <span className="text-white flex items-center gap-1">JOGUE AGORA</span>
                       </div>
                   </div>

                   {/* Main Content Area */}
                   <div className="flex-1 overflow-y-auto scrollbar-hide pb-20">
                       
                       {/* Top Nav / User Stats */}
                       <div className="sticky top-0 z-40 bg-black/80 backdrop-blur-lg border-b border-white/10 px-6 py-4 flex justify-between items-center shadow-2xl">
                           <div className="flex items-center gap-3 bg-gradient-to-r from-gray-900 to-black px-4 py-2 rounded-full border border-yellow-500/30 shadow-[0_0_20px_rgba(255,215,0,0.15)] group hover:border-yellow-500/60 transition-colors">
                               <div className="w-8 h-8 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center shadow-inner animate-pulse">
                                   <DollarSign size={16} className="text-black font-black" />
                               </div>
                               <div className="flex flex-col">
                                   <span className="text-[9px] text-gray-400 uppercase tracking-widest font-bold">Saldo Atual</span>
                                   <span className="font-mono font-bold text-white text-base text-gold-gradient">R$ {cashBalance.toFixed(2).replace('.', ',')}</span>
                               </div>
                           </div>

                           <div className="flex items-center gap-3">
                               {user ? (
                                   <div className="flex items-center gap-2">
                                       <span className="text-xs text-gray-400 hidden md:block">{user.email.split('@')[0]}</span>
                                       <button onClick={onLogoutClick} className="p-2 rounded-full bg-red-900/20 text-red-400 border border-red-500/30 hover:bg-red-900/40 hover:shadow-[0_0_15px_red] transition-all">
                                           <LogOut size={18} />
                                       </button>
                                   </div>
                               ) : (
                                   <button onClick={onLoginClick} className="px-6 py-2 rounded-full bg-gradient-to-r from-blue-600 to-blue-800 text-white text-xs font-bold uppercase tracking-wider hover:from-blue-500 hover:to-blue-700 shadow-[0_0_15px_rgba(37,99,235,0.4)] transition-all">
                                       Login
                                   </button>
                               )}
                           </div>
                       </div>

                       {/* NEW: PREMIUM HERO SECTION */}
                       <div className="relative w-full px-4 py-16 md:py-24 flex flex-col items-center justify-center text-center overflow-hidden">
                           
                           {/* Wealth Particles */}
                           <div className="absolute inset-0 z-0 opacity-30">
                               <div className="wealth-particle text-yellow-500 left-[10%]" style={{animationDelay: '0s'}}><BitcoinLogo size={24} /></div>
                               <div className="wealth-particle text-green-500 left-[30%]" style={{animationDelay: '1s'}}>$</div>
                               <div className="wealth-particle text-purple-500 left-[70%]" style={{animationDelay: '2s'}}><Gem size={20} /></div>
                               <div className="wealth-particle text-yellow-500 left-[90%]" style={{animationDelay: '3s'}}><Coins size={24} /></div>
                           </div>

                           <div className="z-10 flex flex-col items-center animate-fade-in relative">
                               <div className="absolute -top-20 -left-20 w-64 h-64 bg-yellow-500/10 rounded-full blur-[80px]"></div>
                               <div className="absolute -bottom-20 -right-20 w-64 h-64 bg-green-500/10 rounded-full blur-[80px]"></div>

                               <div className="flex gap-2 mb-4 animate-float-fast">
                                   <span className="px-3 py-1 rounded-full bg-yellow-500/10 border border-yellow-500/30 text-yellow-400 text-[10px] font-bold uppercase tracking-[0.2em] shadow-[0_0_15px_rgba(255,215,0,0.2)]">Premium Gaming</span>
                                   <span className="px-3 py-1 rounded-full bg-green-500/10 border border-green-500/30 text-green-400 text-[10px] font-bold uppercase tracking-[0.2em] shadow-[0_0_15px_rgba(0,255,65,0.2)]">GANHE $ JOGANDO</span>
                               </div>

                               <h1 className="text-5xl md:text-7xl font-black text-white leading-none tracking-tighter drop-shadow-2xl mb-4" onClick={handleSecretClick}>
                                   JOGUE & <br/>
                                   <span className="text-gold-gradient text-6xl md:text-8xl">CONQUISTE</span>
                               </h1>
                               
                               <p className="text-sm md:text-lg text-gray-400 max-w-lg mx-auto font-medium tracking-wide mb-8 leading-relaxed">
                                   Transforme sua habilidade em <span className="text-white font-bold">dinheiro real</span>. A plataforma de jogos mais luxuosa e rent√°vel do mercado.
                               </p>

                               <button onClick={scrollToGames} className="btn-gold px-12 py-5 rounded-lg text-sm md:text-lg z-20 hover:scale-105 transform transition shadow-[0_0_40px_rgba(255,215,0,0.4)] flex items-center gap-3">
                                   <PlayCircle size={24} fill="black" /> COME√áAR AGORA
                               </button>
                           </div>
                       </div>
                       
                       {/* Benefits Section */}
                       <div className="px-6 grid grid-cols-3 gap-2 md:gap-4 mb-12">
                           {[
                               { icon: <DollarSign size={20} />, title: "Dinheiro Real", color: "text-green-400" },
                               { icon: <Zap size={20} />, title: "Saque R√°pido", color: "text-yellow-400" },
                               { icon: <ShieldCheck size={20} />, title: "Seguro & Vip", color: "text-blue-400" }
                           ].map((item, idx) => (
                               <div key={idx} className="bg-black/40 border border-white/5 p-4 rounded-xl flex flex-col items-center justify-center gap-2 backdrop-blur-sm hover:bg-white/5 transition-colors group">
                                   <div className={`p-3 rounded-full bg-white/5 group-hover:scale-110 transition-transform ${item.color} shadow-[0_0_15px_rgba(0,0,0,0.5)]`}>
                                       {item.icon}
                                   </div>
                                   <span className="text-[10px] md:text-xs font-bold uppercase tracking-wider text-gray-300 text-center">{item.title}</span>
                               </div>
                           ))}
                       </div>

                       {/* Mission & Withdraw Quick Actions */}
                       <div className="px-6 mb-12 grid grid-cols-2 gap-4">
                            <button onClick={onOpenMissions} className="glass-card p-6 rounded-2xl flex flex-col items-center justify-center gap-3 relative overflow-hidden group h-32">
                                <div className="absolute inset-0 bg-gradient-to-br from-purple-900/20 to-black opacity-50"></div>
                                <div className="absolute top-0 right-0 p-2 opacity-50"><Clock className="text-purple-500" size={48} /></div>
                                <div className="relative z-10 p-3 bg-black/40 rounded-full border border-purple-500/50 shadow-[0_0_15px_rgba(168,85,247,0.3)]">
                                    <Target className="text-purple-400" size={24} />
                                </div>
                                <div className="flex flex-col items-center z-10">
                                    <span className="text-sm font-black uppercase tracking-widest text-white">Miss√µes</span>
                                    <span className="text-[10px] text-purple-300">Ganhe Diariamente</span>
                                </div>
                            </button>
                            
                            <button onClick={onWithdraw} className="glass-card-gold p-6 rounded-2xl flex flex-col items-center justify-center gap-3 relative overflow-hidden group h-32 border border-yellow-500/40">
                                <div className="absolute inset-0 bg-gradient-to-br from-yellow-900/20 to-black opacity-50"></div>
                                <div className="absolute top-0 right-0 p-2 opacity-50"><Wallet className="text-yellow-500" size={48} /></div>
                                <div className="relative z-10 p-3 bg-black/40 rounded-full border border-yellow-500/80 shadow-[0_0_20px_rgba(234,179,8,0.5)] animate-pulse">
                                    <DollarSign className="text-yellow-400" size={24} />
                                </div>
                                <div className="flex flex-col items-center z-10">
                                    <span className="text-sm font-black uppercase tracking-widest text-white">Sacar PIX</span>
                                    <span className="text-[10px] text-yellow-200">Retirada Imediata</span>
                                </div>
                            </button>
                       </div>
                       
                       {/* "How It Works" Redesigned */}
                       <div className="px-6 py-10 bg-gradient-to-b from-gray-900/50 to-black border-y border-white/5 mb-12 relative overflow-hidden">
                           <div className="absolute top-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-yellow-500/50 to-transparent"></div>
                           <div className="absolute bottom-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-yellow-500/50 to-transparent"></div>
                           
                           <h3 className="text-center text-lg font-black text-white uppercase tracking-[0.3em] mb-10 drop-shadow-md">Rota da Riqueza</h3>
                           
                           <div className="flex justify-between items-start text-center relative max-w-md mx-auto">
                               {/* Connecting Line */}
                               <div className="absolute top-5 left-8 right-8 h-0.5 bg-gray-800 -z-0"></div>
                               
                               <div className="flex flex-col items-center gap-3 z-10 group">
                                   <div className="w-10 h-10 rounded-full bg-black border-2 border-gray-700 group-hover:border-white transition-colors flex items-center justify-center text-sm font-bold shadow-lg">1</div>
                                   <div className="flex flex-col">
                                       <span className="text-xs font-bold text-white uppercase">Jogue</span>
                                       <span className="text-[9px] text-gray-500">Divirta-se</span>
                                   </div>
                               </div>
                               
                               <div className="flex flex-col items-center gap-3 z-10 group">
                                   <div className="w-10 h-10 rounded-full bg-black border-2 border-gray-700 group-hover:border-yellow-500 transition-colors flex items-center justify-center text-sm font-bold shadow-lg text-yellow-500">2</div>
                                   <div className="flex flex-col">
                                       <span className="text-xs font-bold text-white uppercase">Acumule</span>
                                       <span className="text-[9px] text-gray-500">Ganhos Reais</span>
                                   </div>
                               </div>
                               
                               <div className="flex flex-col items-center gap-3 z-10 group">
                                   <div className="w-10 h-10 rounded-full bg-black border-2 border-green-700 group-hover:border-green-400 transition-colors flex items-center justify-center text-sm font-bold shadow-[0_0_15px_rgba(0,255,65,0.3)] text-green-400">3</div>
                                   <div className="flex flex-col">
                                       <span className="text-xs font-bold text-white uppercase">Receba</span>
                                       <span className="text-[9px] text-gray-500">Via PIX</span>
                                   </div>
                               </div>
                           </div>
                       </div>

                       {/* Games Grid */}
                       <div ref={gamesSectionRef} className="px-4 pb-16 max-w-4xl mx-auto">
                           <h2 className="text-xl font-black text-white mb-6 flex items-center gap-3 px-2">
                               <div className="p-2 bg-yellow-500 rounded text-black"><Gamepad2 size={20} /></div>
                               <span className="uppercase tracking-widest text-gold-gradient">Jogos Premium</span>
                           </h2>
                           
                           <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                               {GAMES.map(game => (
                                   <button 
                                      key={game.id}
                                      onClick={() => { playSound('ui_click'); onSelect(game.id); }}
                                      className="group relative aspect-[4/5] rounded-2xl overflow-hidden border-2 border-transparent transition-all duration-300 ease-in-out transform hover:-translate-y-2 focus:outline-none focus:ring-4 focus:ring-opacity-50"
                                   >
                                       {/* Base Gradient Background */}
                                       <div className={`absolute inset-0 bg-gradient-to-br ${game.color} opacity-80 group-hover:opacity-100 transition-opacity`}></div>
                                       
                                       {/* Inner Shadow & Texture */}
                                       <div className="absolute inset-0 bg-black/30 shadow-[inset_0_5px_15px_rgba(0,0,0,0.4)]"></div>
                                       <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre-v2.png')] opacity-5"></div>
                                       
                                       {/* Content Container */}
                                       <div className="relative w-full h-full flex flex-col items-center justify-center p-4 text-white text-center">
                                           
                                           {/* Icon Container */}
                                           <div className="mb-4 p-4 rounded-full bg-black/40 border-2 border-white/20 shadow-lg backdrop-blur-sm group-hover:scale-110 transition-transform">
                                               {React.cloneElement(game.icon, { size: 32, className: 'text-white drop-shadow-lg' })}
                                           </div>

                                           {/* Text */}
                                           <h3 className="text-sm font-black text-white uppercase tracking-wider leading-tight mb-1 group-hover:text-yellow-300 transition-colors font-['Rajdhani'] drop-shadow-md">{game.name}</h3>
                                           <p className="text-[10px] text-gray-300 opacity-80 font-mono">{game.desc}</p>
                                       </div>
                                       
                                       {/* Hover Glow Effect */}
                                       <div className={`absolute -inset-1 rounded-2xl bg-gradient-to-br ${game.color} opacity-0 group-hover:opacity-50 blur-lg transition-opacity duration-300 -z-10`}></div>
                                   </button>
                               ))}
                           </div>
                       </div>

                       {/* Elegant Footer */}
                       <footer className="text-center pb-12 pt-8 border-t border-white/5 bg-black">
                           <div className="flex justify-center gap-4 mb-6 opacity-40">
                               <BitcoinLogo size={24} />
                               <Gem size={24} />
                               <Landmark size={24} />
                           </div>
                           <p className="text-[10px] text-gray-600 uppercase tracking-[0.2em] font-bold">Jogue e Ganhe $ &copy; 2026</p>
                           <p className="text-[9px] text-gray-700 mt-1">Plataforma Certificada</p>
                           
                           <button onClick={() => { playSound('ui_click'); if(!user) { alert('Fa√ßa login para ver o hist√≥rico'); return; } setShowHistory(true); }} className="mt-6 px-6 py-2 border border-white/10 rounded-full text-[10px] text-gray-400 hover:text-white hover:border-white/30 transition uppercase tracking-wider bg-white/5">
                               Hist√≥rico de Saques
                           </button>
                       </footer>
                   </div>

                   {showHistory && <HistoryModal user={user} onClose={() => setShowHistory(false)} />}
              </div>
          );
      };

      // Helper Component for Bitcoin Logo
      const BitcoinLogo = ({size, className}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M11.767 19.089c4.924.868 6.14-6.025 1.216-5.71m0 0c-4.925.869-6.141-6.025-1.217-5.71m1.217 5.71l.946-5.71m-2.163 0l.946-5.71m-2.163 5.71h-2.163m4.326 5.71h-2.163m2.163 0h-2.163" />
        </svg>
      );
      
      const Landmark = ({size, className}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
           <line x1="3" y1="22" x2="21" y2="22" />
           <line x1="6" y1="18" x2="6" y2="11" />
           <line x1="10" y1="18" x2="10" y2="11" />
           <line x1="14" y1="18" x2="14" y2="11" />
           <line x1="18" y1="18" x2="18" y2="11" />
           <polygon points="12 2 20 7 4 7" />
        </svg>
      );

      const App = () => {
          const [screen, setScreen] = useState('hub'); // hub, galaxy, galaxy_shop, crypto, hangman, checkers, memory, rps
          const [coins, setCoins] = useState(() => parseInt(safeStorage.getItem('coins') || '100'));
          
          // Auth State
          const [user, setUser] = useState(null);
          const [showAuthModal, setShowAuthModal] = useState(false);

          useEffect(() => {
              if (!supabase) return;
              // Check active session on load
              supabase.auth.getSession().then(({ data: { session } }) => {
                  setUser(session?.user ?? null);
              });

              // Listen for changes
              const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                  setUser(session?.user ?? null);
              });

              return () => subscription.unsubscribe();
          }, []);

          const handleLogout = async () => {
               playSound('ui_click');
               if (supabase) await supabase.auth.signOut();
               setUser(null);
          };

          // --- GLOBAL DAILY MISSIONS STATE ---
          const [playTime, setPlayTime] = useState(() => {
              const today = new Date().toDateString();
              const savedDate = safeStorage.getItem('mission_date');
              if (savedDate !== today) {
                  // New day, reset time
                  safeStorage.setItem('mission_date', today);
                  safeStorage.setItem('daily_play_time', '0');
                  safeStorage.setItem('daily_rewards', JSON.stringify({ photo: false, video: false, super: false }));
                  return 0;
              }
              return parseInt(safeStorage.getItem('daily_play_time') || '0');
          });
          
          const [rewards, setRewards] = useState(() => {
               try { 
                  const stored = JSON.parse(safeStorage.getItem('daily_rewards') || '{}');
                  return { 
                      photo: stored.photo || false, 
                      video: stored.video || false, 
                      super: stored.super || false 
                  };
               } catch { return { photo: false, video: false, super: false }; }
          });
          
          const [showMissionModal, setShowMissionModal] = useState(false);
          const [showCongratsModal, setShowCongratsModal] = useState(null); // 'photo' | 'video' | 'super'
          
          // --- MANUAL WITHDRAWAL STATE ---
          const [showWithdrawModal, setShowWithdrawModal] = useState(false);
          const [showAdminLogin, setShowAdminLogin] = useState(false);
          const [showAdminPanel, setShowAdminPanel] = useState(false);

          // --- IDLE DETECTION ---
          const lastActivityRef = useRef(Date.now());
          useEffect(() => {
              const updateActivity = () => { lastActivityRef.current = Date.now(); };
              const events = ['mousedown', 'mousemove', 'keydown', 'touchstart', 'touchmove', 'click'];
              events.forEach(e => window.addEventListener(e, updateActivity));
              return () => events.forEach(e => window.removeEventListener(e, updateActivity));
          }, []);

          // --- TIMER LOGIC ---
          useEffect(() => {
              if (screen === 'hub') return; // Don't count time in menu
              
              const interval = setInterval(() => {
                  // IDLE CHECK: If no activity for 10 seconds, stop counting
                  if (Date.now() - lastActivityRef.current > 10000) return;

                  setPlayTime(prev => {
                      const newTime = prev + 1;
                      
                      // Save occasionally to avoid spamming storage
                      if (newTime % 5 === 0) {
                          safeStorage.setItem('daily_play_time', newTime.toString());
                      }
                      
                      // Check for unlocks
                      const TIME_PHOTO = 1500; // 25m
                      const TIME_VIDEO = 2400; // 40m
                      const TIME_SUPER = 3600; // 60m (1h)
                      
                      if (newTime === TIME_PHOTO && !rewards.photo) {
                           const newRewards = { ...rewards, photo: true };
                           setRewards(newRewards);
                           safeStorage.setItem('daily_rewards', JSON.stringify(newRewards));
                           setShowCongratsModal('photo');
                           playSound('win');
                      }
                      
                      if (newTime === TIME_VIDEO && !rewards.video) {
                           const newRewards = { ...rewards, video: true };
                           setRewards(newRewards);
                           safeStorage.setItem('daily_rewards', JSON.stringify(newRewards));
                           setShowCongratsModal('video');
                           playSound('win');
                      }

                      if (newTime === TIME_SUPER && !rewards.super) {
                           const newRewards = { ...rewards, super: true };
                           setRewards(newRewards);
                           safeStorage.setItem('daily_rewards', JSON.stringify(newRewards));
                           setShowCongratsModal('super');
                           playSound('win');
                      }

                      return newTime;
                  });
              }, 1000);
              
              return () => clearInterval(interval);
          }, [screen, rewards]);


          // Galaxy State
          const [equippedShip, setEquippedShip] = useState(() => safeStorage.getItem('equipped_ship') || 'starter');
          const [unlockedShips, setUnlockedShips] = useState(() => JSON.parse(safeStorage.getItem('unlocked_ships') || '["starter"]'));
          const [shipAdProgress, setShipAdProgress] = useState(() => JSON.parse(safeStorage.getItem('ship_ad_progress') || '{}'));

          useEffect(() => { safeStorage.setItem('coins', coins.toString()); }, [coins]);
          useEffect(() => { safeStorage.setItem('equipped_ship', equippedShip); }, [equippedShip]);
          useEffect(() => { safeStorage.setItem('unlocked_ships', JSON.stringify(unlockedShips)); }, [unlockedShips]);
          useEffect(() => { safeStorage.setItem('ship_ad_progress', JSON.stringify(shipAdProgress)); }, [shipAdProgress]);

          const addCoins = (amount) => setCoins(c => Math.max(0, c + amount));

          const handleShipAdWatch = (shipId, cost) => {
               setShipAdProgress(prev => {
                   const current = prev[shipId] || 0;
                   if (current + 1 >= cost) {
                       setUnlockedShips(u => [...u, shipId]);
                       return { ...prev, [shipId]: cost };
                   }
                   return { ...prev, [shipId]: current + 1 };
               });
          };

          const handleWithdrawClick = () => {
              if (!user) {
                  playSound('lose');
                  alert("Voc√™ precisa estar logado para solicitar o saque. Fa√ßa login ou crie sua conta para continuar.");
                  setShowAuthModal(true);
                  return;
              }

              // Calculate balance to check if withdraw is possible
              // UPDATED VALUES
              const currentBalance = (rewards.photo ? 0.10 : 0) + (rewards.video ? 0.10 : 0) + (rewards.super ? 0.25 : 0);
              if (currentBalance <= 0) {
                  playSound('lose');
                  alert("Voc√™ n√£o possui saldo para sacar.");
                  return;
              }
              playSound('ui_click');
              setShowWithdrawModal(true);
          };

          const processWithdrawal = async (data) => {
              // Send email notification (Backup for Admin)
              const subject = encodeURIComponent("Solicita√ß√£o de Saque");
              const bodyText = `Solicita√ß√£o de Saque

Nome: ${data.name}
Chave PIX: ${data.pix_key} (${data.pix_type})
Valor: R$ ${data.amount.toFixed(2)}
Email: ${data.email}

Anexe aqui o print do painel da miss√£o mostrando a data, hora e a barra cheia.`;
              const body = encodeURIComponent(bodyText);
              
              window.location.href = `mailto:joguee.e.ganhe@gmail.com?subject=${subject}&body=${body}`;
              
              // Zerar saldo
              const newRewards = { photo: false, video: false, super: false };
              setRewards(newRewards);
              safeStorage.setItem('daily_rewards', JSON.stringify(newRewards));
              setShowWithdrawModal(false);
              playSound('win');
          };

          const handleAdminAccess = () => {
              setShowAdminLogin(true);
          };

          const renderScreen = () => {
              // Calculate cash balance from missions
              // UPDATED VALUES
              const cashBalance = (rewards.photo ? 0.10 : 0) + (rewards.video ? 0.10 : 0) + (rewards.super ? 0.25 : 0);

              switch(screen) {
                  case 'hub': return (
                    <MainHub 
                        onSelect={setScreen} 
                        coins={coins} 
                        cashBalance={cashBalance} 
                        onOpenMissions={() => setShowMissionModal(true)}
                        user={user}
                        onLoginClick={() => { playSound('ui_click'); setShowAuthModal(true); }}
                        onLogoutClick={handleLogout}
                        onWithdraw={handleWithdrawClick}
                        onAdminAccess={handleAdminAccess}
                    />
                  );
                  case 'galaxy': return <GalaxyMenu onStart={() => setScreen('galaxy_game')} onShop={() => setScreen('galaxy_shop')} onBack={() => setScreen('hub')} coins={coins} />;
                  case 'galaxy_game': return <GalaxyInvader onBack={() => setScreen('galaxy')} equippedShipId={equippedShip} addCoins={addCoins} currentCoins={coins} />;
                  case 'galaxy_shop': return <ShopScreen adProgress={shipAdProgress} handleShipAdWatch={handleShipAdWatch} equipShip={setEquippedShip} unlockedShips={unlockedShips} equippedShip={equippedShip} onBack={() => setScreen('galaxy')} />;
                  case 'crypto': return <CryptoFarmGame onBack={() => setScreen('hub')} addCoins={addCoins} coins={coins} />;
                  case 'flappy': return <FlappyCoinGame onBack={() => setScreen('hub')} addCoins={addCoins} />;
                  case 'hangman': return <HangmanGame onBack={() => setScreen('hub')} addCoins={addCoins} />;
                  case 'checkers': return <CheckersGame onBack={() => setScreen('hub')} />;
                  case 'memory': return <MemoryGame onBack={() => setScreen('hub')} addCoins={addCoins} />;
                  case 'rps': return <RockPaperScissorsGame onBack={() => setScreen('hub')} addCoins={addCoins} />;
                  case 'uno': return <UnoGame onBack={() => setScreen('hub')} addCoins={addCoins} />;
                  default: return <MainHub onSelect={setScreen} coins={coins} cashBalance={cashBalance} onOpenMissions={() => setShowMissionModal(true)} />;
              }
          };

          // Helper to get current balance for modal prop
          // UPDATED VALUES
          const currentBalance = (rewards.photo ? 0.10 : 0) + (rewards.video ? 0.10 : 0) + (rewards.super ? 0.25 : 0);

          return (
              <>
                  <InstallButton />
                  {renderScreen()}
                  {showMissionModal && <MissionModal playTime={playTime} rewards={rewards} onClose={() => setShowMissionModal(false)} />}
                  {showAuthModal && <AuthModal onClose={() => setShowAuthModal(false)} onLogin={() => {}} />}
                  
                  {/* WITHDRAWAL MODAL */}
                  {showWithdrawModal && (
                      <WithdrawModal 
                          balance={currentBalance}
                          onClose={() => setShowWithdrawModal(false)}
                          onConfirm={processWithdrawal}
                          user={user}
                      />
                  )}

                  {/* ADMIN MODALS */}
                  {showAdminLogin && (
                      <AdminLoginModal 
                          onClose={() => setShowAdminLogin(false)}
                          onSuccess={() => { setShowAdminLogin(false); setShowAdminPanel(true); }}
                      />
                  )}
                  
                  {showAdminPanel && (
                      <AdminPanel onClose={() => setShowAdminPanel(false)} />
                  )}

                  {/* CONGRATS POPUP */}
                  {showCongratsModal && (
                      <div className="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-4 animate-fade-in" onClick={() => setShowCongratsModal(null)}>
                          <div className="bg-gradient-to-br from-yellow-600 to-yellow-800 p-1 rounded-2xl shadow-[0_0_50px_gold]">
                              <div className="bg-black rounded-xl p-8 text-center max-w-sm">
                                  <Trophy size={64} className="text-yellow-400 mx-auto mb-4 animate-bounce" />
                                  <h2 className="text-3xl font-bold text-white mb-2 hero-title">PARAB√âNS!</h2>
                                  <p className="text-gray-300 mb-6">
                                      Voc√™ desbloqueou {showCongratsModal === 'photo' ? 'R$ 0,10' : showCongratsModal === 'video' ? 'R$ 0,10' : 'R$ 0,25'} no PIX!
                                  </p>
                                  <button onClick={() => { setShowCongratsModal(null); setShowMissionModal(true); }} className="w-full py-3 bg-yellow-500 hover:bg-yellow-400 text-black font-bold rounded-lg uppercase tracking-wider">
                                      RESGATAR RECOMPENSA
                                  </button>
                              </div>
                          </div>
                      </div>
                  )}
              </>
          );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>